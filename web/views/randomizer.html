{{
extend 'layout.html'
}}

<meta name="description" content="Solver for the randomized Super Metroid roms"/>
<link rel="shortcut icon" href={{=URL('static','favicon.ico')}} type="image/ico"/>
<script src="{{=URL('static','js/FileSaver.js')}}"></script>
<link rel="stylesheet" type="text/css" href={{=URL('static','css/mystyle_20191017.css')}} media="screen"/>

<link rel="stylesheet" type="text/css" href={{=URL('static','dist/switchery.css')}} media="screen"/>
<script src="{{=URL('static','dist/switchery.js')}}"></script>

<link href={{=URL('static', 'css/bootstrap-tour.min.css')}} rel="stylesheet">
<script src="{{=URL('static','js/bootstrap-tour.min.js')}}"></script>

<script type="text/javascript" src="{{=URL('static', '/highslide/highslide.js')}}"></script>
<link rel="stylesheet" type="text/css" href={{=URL("static", "/highslide/highslide.css")}} />
<script type="text/javascript">
hs.graphicsDir = "/solver/static/highslide/graphics/";
hs.showCredits = 0;
hs.zIndexCounter = 1000000;
hs.dimmingOpacity = 0.75;

if (hs.registerOverlay) {
	// The simple semitransparent close button overlay
	hs.registerOverlay({
		thumbnailId: 'areathumb',
		html: '<div class="closebutton"	onclick="return hs.close(this)" title="Close"></div>',
		position: 'top right',
		fade: 2 // fading the semi-transparent overlay looks bad in IE
	});
}
</script>

<script type="text/javascript" src="{{=URL('static', 'js/chosen.jquery.min.js')}}"></script>
<link rel="stylesheet" type="text/css" href={{=URL("static", "css/chosen.css")}} />

<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

<script type="text/javascript" src="{{=URL('static', 'js/jquery.redirect.js')}}"></script>

<script type="text/javascript" src="{{=URL('static', 'js/crc32.js')}}"></script>

<title>Super Metroid VARIA Randomizer</title>

<style>
.customizerText {
    width: 40%;
    margin-left: 30%;
    margin-right: 30%;
    margin-top: 1em;
    margin-bottom: 0em;
    text-align: center;
}
.rightStep {
    float: right;
    margin-right: 0.3em;
}
.top {
    vertical-align: top;
}
.parent-center {
    text-align: center;
}
.child-center {
    margin: auto;
}
.popover {
    max-width: 40%;
}
.highslide-dimming {
    background: black;
}
#overlay {
    position: fixed; /* Sit on top of the page content */
    display: none; /* Hidden by default */
    width: 100%; /* Full width (cover the whole page) */
    height: 100%; /* Full height (cover the whole page) */
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0,0,0,0.5); /* Black background with opacity */
    z-index: 2; /* Specify a stack order in case you're using a different order for other elements */
    cursor: pointer; /* Add a pointer on hover */
}
#loadingGIF {
    position: absolute;
    left: 5%;
    z-index: 3;
    display:none;
}
@media (max-height: 800px) {
    .loadingGIF {
         top: 20%;
    }
}
@media (min-height: 800px) {
    .loadingGIF {
         top: 40%;
    }
}
.loadingTips {
    position: fixed;
    left: 50%;
    bottom: 10%;
    z-index: 99;
    display:none;
    border-radius: 2em;
    background-color: #ffffff;
    height: auto;
    padding: 0.5%;
    border: 2px solid #666666;
}
#psMultiselectDiv {
    display: none;
}
.sixty {
    width: 65%
}
.thirty {
    width: 30%
}
.floatright {
    float: right;
    vertical-align: top;
    margin-top: -0.3em;
}
.floatleft {
    float: left;
    vertical-align: top;
}
#slider-container {
  width: 80%;
  height: 80px;
  box-sizing: border-box;
  position: relative;
  top: 50%;
  margin: 0 auto;
  text-align: center;
  background: #FFF;
  padding: 35px 40px 30px 40px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

.ui-slider, .ui-slider .slider-range-inverse, .ui-slider .ui-slider-range {
  height: 14px;
  border-radius: 0px;
  border-width: 0;
}
.ui-slider {
  background-color: #1ABC9C;
  background-image: linear-gradient(to right, #0000e8 0%, #e80074 25%, #e8e800 50%, #00e874 75%, #0000e8 100%);
}
.ui-slider * {
  outline: none;
}
.ui-slider .slider-range-inverse0 {
  background: #CCC;
  position: absolute;
  left: 0;
  height: 12px;
}
.ui-slider .slider-range-inverse1 {
  background: #CCC;
  position: absolute;
  right: 0;
  height: 12px;
}
.ui-slider .ui-slider-range {
  background: transparent;
}
.ui-slider .ui-slider-handle {
  width: 6px;
  height: 20px;
  cursor: pointer;
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
  background: #FFF;
  top: -4px;
  border-width: 0;
  margin-left: -3px;
}
.ui-slider .ui-slider-handle:active {
  box-shadow: 0 3px 20px rgba(0, 0, 0, 0.5);
}
.ui-slider .ui-slider-handle .dot {
  width: 4px;
  height: 18px;
  position: absolute;
  top: 1px;
  left: 1px;
  background: transparent;
  overflow: hidden;
}
.ui-slider .ui-slider-handle .dot .handle-track0 {
  display: block;
  height: 18px;
  background-color: #1ABC9C;
  background-image: linear-gradient(to right, #0000e8 0%, #e80074 25%, #e8e800 50%, #00e874 75%, #0000e8 100%);
  position: absolute;
  margin-left: 0px;
}
.ui-slider .ui-slider-handle .dot .handle-track1 {
  display: block;
  height: 18px;
  background-color: #1ABC9C;
  background-image: linear-gradient(to right, #0000e8 0%, #e80074 25%, #e8e800 50%, #00e874 75%, #0000e8 100%);
  position: absolute;
  margin-left: 8px;
}

.sixty {
    width: 65%
}
.thirty {
    width: 30%
}
.floatright {
    float: right;
    /* vertical-align: top; */
    margin-top: -1em;
}
.floatleft {
    float: left;
    /* vertical-align: top; */
    margin-right: 0.5em;
}
</style>

<script type="text/javascript">
// https://stackoverflow.com/questions/16960690/chosen-harvesthq-resize-width-dynamically
$(document).ready(function(){      
   jQuery(window).on('resize', resizeChosen);
});

function resizeChosen() {
   $(".chosen-container").each(function() {
       $(this).attr('style', 'width: 100%');
   });          
}

function randomize(evt, elemId) {
  var e = document.getElementById(elemId);

  var isActive;
  if(evt.currentTarget.className.search("active") != -1) {
    evt.currentTarget.className = evt.currentTarget.className.replace(" active", "");
    isActive = false;

    defaultValues = {"missileQty": 3, "superQty": 2, "powerBombQty": 1, "minorQty": 100};

    if(e.value.length == 0 && elemId in defaultValues) {
      e.value = defaultValues[elemId];
    }

  } else {
    evt.currentTarget.className += " active";
    isActive = true;
  }

  e.disabled = isActive;
  // grey out the disabled text
  var text = document.getElementById(elemId+"Text");
  if(e.disabled) {
      text.className = "disabledText";
  } else {
      text.className = "";
  }
  // tell switchery
  if(elemId in globalSwitchs){
    var s = globalSwitchs[elemId];
    if(isActive){
      s.disable();
    } else {
      s.enable();
    }
  }

  // special case for prog speed
  if(elemId == "progressionSpeed") {
    if(isActive == true) {
      document.getElementById("progressionSpeed").style.display = "none";
      document.getElementById("psMultiselectDiv").style.display = "block";
      // chosen must be activated when it's visible, else it doesn't work...
      $("#psMultiselect").chosen();
    } else {
      document.getElementById("progressionSpeed").style.display = "block";
      document.getElementById("psMultiselectDiv").style.display = "none";
    }
  }
}

function getComplexity() {
  tablinks = document.getElementsByClassName("tablinks");
  for (i = 0; i < tablinks.length; i++) {
    if(tablinks[i].className.includes("active")) {
      return tablinks[i].id;
    }
  }
}

function setRandom() {
{{
  for id in ["missileQty", "superQty", "powerBombQty", "minorQty", "energyQty", "maxDifficulty", "majorsSplit", "suitsRestriction", "morphPlacement", "funCombat", "funMovement", "funSuits", "progressionDifficulty", "hideItems", "strictMinors", "progressionSpeed"]:
    if id in session.randomizer and session.randomizer[id] == "random":
      response.write("  document.getElementById(\"{}Random\").click();\n".format(id), escape=False)
      pass
    pass
  if "progressionSpeed" in session.randomizer and type(session.randomizer["progressionSpeed"]) == list and len(session.randomizer["progressionSpeed"]) > 1:
    # python2: prog speed are in utf-8 after loading from json and displayed in js like [u'slowest', u'slow']
    response.write("  $(\"#psMultiselect\").val({});\n".format([str(ps) for ps in session.randomizer["progressionSpeed"]]), escape=False)
    response.write("  document.getElementById(\"progressionSpeedRandom\").click();\n", escape=False)
    pass
}}
}

function setComplexity() {
{{
  if "complexity" in session.randomizer:
    response.write('  document.getElementById("{}").click();'.format(session.randomizer["complexity"]), escape=False)
  else:
    response.write('  document.getElementById("simple").click();', escape=False)
    pass
}}
}

function changeComplexity(evt, name) {
  if(name == "simple") {
    var show = [];
    var hide = ["seedVisibility", "ammoVisibility", "maxDiffVisibility", "progDiffVisibility", "suitsRestrictionVisibility", "morphPlacementVisibility", "superFunVisibility", "patchesVisibility", "areaPatchVisibility", "hideItemsVisibility", "raceModeVisibility"];
    showHide(show, hide);
  }

  else if(name == "medium") {
    var show = ["maxDiffVisibility", "patchesVisibility", "morphPlacementVisibility", "ammoVisibility", "nerfedChargeVisibility", "noMusicVisibility"];
    var hide = ["seedVisibility", "progDiffVisibility", "suitsRestrictionVisibility", "strictMinorsVisibility", "missileQtyVisibility", "superQtyVisibility", "powerBombQtyVisibility", "superFunVisibility", "areaPatchVisibility", "mainPatchesVisibility", "mainPatchesTextVisibility", "hideItemsVisibility", "raceModeVisibility", "miscVisibility"];
    showHide(show, hide);
  }

  else {
    var show = ["seedVisibility", "ammoVisibility", "maxDiffVisibility", "progDiffVisibility", "suitsRestrictionVisibility", "morphPlacementVisibility", "strictMinorsVisibility", "missileQtyVisibility", "superQtyVisibility", "powerBombQtyVisibility", "superFunVisibility", "patchesVisibility", "areaPatchVisibility", "mainPatchesVisibility", "mainPatchesTextVisibility", "hideItemsVisibility", "raceModeVisibility", "nerfedChargeVisibility", "miscVisibility", "noMusicVisibility"];
    var hide = [];
    showHide(show, hide);
  }

  // set current button to active
  tablinks = document.getElementsByClassName("tablinks");
  for (i = 0; i < tablinks.length; i++) {
      tablinks[i].className = tablinks[i].className.replace(" active", "");
  }

  evt.currentTarget.className += " active";
}

function showHide(show, hide) {
  for(var i=0; i<show.length; i++) {
    var showId = show[i];
    var elem = document.getElementById(showId);
    elem.classList.remove("hidden");
  }
  for(var i=0; i<hide.length; i++) {
    var hideId = hide[i];
    var elem = document.getElementById(hideId);
    elem.classList.add("hidden");
  }
}

var globalSwitchs = {};

function AjaxPresetCallCompleted(data) {
    console.log("AjaxPresetCallCompleted");

    var dataDict = {paramsFileTarget : data, "complexity": getComplexity()};
    var elems = ["seed", "preset", "raceMode", "areaRandomization", "areaLayout", "bossRandomization", "layoutPatches", "variaTweaks", "gravityBehaviour", "nerfedCharge", "itemsounds", "elevators_doors_speed", "spinjumprestart", "rando_speed", "startLocation", "animals", "No_Music"];
    var randomElems = ["missileQty", "superQty", "powerBombQty", "minorQty", "energyQty", "maxDifficulty", "majorsSplit", "suitsRestriction", "morphPlacement", "funCombat", "funMovement", "funSuits", "progressionDifficulty", "hideItems", "strictMinors"];

    for(var i=0; i<elems.length; i++) {
       dataDict[elems[i]] = document.getElementById(elems[i]).value;
    }
    for(var i=0; i<randomElems.length; i++) {
       // check if random dice is checked
       if(document.getElementById(randomElems[i]+"Random").className.search("active") != -1) {
         dataDict[randomElems[i]] = "random";
       } else {
         dataDict[randomElems[i]] = document.getElementById(randomElems[i]).value;
       }
    }

    dataDict["progressionSpeed"] = getProgSpeed();

    // call web service with parameters
    var request = $.ajax({
      url: "{{=URL(f='randomizerWebService')}}",
      method: "POST",
      data: dataDict,
      dataType: "json",
      crossDomain: true
    });

    request.done(AjaxRandomizerCallCompleted);
    request.fail(ajaxFailJSON);
}

function ajaxFail(jqXHR, textStatus) {
  document.getElementById("flash").innerHTML = jqXHR.responseText;
  $('#flash').show();
  $('#overlay').hide();
  $('#loadingGIF').hide();
  cancelTip();
}

function ajaxFailJSON(jqXHR, textStatus) {
  // cross domain calls currently return 'undefined' information... (cf. https://www.html5rocks.com/en/tutorials/cors/)
  if(jqXHR.responseJSON == null) {
    document.getElementById("flash").innerHTML = "Something wrong happened or the VARIA randomizer aborted: please try again. If this happens again after retrying, raise or disable max difficulty setting, and/or disable Super Fun Times (TM) setting. If Area Randomization was selected, try to enable Full Randomization as well.";
  } else {
    document.getElementById("flash").innerHTML = jqXHR.responseJSON;
  }
  $('#flash').show();
  $('#overlay').hide();
  $('#loadingGIF').hide();
  cancelTip();
}

function getProgSpeed() {
  // multi select value for random prog speed
  console.log("psMultiselect value: "+$("#psMultiselect").val());
  if(document.getElementById("progressionSpeedRandom").className.search("active") != -1) {
    return $("#psMultiselect").val().join();
  } else {
    return document.getElementById("progressionSpeed").value;
  }
}

function unpack_3bytes(ips, i) {
  var b1 = ips[i];
  var b2 = ips[i+1];
  var b3 = ips[i+2];
  return (b1*65536) + (b2*256) + b3;
}

function unpack_2bytes(ips, i) {
  var b1 = ips[i];
  var b2 = ips[i+1];
  return (b1*256) + b2;
}

function AjaxRandomizerCallCompleted(data) {
    console.log("AjaxRandomizerCallCompleted");

    // with items/Locations patch the local rom in memory
    var filesInput = document.getElementById("uploadFile");
    var file = filesInput.files[0];

    var reader = new FileReader();
    reader.readAsArrayBuffer(file);

    reader.onload = function(e) {
        var bytes = new Uint8Array(e.target.result);

        if("ips" in data) {
          var binary_string = atob(data["ips"]);
          var len = binary_string.length;
          var ips = new Uint8Array(len);
          for(var i = 0; i < len; i++) {
             ips[i] = binary_string.charCodeAt(i);
          }

          console.log("IPS size: "+ips.length);
          var i = 5;
          var offset = 0;
          var size = 0;
          var rle_size = 0;

          while(i < ips.length - 3) {
             offset = unpack_3bytes(ips, i);
             i += 3;
             size = unpack_2bytes(ips, i);
             i += 2;

             if(size == 0) {
               // RLE
               rle_size = unpack_2bytes(ips, i);
               i += 2;
               for(j=0; j<rle_size; j++) {
                 bytes[offset+j] = ips[i];
               }
               i += 1;
             } else {
               for(j=0; j<size; j++) {
                 bytes[offset+j] = ips[i+j];
               }
               i += j;
             }
          }
        }

        for(var key in data) {
            if(key === "fileName" || key === "errorMsg" || key === "ips" || key === "max_size" || key == "truncate_length") { continue; }
            bytes[key] = data[key];
        }

        var blob = new Blob([bytes], {type: "octet/stream"});

        var outFileName = data['fileName'];
        saveAs(blob, outFileName);
    }

    // info message to display ?
    if("errorMsg" in data && data["errorMsg"].length > 0) {
        document.getElementById("flash").innerHTML = data["errorMsg"];
        $('#flash').show();
        displayFlash = true;
    } else {
        displayFlash = false;
    }

    // set backup button text to Randomize
    document.getElementById("submitBtn").data = "Randomize";
    console.log("button text set back to randomize");

    var dataDict = {"complexity": getComplexity()};
    var elems = ["seed", "preset", "raceMode", "areaRandomization", "areaLayout", "bossRandomization", "layoutPatches", "variaTweaks", "gravityBehaviour", "nerfedCharge", "itemsounds", "elevators_doors_speed", "spinjumprestart", "rando_speed", "startLocation", "animals", "No_Music", "randoPreset"];
    var randomElems = ["missileQty", "superQty", "powerBombQty", "minorQty", "energyQty", "maxDifficulty", "majorsSplit", "suitsRestriction", "morphPlacement", "funCombat", "funMovement", "funSuits", "progressionDifficulty", "hideItems", "strictMinors"];

    for(var i=0; i<elems.length; i++) {
       dataDict[elems[i]] = document.getElementById(elems[i]).value;
    }
    for(var i=0; i<randomElems.length; i++) {
       // check if random dice is checked
       if(document.getElementById(randomElems[i]+"Random").className.search("active") != -1) {
         dataDict[randomElems[i]] = "random";
       } else {
         dataDict[randomElems[i]] = document.getElementById(randomElems[i]).value;
       }
    }

    dataDict["progressionSpeed"] = getProgSpeed();

    // call webservice to update the session
    var request = $.ajax({
      url: "{{=URL(f='sessionWebService')}}",
      method: "POST",
      data: dataDict,
      dataType: "html"
    });

    request.fail(ajaxFail);

    // remove "working" message
    if(displayFlash == false){
        $('#flash').hide();
    }
    $('#overlay').hide();
    $('#loadingGIF').hide();
    cancelTip();
}

function doSubmit() {
  if(window.File && window.FileList && window.FileReader) {

    var filesInput = document.getElementById("uploadFile");
    var file = filesInput.files[0]
    if (file === undefined) {
      alert("Please select a Super Metroid Vanilla ROM first")
      btn = document.getElementById("submitBtn");
      btn.data = "Randomize";
      btn.disabled = false;

      setTimeout(function(){ 
          btn = document.getElementById("submitBtn");
          btn.data = "Randomize";
          btn.disabled = false;
      }, 20000);

      return false;
    }

    var dataDict = {"preset": document.getElementById("preset").value};

    console.log("before preset web service call"+dataDict["preset"]);

    // call preset web service with parameters
    var request = $.ajax({
      url: "{{=URL(f='presetWebService')}}",
      method: "POST",
      data: dataDict,
      dataType: "html"
    });

    request.done(AjaxPresetCallCompleted);
    request.fail(ajaxFail);

    // while WS is working, display "working" message
    $('#overlay').show();
    $('#loadingGIF').show();
    loadTip();
  }

  return false;
}

function getRndInteger(max) {
  return Math.floor(Math.random() * max );
}

var tips = [
    "You can display the logic details for a skill preset by loading it on the Presets page",
    "With VARIA tweaks on (default) you can activate Lower Norfair Chozo (left of entrance) without Space Jump",
    "With VARIA tweaks on (default) you can access item at Wrecked Ship Etank location without killing Phantoon (via Forgotten Highway)",
    "By default Gravity Suit environmental protection (heat, spikes, electricity...) is removed, it balances more the two suits abilities",
    "Creating your own skills preset will lead to a better experience overall, as the generated ROMs will be tailored for you",
    "The skills preset is used by the Randomizer, Solver, Tracker and Plandomizer to know which techniques are available to reach the item locations",
    "Majors split Chozo: Put all the upgrades as well as minimal ammo/energy to finish the seed in the Chozo locations",
    "Majors split Full: All items are shuffled in all locations",
    "Majors split Majors/Minors: Use major (upgrades and energy) and minor (ammo) item pools",
    "Majors split Majors/Minors: High-Jump boots Energy Tank location is considered minor, and right Super Missile in Wrecked ship is considered major for balancing purposes",
    "Progression speed setting will have a big impact on seed difficulty. The slower the speed is, the harder the seed will be (usually)",
    "VARIAble progression speed will randomly change internal progression speed while placing items, creating seeds that are more unpredictable",
    "Progression difficulty setting will have a moderate impact on seed difficulty compared to progression speed",
    "Late Morph is best suited when used along area randomization, to find Morph in peculiar places",
    "The Tracker can be use in seedless mode, aka I use my tablet on my couch. Just click 'Init' without picking a seed file",
    "If you're stuck while playing a seed, use the Solver or the Tracker to know where to go next",
    "By default all seeds are MSU-1 compatible",
    "Anti soft-lock layout modification are applied by default",
    "You can use the tracker to track the connections between the areas and avoid getting too lost in area rando",
    "With Boss randomization, the areas or rooms unlocked by the bosses stay unchanged. For example, you still have to kill Phantoon to activate Wrecked Ship.",
    "The aim buttons can be assigned to any button",
    "You can save your own button layout as well as moonwalk option in your skills preset to avoid doing the setup every seed"
];

var myTimer = null;
var curLoadingTips = 0;

function loadTip(first = true) {
    if(first == true) {
      curLoadingTips = 0;
    } else {
      // first fadeout the current one
      var elem = "loadingTips" + curLoadingTips;
      $("#"+elem).fadeOut(1000);
      curLoadingTips = 1 - curLoadingTips;
    }

    var tip = tips[getRndInteger(tips.length)];
    var elem = "loadingTips" + curLoadingTips;
    document.getElementById(elem).innerHTML = tip;
    document.getElementById(elem).style.marginLeft = "-" + tip.length/4 + "em";
    $("#"+elem).fadeIn(1000);
    myTimer = setTimeout(loadTip, 5000, false);
}

function cancelTip() {
  if(myTimer != null) {
    clearTimeout(myTimer);
    myTimer = null;
  }
  $("#loadingTips"+curLoadingTips).fadeOut(3000);
  curLoadingTips = 1 - curLoadingTips;
  $("#loadingTips"+curLoadingTips).hide();
}

window.onload = function(){
    //Check File API support
    if(window.File && window.FileList && window.FileReader) {
        var filesInput = document.getElementById("uploadFile");
        filesInput.addEventListener("change", function(event){
            var files = event.target.files; //It returns a FileList object
            var file = files[0];

            var crc32 = new Crc32();

            var reader = new FileReader();
            reader.readAsArrayBuffer(file)
            reader.onload = function(e) {
		// check sfc or smc extention
                var re = /(?:\.([^.]+))?$/;
		var ext = re.exec(file.name)[1];
                console.log("ext: "+ext)
                if( ! (ext === "sfc" || ext === "smc") ) {
                    document.getElementById("uploadFile").value = "";
                    alert("wrong extension: "+ext);
                    return false;
                }

                var fileSize = file.size;
		if( fileSize > 4*1024*1024 ) {
                    document.getElementById("uploadFile").value = "";
                    alert("wrong ROM file size: "+fileSize.toString());
                    return false;
                } else if( fileSize == 3146240) {
                    document.getElementById("uploadFile").value = "";
                    alert("headered ROM detected, please use an unheadered ROM");
                    return false;
                }

                crc32.update(e.target.result);
                var digest = crc32.digest();
                console.log("crc32: "+digest);
                if(digest != "d63ed5f8") {
                    alert("Non vanilla ROM detected, use at your own risk!");
                }
            }
        }, false);
    } else {
        alert("This website requires the HTML5 File API, please upgrade your browser to a newer version.");
    }

    var area = document.getElementById("areaRandomization");
    area.onchange = function(){
        var area = document.getElementById("areaRandomization");
        var patches = document.getElementById("areaLayout");
        var lateMorph = document.getElementById("morphPlacement");
        var suits = document.getElementById("suitsRestriction");

        if(area.checked){
            if(! patches.checked){
                patches.click();
            }
            // uncheck suits restrictions when late morph + area
            if(lateMorph.options[lateMorph.selectedIndex].text == "late"){
                if(suits.checked){
                    suits.click();
                }
            }
        } else {
            if(patches.checked){
                patches.click();
            }
        }
        switchCheckbox("areaRandomization");
    };

    // uncheck suits restrictions when late morph + area
    var lateMorph = document.getElementById("morphPlacement");
    lateMorph.onchange = function(){
        var lateMorph = document.getElementById("morphPlacement");
        var area = document.getElementById("areaRandomization");
        var suits = document.getElementById("suitsRestriction");

        if(lateMorph.options[lateMorph.selectedIndex].text == "late"){
            if(area.checked){
                if(suits.checked){
                    suits.click();
                }
            }
        }
    }

    var progSpeed = document.getElementById("progressionSpeed");
    progSpeed.onchange = function(){
        var progSpeed = document.getElementById("progressionSpeed");
        if(progSpeed.value == 'slow' || progSpeed.value == 'slowest'){
            // set suits restriction only if not area + late morph
            var suitsRestriction = document.getElementById("suitsRestriction");
            var lateMorph = document.getElementById("morphPlacement");
            var area = document.getElementById("areaRandomization");
            if(! suitsRestriction.checked && ! (area.checked && lateMorph.options[lateMorph.selectedIndex].text == "late")){
                suitsRestriction.click();
            }
        }
        if(progSpeed.value == 'fast' || progSpeed.value == 'fastest'){
            var suitsRestriction = document.getElementById("suitsRestriction");

            if(suitsRestriction.checked){
                suitsRestriction.click();
            }
        }
    }

    // race mode is disabled by default
    var text = document.getElementById("raceModeText");
    text.className = "disabledText";

    var raceMode = document.getElementById("raceMode");
    raceMode.onchange = function() {
      var raceMode = document.getElementById("raceMode");
      var text = document.getElementById("raceModeText");
      if(raceMode.checked){
        text.className = "";
      } else {
        text.className = "disabledText";
      }
      switchCheckbox("raceMode");
    }

    var inputs = document.getElementsByTagName("input");
    for(var i = 0; i < inputs.length; i++) {
        if(inputs[i].type == "checkbox") {
            // progression speed checkboxes don't need switchery, so they don't have a name property
            if(inputs[i].name != "") {
              var s = new Switchery(document.getElementById(inputs[i].name), { size: 'small', color: '#ddd' });
              globalSwitchs[inputs[i].name] = s;
            }
        }
    }

    setComplexity();

    setRandom();

    $("#preset").chosen();
    $("#randoPreset").chosen();
    resizeChosen();
}

function switchCheckbox(id, elems=[]) {
  var check = document.getElementById(id);
  if(check.checked){
    check.value = "on";
  } else {
    check.value = "off";
  }

  for(var i=0; i<elems.length; i++){
    elemId = elems[i];
    var e = document.getElementById(elemId);
    e.disabled = check.checked;
    // grey out the disabled text
    var text = document.getElementById(elems[i]+"Text");
    if(e.disabled) {
        text.className = "disabledText";
    } else {
        text.className = "";
    }
    // tell switchery
    if(elemId in globalSwitchs){
      var s = globalSwitchs[elemId];
      if(check.checked){
        s.disable();
      } else {
        s.enable();
      }
    }
  }
}

function loadRandoPreset() {
  console.log("loadRandoPreset: "+document.getElementById("randoPreset").value);

  var dataDict = {"randoPreset": document.getElementById("randoPreset").value, "origin": "randomizer"};

  // call web service to update the session with the params from the rando preset and reload the page
  var request = $.ajax({
      url: "{{=URL(f='randoPresetWebService')}}",
      method: "POST",
      data: dataDict,
      dataType: "json"
  });

  request.done(loadRandoPresetOK);
  request.fail(ajaxFail);
}

function loadRandoPresetOK(data) {
  // instead of reloading the page which remove the sm ROM, update all fields manually
  for(var key in data) {
    value = data[key];
    var elem = document.getElementById(key);

    var elemRandom = document.getElementById(key+"Random");
    if(value == "random") {
      if(key == "progressionSpeed") {
        $("#psMultiselect").val(["slowest", "slow", "medium", "fast", "fastest", "basic", "VARIAble"]).trigger("chosen:updated");
        document.getElementById("progressionSpeedRandom").click();
      }

      // if not already set as random, set it
      if(elemRandom.className.search("active") == -1) {
        randomize({currentTarget: elemRandom}, key);
      }
    } else {
      // check if it was random before
      if(elemRandom != null && elemRandom.className.search("active") != -1) {
        randomize({currentTarget: elemRandom}, key);
      }

      // tell switchery for checkboxes
      if(key in globalSwitchs) {
        if(value != elem.value){
          elem.click();
        }
      }

      // update element value
      if(key == "progressionSpeed") {
        if(typeof value == "string") {
          // one value
          elem.value = value;
        } else {
          // multiple values
          $("#psMultiselect").val(value).trigger("chosen:updated");
          document.getElementById("progressionSpeedRandom").click();
        }
      } else if(key == "preset") {
        elem.value = value;
        $("#preset").val(value).trigger("chosen:updated");
      } else {
        elem.value = value;
      }
    }
  }
}

function startTheTour(step=-1) {
  // the tour tutorial
  var tour = new Tour({
    storage: false,
    autoscroll: false,
    steps: [
    {
      element: "#romStep",
      title: "Vanilla Super Metroid ROM",
      content: "Use an American/Japan unheadered ROM of Super Metroid.<br/>The randomized ROM is generated locally."
    },
    {
      element: "#seedStep",
      title: "Randomizer seed",
      content: "Choose a seed number between 1 and 9999999, choose 0 to generate a random one."
    },
    {
      element: "#presetStep",
      title: "Skills Preset",
      content: "<p>The preset is used by the Randomizer to know which techniques are available to reach the items locations.</p><p>You can check which techniques are required as well as create and manage your own preset on the <a href=\"/solver/solver_web/presets\" target=\"_blank\">Presets part of the website</a>.</p><p>Load one of the standard presets (sorted in increased difficulty), tournament presets, or your own from the community presets.</p><p>Creating your own preset will lead to a better experience overall, as the generated ROMs will be tailored for you.</p>"
    },
    {
      element: "#randoPresetStep",
      title: "Settings Preset",
      content: "Choose from a list of typical Randomizer usages. They're independent from skills preset, and settings can still be changed after loading the preset:<ul>\
<li>all_random: all the parameters are set to random</li>\
<li>default: VARIA randomizer default settings</li>\
<li>free: easiest possible settings</li>\
<li>hardway2well: harder highway2hell</li>\
<li>highway2hell: favors suitless seeds</li>\
<li>quite_random: randomizes a few significant settings to have various seeds</li>\
<li>stupid_hard: hardest possible settings</li>\
<li>vanilla: closest possible to vanilla Super Metroid</li>\
<li>way_of_chozo: chozo split with boss randomization</li>\
<li>where_is_morph: Area mode with late Morph</li></ul>\
Tournament presets:<ul>\
<li>Scavenger_Hunt: SM Scavenger Hunt Tournament</li>\
<li>Season_Races: settings used for rando league races (Majors/Minors split)</li>\
<li>Season_Races_Chozo: settings used for rando league races (Chozo split)</li>\
<li>Playoff_Races: settings used for rando league races during playoff (Majors/Minors split)</li>\
<li>Playoff_Races_Chozo: settings used for rando league races during playoff (Chozo split)</li>\
<li>smrat: Super Metroid Randomizer Accessible Tournament 2019</li></ul>"
    },
    {
      element: "#raceStep",
      title: "Race",
      content: "<p>When enabled, makes it difficult to cheat by using a Super Metroid editor like SMILE.</p>\
<p>You won't be able to solve/track a race protected seed on the VARIA website.</p>"
    },
    {
      element: "#majorsSplitStep",
      title: "Majors Split",
      content: "<p>Chooze how you want to split the Majors and the Minors items:<ul><li>Full: All items are shuffled in all locations</li><li>Majors/Minors: Use major (upgrades and energy) and minor (ammo) item pools.</p><p><b>Note:</b> High-Jump boots Energy Tank location is considered minor, and right Super Missile in Wrecked ship is considered major for balancing purposes.</li><li>Chozo: Put all the upgrades as well as minimal ammo/energy to finish the seed in the Chozo locations. Theses are the Chozo statues, Morph Ball and boss item locations (Right Super in Wrecked Ship, Varia Suit, Ridley ETank). Depending on progresson speed and item distribution settings, you will be able to 'sequence break' by going to other locations as well.</li></ul></p><p>Check the map for the list of Majors and Chozo locations and items:<br/><a href=\"/solver/static/images/chozo_map.png\" class=\"highslide\" onclick=\"return hs.expand(this, {wrapperClassName: 'borderless', dimmingOpacity: 0.75, align: 'center'})\"><div class=\"parent-center\"><img id=\"chozoThumb\" src=\"/solver/static/images/chozo_map_thumbnail.png\" alt=\"Chozo Map\" title=\"Click to enlarge\" class=\"child-center half\"/></div></a></p><p>Click on the dice button to randomly set this parameter.</p>"
    },
    {
      element: "#maxDifficultyStep",
      title: "Maximum difficulty for picking up an item",
      content: "<p>Depending on the perceived difficulties of the techniques, bosses, hell runs etc. from the preset, it will prevent the Randomizer from placing an item in a location too difficult to reach with the current items.</p><p><b>Warning:</b> if too low may cause the randomizer to up the difficulty for some boss fight.</p><p>Click on the dice button to randomly set this parameter.</p>"
    },
    {
      element: "#progSpeedStep",
      title: "Progression speed",
      content: "<p>A progression item can be a suit, a movement item, or any item that opens up new locations. This parameter influences how fast progression items are likely to be found.<br/>Standard speeds go from <b>slowest</b>, stuffing your way with as many non-progression items as possible, to <b>fastest</b>, where you will be able to visit Zebes pretty shortly.</p><p><b>VARIAble</b> speed will randomly change internal progression speed while placing items, creating seeds that are more unpredictable.</p><p>You can also pick <b>basic</b>, in which case VARIA will place the items exactly like Dessyreqt Randomizer, or Total Randomizer in its Normal/Casual setting.</p><p>Click on the dice button to access <b>random progression speed</b> mode where you can choose on which progression speeds the randomization will take place.</p><p><b>Note:</b> usually, slower settings will result in more difficult seeds, and faster settings in easier seeds. Basic progression speed usually results in easy/fast seeds, but not always.</p>"
    },
    {
      element: "#progDiffStep",
      title: "Progression difficulty",
      content: "<p>This parameter influences the choice of the next location. It uses the perceived difficulties from the preset to compute the difficulty to reach the locations. Then if <b>easier</b> or <b>harder</b> is selected, the easiest or hardest location will have a higher chance of being chosen.<br/>Set it to <b>normal</b> for the Randomizer to randomly choose the next location.</p><p><b>Note:</b> this setting has less of an influence on actual seed difficulty than Progression Speed.</p><p>Click on the dice button to randomly set this parameter.</p>"
    },
    {
      element: "#morphPlacementStep",
      title: "Morph Placement",
      content: "<p>Influences where VARIA will place Morphing Ball :<ul><li><b>early</b> (default): Morph will be either at its vanilla spot, or in the ceiling at the Blue Brinstar Energy Tank spot (like Total Randomizer)</li><li><b>normal</b>: Morph will be placed randomly (like Dessy Randomizer)</li><li><b>late</b>: Prevents Morph to be placed in the first available locations of the game. Best suited when used along area randomization, to find Morph in peculiar places.<br/><b>Warning: </b>In Chozo Majors Split <b>late</b> will be replace by <b>normal</b> to avoid being stuck</li></ul></p><p>Click on the dice button to randomly set this parameter.</p>"
    },
    {
      element: "#suitsRestrictionStep",
      title: "Suits restriction",
      content: "<p>Prevent Gravity or Varia suits to be placed early in the game.</p><p>Click on the dice button to randomly set this parameter.</p>"
    },
    {
      element: "#hideItemsStep",
      title: "Hide Items",
      content: "<p>Hides half of the visible items.<br/>Items always visible:<ul><li>Energy Tank, Gauntlet</li><li>Energy Tank, Terminator</li><li>Morphing Ball</li><li>Missile (Crateria moat)</li><li>Missile (green Brinstar below super missile)</li><li>Missile (above Crocomire)</li><li>Power Bomb (lower Norfair above fire flea room)</li><li>Missile (Gravity Suit)</li><li>Missile (green Maridia shinespark)</li></ul></p><p>Click on the dice button to randomly set this parameter.</p>"
    },
    {
      element: "#strictMinorsStep",
      title: "Strict ammo distribution",
      content: "<p>Instead of using the Minors proportions as probabilities, enforce a strict distribution to match the proportions as exactly as possible.</p><p>Click on the dice button to randomly set this parameter.</p>"
    },
    {
      element: "#missileQtyStep",
      title: "Proportion of Missiles/Super Missiles/Power Bombs",
      content: "<p>For each minor types, the higher the number the higher the probability of choosing it when placing a minor.</p><p>Click on the dice button to randomly set this parameter.</p>"
    },
    {
      element: "#minorQtyStep",
      title: "Percentage of minors available",
      content: "<p>From 7%: minimum number of minors required to finish the game to 100%: all minors locations contain a minor (vanilla like).</p><p>Click on the dice button to randomly set this parameter.</p>"
    },
    {
      element: "#energyQtyStep",
      title: "Quantity of Energy/Reserve Tanks available",
      content: "<p>Choose how many Energy/Reserve Tanks will be available, from 4-6 in sparse, 8-12 in medium and 18 in vanilla.</p><p>Click on the dice button to randomly set this parameter.</p>"
    },
    {
      element: "#areaRandomizationStep",
      title: "Areas randomization",
      content: "<p>Randomize areas together using bidirectional access portals:</p><a href=\"/solver/static/images/area_map.png\" class=\"highslide\" onclick=\"return hs.expand(this, {wrapperClassName: 'borderless', dimmingOpacity: 0.75, align: 'center'})\"><div class=\"parent-center\"><img id=\"areathumb\" src=\"/solver/static/images/area_map_thumbnail.png\" alt=\"Area Map\" title=\"Click to enlarge\" class=\"half child-center\"/></div></a><p>It is recommended to use the <a href=\"/solver/solver_web/tracker\" target=\"_blank\">Area Tracker</a> to find your way more easily.</p><p>All portals can be linked to one another, even if it means following an incompatible transition (Left-Left, Up-Right, ...).<br/>\
You can go through all portals and back, even those where you can't do that in vanilla, so some layout tweaks have been made:</p>\
<table class=\"full\">\
<tr>\
<td class=\"quarter\"><p class=\"top\">Remove Maridia red fish exit green gate:</p></td>\
<td class=\"quarter\"><p class=\"top\">Remove Maridia tube exit green gate:</p></td>\
<td class=\"quarter\"><p class=\"top\">Remove Lower Norfair exit crumble blocks:</p></td>\
<td class=\"quarter\"><p class=\"top\">Wrecked Ship save station is always active:</p></td>\
</tr>\
<tr>\
<td class=\"quarter\"><img src=\"/solver/static/images/fish_gate.png\" alt=\"fish_gate.png\" title=\"fish_gate.png\" class=\"full\"/></td>\
<td class=\"quarter\"><img src=\"/solver/static/images/tube_gate.png\" alt=\"tube_gate.png\" title=\"tube_gate.png\" class=\"full\"/></td>\
<td class=\"quarter\"><img src=\"/solver/static/images/ln_gate.png\" alt=\"ln_gate.png\" title=\"ln_gate.png\" class=\"full\"/></td>\
<td class=\"quarter\"><img src=\"/solver/static/images/ws_save.png\" alt=\"ws_save.png\" title=\"ws_save.png\" class=\"full\"/></td>\
</tr>\
<tr>\
<td class=\"quarter\"><p class=\"top\">Remove yellow door at Green Hill Zone:</p></td>\
<td class=\"quarter\"><p class=\"top\">Remove green door at Noob Bridge:</p></td>\
<td class=\"quarter\"><p class=\"top\">Remove yellow door at Le Coude:</p></td>\
<td class=\"quarter\"><p class=\"top\">Remove yellow door at Kronic Boost room:</p></td>\
</tr>\
<tr>\
<td class=\"quarter\"><img src=\"/solver/static/images/blue_door_greenhill.png\" alt=\"blue_door_greenhill.png\" title=\"blue_door_greenhill.png\" class=\"full\"/></td>\
<td class=\"quarter\"><img src=\"/solver/static/images/blue_door_noob.png\" alt=\"blue_door_noob.png\" title=\"blue_door_noob.png\" class=\"full\"/></td>\
<td class=\"quarter\"><img src=\"/solver/static/images/blue_door_lecoude.png\" alt=\"blue_door_lecoude.png\" title=\"blue_door_lecoude.png\" class=\"full\"/></td>\
<td class=\"quarter\"><img src=\"/solver/static/images/blue_door_kronic.png\" alt=\"blue_door_kronic.png\" title=\"blue_door_kronic.png\" class=\"full\"/></td>\
</tr>\
</table>",
      placement: "auto left"
    },
    {
      element: "#areaLayoutStep",
      title: "Areas randomization additional layout modifications",
      content: "Some layout tweaks to make your life easier in areas randomizer:\
<table class=\"full\">\
<tr>\
<td class=\"quarter\"><p class=\"top\">Remove Crab green gate in Marida:</p></td>\
<td class=\"quarter\"><p class=\"top\">Remove blue gate in Green Hill Zone:</p></td>\
<td class=\"quarter\"><p class=\"top\">New platform in Green Hill Zone to access transition door:</p></td>\
</tr>\
<tr>\
<td class=\"quarter\"><img src=\"/solver/static/images/crab_gate.png\" alt=\"crab_gate\" title=\"crab_gate\" class=\"full\"/></td>\
<td class=\"quarter\"><img src=\"/solver/static/images/greenhill_gate.png\" alt=\"greenhill_gate\" title=\"greenhill_gate\" class=\"full\"/></td>\
<td class=\"quarter\"><img src=\"/solver/static/images/greenhill_platform.png\" alt=\"greenhill_platform\" title=\"greenhill_platform\" class=\"full\"/></td>\
</tr>\
<tr>\
<td class=\"quarter\"><p class=\"top\">Access Maridia red fish exit:</p></td>\
<td class=\"quarter\"><p class=\"top\">Access Maridia tube exit:</p></td>\
<td class=\"quarter\"><p class=\"top\">Access Lower Norfair exit:</p></td>\
</tr>\
<tr>\
<td class=\"quarter\"><img src=\"/solver/static/images/fish_access.png\" alt=\"fish_access\" title=\"fish_access\" class=\"full\"/></td>\
<td class=\"quarter\"><img src=\"/solver/static/images/tube_access.png\" alt=\"tube_access\" title=\"tube_access\" class=\"full\"/></td>\
<td class=\"quarter\"><img src=\"/solver/static/images/ln_access.png\" alt=\"ln_access\" title=\"ln_access\" class=\"full\"/></td>\
</tr>\
</table>",
      placement: "auto left"
    },
    {
      element: "#bossRandomizationStep",
      title: "Bosses randomization",
	content: "<p>Randomize Golden 4 bosses access doors (<a href=\"https://wiki.supermetroid.run/Kraid\" target=\"_blank\">Kraid</a>, <a href=\"https://wiki.supermetroid.run/Phantoon\" target=\"_blank\">Phantoon</a>, <a href=\"https://wiki.supermetroid.run/Draygon\" target=\"_blank\">Draygon</a>, <a href=\"https://wiki.supermetroid.run/Ridley\" target=\"_blank\">Ridley</a>) using bidirectional access portals (the same access portals as in Areas randomization).</p>\
<p>The areas or rooms unlocked by the bosses stay unchanged. For example, you still have to kill Phantoon to activate Wrecked Ship.</p>\
<p>Wrecked Ship save station is always active:</p>\
<table class=\"quarter\">\
<tr><td><img src=\"/solver/static/images/ws_save.png\" alt=\"ws_save.png\" title=\"ws_save.png\" class=\"full\"/></td></tr>\
</table>",
      placement: "auto left"
    },
    {
      element: "#funCombatStep",
      title: "Super Fun Combat",
      content: "<p>Forces removal of Plasma Beam <img src=\"/solver/static/images/Plasma.png\" alt=\"Plasma.png\" title=\"Plasma.png\" class=\"width: 32px\"/>, and Screw Attack <img src=\"/solver/static/images/ScrewAttack.png\" alt=\"ScrewAttack.png\" title=\"ScrewAttack.png\" class=\"width: 32px\"/> if the preset and settings allow it.<br/>In addition, can randomly remove some items from the Combat set:</p>\
<ul>\
<li><img src=\"/solver/static/images/Spazer.png\" alt=\"Spazer.png\" title=\"Spazer.png\" class=\"width: 32px\"/> Spazer</li>\
<li><img src=\"/solver/static/images/Wave.png\" alt=\"Wave.png\" title=\"Wave.png\" class=\"width: 32px\"/> Wave Beam</li>\
</ul>\
Click on the dice button to randomly set this parameter.",
      placement: "auto left"
    },
    {
      element: "#funMovementStep",
      title: "Super Fun Movement",
      content: "<p>Forces removal of Space Jump <img src=\"/solver/static/images/SpaceJump.png\" alt=\"SpaceJump.png\" title=\"SpaceJump.png\" class=\"width: 32px\"/> if the preset allows it.<br/>\
In addition, can randomly remove some items from the Movement set:</p>\
<ul>\
<li><img src=\"/solver/static/images/HiJump.png\" alt=\"HiJump.png\" title=\"HiJump.png\" class=\"width: 32px\"/> Hi Jump</li>\
<li><img src=\"/solver/static/images/Grapple.png\" alt=\"Grapple.png\" title=\"Grapple.png\" class=\"width: 32px\"/> Grappling Beam</li>\
<li><img src=\"/solver/static/images/SpringBall.png\" alt=\"SpringBall.png\" title=\"SpringBall.png\" class=\"width: 32px\"/> Spring Ball</li>\
<li><img src=\"/solver/static/images/SpeedBooster.png\" alt=\"SpeedBooster.png\" title=\"SpeedBooster.png\" class=\"width: 32px\"/> Speed Booster</li>\
<li><img src=\"/solver/static/images/Bomb.png\" alt=\"Bomb.png\" title=\"Bomb.png\" class=\"width: 32px\"/> Bombs</li>\
</ul>\
Click on the dice button to randomly set this parameter.",
      placement: "auto left"
    },
    {
      element: "#funSuitsStep",
      title: "Suitless",
      content: "<p>If the preset and seed layout allow it, will force removal of at least one suit (Varia Suit <img src=\"/solver/static/images/Varia.png\" alt=\"Varia.png\" title=\"Varia.png\" class=\"width: 32px\"/> and/or Gravity Suit <img src=\"/solver/static/images/Gravity.png\" alt=\"Gravity.png\" title=\"Gravity.png\" class=\"width: 32px\"/>).</p>\
<p>Click on the dice button to randomly set this parameter.</p>",
      placement: "auto left"
    },
    {
      element: "#patchesStep",
      title: "Default Patches",
      content: "Patches also included by default:<ul><li>Allows the aim buttons to be assigned to any button (by Kejardon)</li><li>Max Ammo Display (by Personitis)</li><li>Play music with MSU1 chip on SD2SNES (by DarkShock)</li></ul>",
      placement: "auto left"
    },
    {
      element: "#layoutPatchesStep",
      title: "Anti-softlock Layout patches",
      content: "Include the anti-softlock layout patches. Disable at your own softlocking risk!\
<table class=\"full\">\
<tr>\
<td class=\"knowsUsed\"><p class=\"top\">Disable respawning blocks at Dachora Pit:</p></td>\
<td class=\"knowsUsed\"><p class=\"top\">Escape from below early Super bridge without Bombs:</p></td>\
<td class=\"knowsUsed\"><p class=\"top\">Escape from below early Super bridge:</p></td>\
<td class=\"knowsUsed\"><p class=\"top\">Replace bomb blocks with shot blocks before Hi-Jump:</p></td>\
<td class=\"knowsUsed\"><p class=\"top\">Replace bomb blocks with shot blocks at Moat:</p></td>\
</tr>\
<tr>\
<td class=\"knowsUsed\"><img src=\"/solver/static/images/dachora.png\" alt=\"dachora\" title=\"dachora\" class=\"full\"/></td>\
<td class=\"knowsUsed\"><img src=\"/solver/static/images/early_super.png\" alt=\"early_super\" title=\"early_super\" class=\"full\"/></td>\
<td class=\"knowsUsed\"><img src=\"/solver/static/images/early_super_bis.png\" alt=\"early_super_bis\" title=\"early_super_bis\" class=\"full\"/></td>\
<td class=\"knowsUsed\"><img src=\"/solver/static/images/high_jump.png\" alt=\"high_jump\" title=\"high_jump\" class=\"full\"/></td>\
<td class=\"knowsUsed\"><img src=\"/solver/static/images/moat.png\" alt=\"moat\" title=\"moat\" class=\"full\"/></td>\
</tr>\
<tr>\
<td class=\"knowsUsed\"><p class=\"top\">First heated Norfair room without High-Jump:</p></td>\
<td class=\"knowsUsed\"><p class=\"top\">Always be able to get back up from bottom Red Tower:</p></td>\
<td class=\"knowsUsed\"><p class=\"top\">Replace bomb blocks with shot blocks before Spazer:</p></td>\
<td class=\"knowsUsed\"><p class=\"top\">Remove grey door at Brinstar map stations:</p></td>\
<td class=\"knowsUsed\"><p class=\"top\">Spore Spawn save station is always available:</p></td>\
</tr>\
<tr>\
<td class=\"knowsUsed\"><img src=\"/solver/static/images/cathedral.png\" alt=\"cathedral\" title=\"cathedral\" class=\"full\"/></td>\
<td class=\"knowsUsed\"><img src=\"/solver/static/images/red_tower.png\" alt=\"red_tower\" title=\"red_tower\" class=\"full\"/></td>\
<td class=\"knowsUsed\"><img src=\"/solver/static/images/spazer_block.png\" alt=\"spazer_block\" title=\"spazer_block\" class=\"full\"/></td>\
<td class=\"knowsUsed\"><img src=\"/solver/static/images/bt_map.png\" alt=\"bt_map\" title=\"bt_map\" class=\"full\"/></td>\
<td class=\"knowsUsed\"><img src=\"/solver/static/images/spore_save.png\" alt=\"spore_save\" title=\"spore_save\" class=\"full\"/></td>\
</tr>\
</table>\
<p>Patches developed by Total & Flo.</p>",
      placement: "auto left"
    },
    {
      element: "#variaTweaksStep",
      title: "VARIA Tweaks",
      content: "<p>Include minor tweaks for the game to behave 'as it should' in a randomizer context:</p>\
<table class=\"full\">\
<tr>\
<td class=\"quarter\"><p class=\"top\">Bomb Torizo fight is triggered when picking up the item he's holding, not by having Bomb:</p></td>\
<td class=\"quarter\"><p class=\"top\">Access item at Wrecked Ship Etank location without killing Phantoon (via Forgotten Highway):</p></td>\
<td class=\"quarter\"><p class=\"top\">Activate Lower Norfair Chozo (left of entrance) without Space Jump:</p></td>\
</tr>\
<tr>\
<td class=\"quarter\"><img src=\"/solver/static/images/bomb_torizo.png\" alt=\"bomb_torizo\" title=\"bomb_torizo\" class=\"full\"/></td>\
<td class=\"quarter\"><img src=\"/solver/static/images/ws_etank.png\" alt=\"ws_etank\" title=\"ws_etank\" class=\"full\"/></td>\
<td class=\"quarter\"><img src=\"/solver/static/images/ln_chozo.png\" alt=\"ln_chozo\" title=\"ln_chozo\" class=\"full\"/></td>\
</tr>\
</table>\
<p>Patch developed by Flo.</p>",
      placement: "auto left"
    },
    {
      element: "#gravityBehaviourStep",
      title: "Suits Properties",
      content: "<p><ul>\
<li>Balanced:<p>Removes Gravity <img src=\"/solver/static/images/Gravity.png\" alt=\"Gravity.png\" title=\"Gravity.png\" class=\"width: 32px\"/> environmental protection (heat, spikes, electricity...). It also doubles the Varia <img src=\"/solver/static/images/Varia.png\" alt=\"Varia.png\" title=\"Varia.png\" class=\"width: 32px\"/> environmental protection, to balance the two suits abilities. Enemy damage protection is still vanilla (50% for Varia, 75% for Gravity).</p></li>\
<li>Progressive:\
<p><ul>\
<li>Gravity <img src=\"/solver/static/images/Gravity.png\" alt=\"Gravity.png\" title=\"Gravity.png\" class=\"width: 32px\"/> provides 50% heat damage reduction. Varia <img src=\"/solver/static/images/Varia.png\" alt=\"Varia.png\" title=\"Varia.png\" class=\"width: 32px\"/> still provides full heat protection.</li>\
<li>Varia <img src=\"/solver/static/images/Varia.png\" alt=\"Varia.png\" title=\"Varia.png\" class=\"width: 32px\"/> and Gravity  <img src=\"/solver/static/images/Gravity.png\" alt=\"Gravity.png\" title=\"Gravity.png\" class=\"width: 32px\"/> each add 50% damage reduction to enemy attacks and environmental damage.</li>\
<li>Varia <img src=\"/solver/static/images/Varia.png\" alt=\"Varia.png\" title=\"Varia.png\" class=\"width: 32px\"/> and Gravity  <img src=\"/solver/static/images/Gravity.png\" alt=\"Gravity.png\" title=\"Gravity.png\" class=\"width: 32px\"/> stack to reach 75% reduction to enemy attacks and environmental damage.</li>\
</ul></p>\
</li>\
<li>Vanilla:<p>No change to vanilla suits properties. Most notably, Gravity <img src=\"/solver/static/images/Gravity.png\" alt=\"Gravity.png\" title=\"Gravity.png\" class=\"width: 32px\"/> provides full protection against environmental damages (heat, spikes, electricity...).</p></li>\
</ul></p>\
<p>Patches developed by Total and Smiley.</p>",
      placement: "auto left"
    },
    {
      element: "#nerfedChargeStep",
      title: "Nerfed Charge Beam",
      content: "<ul>\
<li>Samus begins with a starter Charge Beam <img src=\"/solver/static/images/Charge.png\" alt=\"Charge.png\" title=\"Charge.png\" class=\"width: 32px\"/> that does one third of charged shot damage, effectively bringing a nerfed charge shot damage to a standard shot damage, but that can damage bosses.</li>\
<li><a href=\"https://wiki.supermetroid.run/Pseudo_Screw_Attack\" target=\"_blank\">Pseudo Screws</a> and <a href=\"https://wiki.supermetroid.run/Charge_Beam_Combos\" target=\"_blank\">Special Beam Attacks</a> also do one third damage.</li>\
<li>Once the Charge Beam <img src=\"/solver/static/images/Charge.png\" alt=\"Charge.png\" title=\"Charge.png\" class=\"width: 32px\"/> item has been collected, it does full damage.</li>\
</ul>\
<p>Patch developed by Smiley and Flo.</p>",
      placement: "auto left"
    },
    {
      element: "#itemsoundsStep",
      title: "Fanfare",
      content: "<p>Replaces the quite long fanfare played when picking up an item by a short sound effect related with the item picked, and does not restart game music on item pickup.</p>\
<p>Patch developed by Scyzer.</p>",
      placement: "auto left"
    },
    {
      element: "#ElevatorDoorsStep",
      title: "Transitions",
      content: "<p>Accelerate doors and elevators transitions</p>\
<p>Doors patch developed by Rakki and elevators patch by Lioran.</p>",
      placement: "auto left"
    },
    {
      element: "#spinjumprestartStep",
      title: "Spin jump restart",
      content: "<p>Allows Samus to start spinning in mid air after jumping or falling</p>\
<p>Patch developed by Kejardon.</p>",
      placement: "auto left"
    },
    {
      element: "#rando_speedStep",
      title: "Momentum conservation",
      content: "<p>Let Samus keeps her momentum when landing from a fall or from jumping</p>\
<p>This patch was developed by Oi27.</p>",
      placement: "auto left"
    },
    {
      element: "#StartLocationStep",
      title: "Start location",
      content: "<p>Choose where you want to start the game:\
<ul>\
<li>Start at Ceres Station: Skip text intro</li>\
<li>Start at Landing Site: Skip text intro and Ceres station</li>\
</ul>\
</p>\
<p>Patches developed by Smiley and Total.</p>",
      placement: "auto left"
    },
    {
      element: "#animalsStep",
      title: "Animals surprise",
      content: "<p>Replace saving the animals in the escape sequence by a random surprise.</p>\
<p>Patch developed by Foosda.</p>",
      placement: "auto left"
    },
    {
      element: "#No_MusicStep",
      title: "No music",
      content: "<p>Disable the background music to let you hear you favorite tunes instead.</p>\
<p>Patch developed by Kejardon.</p>",
      placement: "auto left"
    }
 ]});

  // Initialize the tour
  tour.init();

  // Start the tour
  if(step != -1) {
    tour.goTo(step);
  }
  tour.start();
}

function DoPost(){
    $.redirect("/presets", { action: "Load", currenttab: "Techniques1", preset: document.getElementById("preset").value }, "POST", "_blank");
}
</script>
{{
def displayCheckbox(id, defaultTrue=False):
  if (id in session.randomizer and session.randomizer[id] == 'on') or (id not in session.randomizer and defaultTrue == True):
}}
    {{=INPUT(_id=id, _name=id, _type="checkbox", _checked="checked", _value="on", _class="js-switch", _onchange="switchCheckbox('{}')".format(id))}}
{{
  else:
}}
    {{=INPUT(_id=id, _name=id, _type="checkbox", _value="off", _class="js-switch", _onchange="switchCheckbox('{}')".format(id))}}
    {{pass}}
  {{pass}}

{{
def displaySelect(id, values, default):
  if id in session.randomizer:
    if id == "progressionSpeed":
      if type(session.randomizer["progressionSpeed"]) == list:
        if len(session.randomizer["progressionSpeed"]) == 1:
          value = session.randomizer[id][0]
        else:
          value = default
          pass
      else:
        value = session.randomizer[id]
        pass
    else:
      value = session.randomizer[id]
      pass
  else:
    value = default
    pass
}}
  {{
   =SELECT(*values,
           **dict(_id=id, _name=id, value=value, _class="full"))
  }}
{{pass}}
{{
def displayNumber(id, min, max, default, step="1"):
  if id in session.randomizer:
    value = session.randomizer[id]
  else:
    value = default
    pass

  response.write("<input name=\"{}\" id=\"{}\" type=\"number\" value=\"{}\" min=\"{}\" max=\"{}\" step=\"{}\" class=\"full\" required>".format(id, id, value, min, max, step), escape=False)
  pass
}}
<body>
  <div id="overlay"></div>
  <div id="loadingGIF"><img src={{=URL('static/images','ajax-loader.gif')}}/></div>
  <div id="loadingTips0" class="loadingTips"></div>
  <div id="loadingTips1" class="loadingTips"></div>

  <div class="fixed">
    <div class="menu">
    <table class="full menuTable">
      <tr>
	<td>{{=A("Home", _href=URL(f="home"), _class="menu")}}</td>
	<td>{{=A("Presets", _href=URL(f="presets"), _class="menu")}}</td>
	<td class="menu_selected">{{=A("Randomizer", _href=URL(f="randomizer"), _class="menu")}}</td>
	<td>{{=A("Solver", _href=URL(f="solver"), _class="menu")}}</td>
	<td>{{=A("Tracker", _href=URL(f="tracker"), _class="menu")}}</td>
	<td>{{=A("Plandomizer", _href=URL(f="plando"), _class="menu")}}</td>
	<td>{{=A("Customizer", _href=URL(f="customizer"), _class="menu")}}</td>
	<td>{{=A("Statistics", _href=URL(f="extStats"), _class="menu")}}</td>
	<td>{{=A("Information & Contact", _href=URL(f="infos"), _class="menu")}}</td>
      </tr>
    </table>
    </div>
  </div>

  <div class="main">
    <div id="complexityTabs" class="center">
      <div class="tab">
        <button class="tablinks" id="simple" onclick="changeComplexity(event, 'simple');">Simple</button>
        <button class="tablinks" id="medium" onclick="changeComplexity(event, 'medium');">Medium</button>
        <button class="tablinks" id="advanced" onclick="changeComplexity(event, 'advanced');">Advanced</button>
      </div>
    </div>
    <form id="mainform" name="mainform" onsubmit="doSubmit(); return false;">
      <div id="tabRando" class="tabcontent">
        <div class="row">
	  <div class="column">
	    <p>The Very Adaptive Randomizer of Items and Area (VARIA) randomizer will generate a Super Metroid ROM finishable using the known techniques of the chosen preset.</p>
            <table class="full">
              <colgroup><col class="half" /><col class="half" /></colgroup>
              <tr>
                <td>Vanilla Super Metroid ROM:</td>
                <td>{{=INPUT(_type="file", _name="uploadFile", _id="uploadFile", _class="full")}}</td>
                <td id="romStep"><button type="button" onclick="startTheTour(0)">?</button></td>
              </tr>
              <tr id="seedVisibility">
	        <td>Randomizer seed:</td>
	        <td>{{displayNumber("seed", "0", "9999999", "0")}}</td>
	        <td id="seedStep"><button type="button" onclick="startTheTour(1)">?</button></td>
              </tr>
              <tr>
		<td>Skills Preset: <span class="rightStep"><a href="javascript:DoPost()">What's in the logic for this skills preset ?</a><span></td>
		<td>{{=SELECT(OPTGROUP(*stdPresets, **dict(_label="Standard presets")), OPTGROUP(*tourPresets, **dict(_label="Tournament presets")), OPTGROUP(*comPresets, **dict(_label="Community presets")), **dict(_name="preset", _id="preset", value=session.randomizer["preset"], _class="filldropdown chzn-select"))}}</td>
		<td id="presetStep"><button type="button" onclick="startTheTour(2)">?</button></td>
              </tr>
	      <tr>
		<td>Settings Preset:</td>
		<td>{{=SELECT(OPTGROUP(*randoPresets, **dict(_label="Standard presets")), OPTGROUP(*tourRandoPresets, **dict(_label="Tournament presets")), **dict(_name="randoPreset", _id="randoPreset", value=session.randomizer["randoPreset"], _class="filldropdown chzn-select", _onchange="loadRandoPreset()"))}}</td>
		<td id="randoPresetStep"><button type="button" onclick="startTheTour(3)">?</button></td>
              </tr>
	      <tr id="raceModeVisibility">
		<td>{{displayCheckbox("raceMode")}}<span id="raceModeText">Race Mode</span></td>
		<td></td>
		<td id="raceStep"><button type="button" onclick="startTheTour(4)">?</button></td>
	      </tr>
            </table>
	    <br/>
	    <h4>Randomizer parameters</h4>
	    <table class="full">
	      <tr>
		<td class="small"><div class="random"><button id="majorsSplitRandom" type="button" onclick="randomize(event, 'majorsSplit')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
		<td><span id="majorsSplitText">Majors Split</span></td>
	        <td>{{displaySelect("majorsSplit", ["Full", "Major", "Chozo"], "Full")}}</td>
                <td id="majorsSplitStep"><button type="button" onclick="startTheTour(5)">?</button></td>
	      </tr>
              <tr id="maxDiffVisibility">
		<td class="small"><div class="random"><button id="maxDifficultyRandom" type="button" onclick="randomize(event, 'maxDifficulty')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                <td><span id="maxDifficultyText">Maximum difficulty for picking up an item:</span></td>
                <td>{{displaySelect("maxDifficulty", ["no difficulty cap", "easy", "medium", "hard", "harder", "hardcore", "mania"], "no difficulty cap")}}</td>
                <td id="maxDifficultyStep"><button type="button" onclick="startTheTour(6)">?</button></td>
              </tr>
	      <tr>
		<td class="small"><div class="random"><button id="progressionSpeedRandom" type="button" onclick="randomize(event, 'progressionSpeed')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
	        <td class="half"><span id="progressionSpeedText">Progression speed:</span></td>
                <td class="half">
		  {{displaySelect("progressionSpeed", ["slowest", "slow", "medium", "fast", "fastest", "basic", "VARIAble"], "medium")}}
		  <div id="psMultiselectDiv">
		    <select id="psMultiselect" data-placeholder="Speeds to randomize..." class="filldropdown chzn-select" multiple>
		      <option value="slowest" selected="selected">slowest</option>
		      <option value="slow" selected="selected">slow</option>
		      <option value="medium" selected="selected">medium</option>
		      <option value="fast" selected="selected">fast</option>
		      <option value="fastest" selected="selected">fastest</option>
		      <option value="basic" selected="selected">basic</option>
		      <option value="VARIAble" selected="selected">VARIAble</option>
		    </select>
		  </div>
		</td>
                <td id="progSpeedStep"><button type="button" onclick="startTheTour(7)">?</button></td>
	      </tr>
	      <tr id="progDiffVisibility">
		<td class="small"><div class="random"><button id="progressionDifficultyRandom" type="button" onclick="randomize(event, 'progressionDifficulty')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
	        <td class="half"><span id="progressionDifficultyText">Progression difficulty:</span></td>
                <td class="half">{{displaySelect("progressionDifficulty", ["easier", "normal", "harder"], "normal")}}</td>
                <td id="progDiffStep"><button type="button" onclick="startTheTour(8)">?</button></td>
	      </tr>
	      <tr id="morphPlacementVisibility">
		<td class="small"><div class="random"><button id="morphPlacementRandom" type="button" onclick="randomize(event, 'morphPlacement')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
	        <td class="half"><span id="morphPlacementText">Morph Placement:</span></td>
	        <td class="half">{{displaySelect("morphPlacement", ["early", "normal", "late"], "normal")}}</td>
                <td id="morphPlacementStep"><button type="button" onclick="startTheTour(9)">?</button></td>
	      </tr>
	      <tr id="suitsRestrictionVisibility">
		<td class="small"><div class="random"><button id="suitsRestrictionRandom" type="button" onclick="randomize(event, 'suitsRestriction')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
	        <td colspan="2">{{displayCheckbox("suitsRestriction")}}<span id="suitsRestrictionText">Suits restriction</span></td>
                <td id="suitsRestrictionStep"><button type="button" onclick="startTheTour(10)">?</button></td>
	      </tr>
	      <tr id="hideItemsVisibility">
		<td class="small"><div class="random"><button id="hideItemsRandom" type="button" onclick="randomize(event, 'hideItems')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
		<td colspan="2">{{displayCheckbox("hideItems")}}<span id="hideItemsText">Hide some items</span></td>
		<td id="hideItemsStep"><button type="button" onclick="startTheTour(11)">?</button></td>
	      </tr>
	    </table>
	    <div id="ammoVisibility">
	      <h4>Ammo and Energy</h4>
	      <table class="full">
                <colgroup><col class="small"/><col class="half" /><col class="half" /><col class="small"/></colgroup>
                <tr id="strictMinorsVisibility">
		  <td class="small"><div class="random"><button id="strictMinorsRandom" type="button" onclick="randomize(event, 'strictMinors')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
		  <td colspan="2">{{displayCheckbox("strictMinors")}}<span id="strictMinorsText">Strict Minors distribution</span></td>
		  <td id="strictMinorsStep"><button type="button" onclick="startTheTour(12)">?</button></td>
                </tr>
                <tr id="missileQtyVisibility">
		  <td class="small"><div class="random"><button id="missileQtyRandom" type="button" onclick="randomize(event, 'missileQty')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
		  <td><span id="missileQtyText">Proportion of Missiles:</span></td>
		  <td>{{displayNumber("missileQty", "1", "9", "3", "0.1")}}</td>
		  <td id="missileQtyStep"><button type="button" onclick="startTheTour(13)">?</button></td>
                </tr>
                <tr id="superQtyVisibility">
		  <td class="small"><div class="random"><button id="superQtyRandom" type="button" onclick="randomize(event, 'superQty')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
		  <td><span id="superQtyText">Proportion of Super Missiles:</span></td>
		  <td>{{displayNumber("superQty", "1", "9", "3", "0.1")}}</td>
                </tr>
                <tr id="powerBombQtyVisibility">
		  <td class="small"><div class="random"><button id="powerBombQtyRandom" type="button" onclick="randomize(event, 'powerBombQty')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
		  <td><span id="powerBombQtyText">Proportion of Power Bombs:</span></td>
		  <td>{{displayNumber("powerBombQty", "1", "9", "1", "0.1")}}</td>
                </tr>
                <tr>
		  <td class="small"><div class="random"><button id="minorQtyRandom" type="button" onclick="randomize(event, 'minorQty')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
		  <td><span id="minorQtyText">Percentage of minors available:</span></td>
		  <td>{{displayNumber("minorQty", "7", "100", "100")}}</td>
		  <td id="minorQtyStep"><button type="button" onclick="startTheTour(14)">?</button></td>
                </tr>
                <tr>
		  <td class="small"><div class="random"><button id="energyQtyRandom" type="button" onclick="randomize(event, 'energyQty')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
		  <td><span id="energyQtyText">Quantity of Energy/Reserve Tanks available:</span></td>
		  <td>{{displaySelect("energyQty", ["sparse", "medium", "vanilla"], "vanilla")}}</td>
		  <td id="energyQtyStep"><button type="button" onclick="startTheTour(15)">?</button></td>
                </tr>
	      </table>
	    </div>
	  </div>
	  <div class="column">
            <h4>Areas Randomization</h4>
            <p>
	      Add more randomness to your seed by randomizing the access between the areas.<br/>
	      Check the help button for the map of the areas and the access points between them.
            </p>
	    <table class="full">
	      <tr>
	        <td colspan="2" class="full" id="areaRandomizationStep">{{displayCheckbox("areaRandomization")}}Areas randomization</td>
                <td><button type="button" onclick="startTheTour(16)">?</button></td>
	      </tr>
	      <tr id="areaPatchVisibility">
		<td colspan="2" class="full" id="areaLayoutStep">{{displayCheckbox("areaLayout", False)}} Additional layout patches for easier navigation</td><td><button type="button" onclick="startTheTour(17)">?</button></td>
	      </tr>
            </table>
            <h4>Bosses Randomization</h4>
            <p>
	      Randomize the access doors to the Golden 4 bosses.
            </p>
	    <table class="full">
	      <tr>
	        <td colspan="2" class="full" id="bossRandomizationStep">{{displayCheckbox("bossRandomization")}}Bosses randomization</td>
                <td><button type="button" onclick="startTheTour(18)">?</button></td>
	      </tr>
            </table>
	    <div id="superFunVisibility">
              <h4>Super Fun Times (TM)</h4>
              <p>
                Have fun randomly removing major items! <b>Warning:</b> For experienced players only.
              </p>
	      <table class="full">
                <tr>
		  <td class="small" id="funCombatStep"><div class="random"><button id="funCombatRandom" type="button" onclick="randomize(event, 'funCombat')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
		  <td colspan="2" class="full">{{displayCheckbox("funCombat")}}<span id="funCombatText">Super Fun Combat</span></td>
		  <td><button type="button" onclick="startTheTour(19)">?</button></td>
                </tr>
                <tr>
		  <td class="small" id="funMovementStep"><div class="random"><button id="funMovementRandom" type="button" onclick="randomize(event, 'funMovement')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
		  <td colspan="2" class="full">{{displayCheckbox("funMovement")}}<span id="funMovementText">Super Fun Movement</span></td>
		  <td><button type="button" onclick="startTheTour(20)">?</button></td>
                </tr>
                <tr>
		  <td class="small" id="funSuitsStep"><div class="random"><button id="funSuitsRandom" type="button" onclick="randomize(event, 'funSuits')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
		  <td colspan="2" class="full">{{displayCheckbox("funSuits")}}<span id="funSuitsText">Suitless</span></td>
		  <td><button type="button" onclick="startTheTour(21)">?</button></td>
                </tr>
              </table>
	    </div>
	    <div id="patchesVisibility">
	      <h4 id="patchesStep">Patches<span class="rightStep"><button type="button" onclick="startTheTour(22)">?</button></span></h4>
	      <p id="mainPatchesTextVisibility">
	        The bug fix <a href="https://itemrando.supermetroid.run/information" target="_blank">patches</a> from Total Item Randomizer are included by default.
	      </p>
	      <table class="full">
		<colgroup><col class="quarter" /><col class="threequarter" /><col class="check" /></colgroup>
		<tr><td colspan="2"><h5 class="center"><b>Randomizer adaptations (logic impact)</b></h5></td><td></td></tr>
	      </table>
	      <table class="full" id="mainPatchesVisibility">
		<colgroup><col class="half" /><col class="half" /></colgroup>
	        <tr id="layoutPatchesStep">
		  <td colspan="2">{{displayCheckbox("layoutPatches", True)}} Anti-softlock layout patches</td>
		  <td><button type="button" onclick="startTheTour(23)">?</button></td>
	        </tr>
	        <tr>
		  <td colspan="2" id="variaTweaksStep">{{displayCheckbox("variaTweaks", True)}} VARIA tweaks</td>
		  <td><button type="button" onclick="startTheTour(24)">?</button></td>
	        </tr>
	        <tr id="gravityBehaviourStep">
		  <td>Suits properties</td>
		  <td>
		    {{displaySelect("gravityBehaviour", ["Balanced", "Progressive", "Vanilla"], "Balanced")}}
		  </td>
		  <td><button type="button" onclick="startTheTour(25)">?</button></td>
	        </tr>
	      </table>
	      <table class="full" id="nerfedChargeVisibility">
		<colgroup><col class="half" /><col class="half" /></colgroup>
		<tr id="nerfedChargeStep">
		  <td colspan="2">
		    {{displayCheckbox("nerfedCharge")}}
		    Nerfed Charge Beam available from the start
		  </td>
                  <td><button type="button" onclick="startTheTour(26)">?</button></td>
		</tr>
	      </table>
	      <table class="full">
		<colgroup><col class="quarter" /><col class="threequarter" /><col class="check" /></colgroup>
		<tr><td colspan="2"><h5 class="center"><b>Game comfort</b></h5></td><td></td></tr>
	      </table>
	      <table class="full">
		<colgroup><col class="half" /><col class="half" /></colgroup>
		<tr id="itemsoundsStep">
		  <td colspan="2">
		    {{displayCheckbox("itemsounds")}}
		    Remove fanfare when picking up an item
		  </td>
                  <td><button type="button" onclick="startTheTour(27)">?</button></td>
		</tr>
		<tr id="ElevatorDoorsStep">
		  <td colspan="2">
		    {{displayCheckbox("elevators_doors_speed")}}
		    Accelerate doors and elevators transitions
		  </td>
                  <td><button type="button" onclick="startTheTour(28)">?</button></td>
		</tr>
	      </table>
	      <table class="full">
		<colgroup><col class="half" /><col class="half" /></colgroup>
		<tr id="spinjumprestartStep">
		  <td colspan="2">
		    {{displayCheckbox("spinjumprestart")}}
		    Spin jump restart (a.k.a. Respin)
		  </td>
                  <td><button type="button" onclick="startTheTour(29)">?</button></td>
		</tr>
		<tr id="rando_speedStep">
		  <td colspan="2">
		    {{displayCheckbox("rando_speed")}}
		     Momentum conservation (a.k.a. Speedkeep)
		  </td>
                  <td><button type="button" onclick="startTheTour(30)">?</button></td>
		</tr>
	      </table>
	      <table class="full">
		<colgroup><col class="quarter" /><col class="threequarter" /><col class="check" /></colgroup>
		<tr><td colspan="2"><h5 class="center"><b>Miscellaneous</b></h5></td><td></td></tr>
	      </table>
	      <table class="full" id="miscVisibility">
		<colgroup><col class="half" /><col class="half" /></colgroup>
		<tr id="StartLocationStep">
		  <td>Start location</td>
		  <td>{{displaySelect("startLocation", ["Ceres", "Landing Site"], "Landing Site")}}</td>
                  <td><button type="button" onclick="startTheTour(31)">?</button></td>
		</tr>
		<tr id="animalsStep">
		  <td colspan="2">
		    {{displayCheckbox("animals")}}
		    Save the animals surprise
		  </td>
                  <td><button type="button" onclick="startTheTour(32)">?</button></td>
		</tr>
	      </table>
	      <table class="full" id="noMusicVisibility">
		<colgroup><col class="half" /><col class="half" /></colgroup>
		<tr id="No_MusicStep">
		  <td colspan="2">
		    {{displayCheckbox("No_Music")}}
		    Disable background music
		  </td>
                  <td><button type="button" onclick="startTheTour(33)">?</button></td>
		</tr>
	      </table>
	    </div>
	  </div>
        </div>
	<p class="customizerText">
	  <a href="/customizer" target="_blank">You can randomize in-game colors and use a custom Samus sprite on the Customizer page</a>.
	</p>
        {{=INPUT(_type="submit", _value="Randomize", _id="submitBtn", _class="btn btn-default buttonRandom")}}
    </form>
  </div>
</body>
