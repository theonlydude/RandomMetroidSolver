{{
extend 'layout.html'
}}

<meta name="description" content="Solver for the randomized Super Metroid roms"/>
<link rel="shortcut icon" href={{=URL('static','favicon.ico')}} type="image/ico"/>
<script src="{{=URL('static','js/FileSaver.js')}}"></script>

<link rel="stylesheet" type="text/css" href={{=URL('static','dist/switchery.css')}} media="screen"/>
<script src="{{=URL('static','dist/switchery.js')}}"></script>

<link href={{=URL('static', 'css/bootstrap-tour.min.css')}} rel="stylesheet">
<script src="{{=URL('static','js/bootstrap-tour.min.js')}}"></script>

<link rel="stylesheet" type="text/css" href="{{=URL('static','image-picker/image-picker.css')}}">
<script src="{{=URL('static', 'image-picker/image-picker.js')}}" type="text/javascript"></script>

<script type="text/javascript" src="{{=URL('static', '/highslide/highslide.js')}}"></script>
<link rel="stylesheet" type="text/css" href={{=URL("static", "/highslide/highslide.css")}} />
<script type="text/javascript">
hs.graphicsDir = "/solver/static/highslide/graphics/";
hs.showCredits = 0;
hs.zIndexCounter = 1000000;
hs.dimmingOpacity = 0.75;

if (hs.registerOverlay) {
        // The simple semitransparent close button overlay
        hs.registerOverlay({
                thumbnailId: 'areathumb',
                html: '<div class="closebutton"        onclick="return hs.close(this)" title="Close"></div>',
                position: 'top right',
                fade: 2 // fading the semi-transparent overlay looks bad in IE
        });
}
</script>

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css" rel="stylesheet" />
<script type="text/javascript" src="{{=URL('static', 'js/chosen.jquery.min.js')}}"></script>
<link rel="stylesheet" type="text/css" href={{=URL("static", "css/chosen.css")}} />

<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

<script type="text/javascript" src="{{=URL('static', 'js/jquery.redirect.js')}}"></script>

<script type="text/javascript" src="{{=URL('static', 'js/crc32.js')}}"></script>

<script type="text/javascript" src="{{=URL('static', 'js/localforage.nopromises.min.js')}}"></script>

<title>Super Metroid VARIA Randomizer</title>

<style>
{{include 'solver_web/varia.css'}}
.image_picker_selector .thumbnail {
    cursor: pointer;
}
.innertd {
    padding-left: 5px;
    padding-right: 5px;
    padding-top: 0px;
    padding-bottom: 0px;
    border-bottom: 0px;
}
.blankLastRow {
    height: 1em;
    background-color: #fff;
    border-bottom: none;
}
.customizerText {
    width: 40%;
    margin-left: 30%;
    margin-right: 30%;
    margin-top: 1em;
    margin-bottom: 0em;
    text-align: center;
}
.donate {
    text-align: right;
}
.nomargin {
    margin: 0em;
    border: 0em;
    padding: 0em;
}
.inputImage {
    margin-bottom: -1em;
}
.rightStep {
    float: right;
    margin-right: 0.3em;
}
.top {
    vertical-align: top;
}
.parent-center {
    text-align: center;
}
.child-center {
    margin: auto;
}
.popover {
    max-width: 50%;
}
.popover > .arrow {
    /* this is broken and causing all popovers to scroll unnecessarily */
    display: none;
}
.highslide-dimming {
    background: black;
}
#overlay {
    position: fixed; /* Sit on top of the page content */
    display: none; /* Hidden by default */
    width: 100%; /* Full width (cover the whole page) */
    height: 100%; /* Full height (cover the whole page) */
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0,0,0,0.5); /* Black background with opacity */
    z-index: 2; /* Specify a stack order in case you're using a different order for other elements */
    cursor: pointer; /* Add a pointer on hover */
}
#loadingGIF {
    position: absolute;
    left: 5%;
    z-index: 3;
    display:none;
}
@media (max-height: 800px) {
    .loadingGIF {
         top: 20%;
    }
}
@media (min-height: 800px) {
    .loadingGIF {
         top: 40%;
    }
}
.loadingTips {
    position: fixed;
    left: 50%;
    top: 3.25%;
    z-index: 99;
    display:none;
    border-radius: 2em;
    background-color: #ffffff;
    height: auto;
    padding: 0.5%;
    border: 2px solid #666666;
}
.sixty {
    width: 65%
}
.thirty {
    width: 30%
}
.floatright {
    float: right;
    vertical-align: top;
    margin-top: -0.3em;
}
.floatleft {
    float: left;
    vertical-align: top;
}
#slider-container {
  width: 80%;
  height: 80px;
  box-sizing: border-box;
  position: relative;
  top: 50%;
  margin: 0 auto;
  text-align: center;
  background: #FFF;
  padding: 35px 40px 30px 40px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

.ui-slider, .ui-slider .slider-range-inverse, .ui-slider .ui-slider-range {
  height: 14px;
  border-radius: 0px;
  border-width: 0;
}
.ui-slider {
  background-color: #1ABC9C;
  background-image: linear-gradient(to right, #0000e8 0%, #e80074 25%, #e8e800 50%, #00e874 75%, #0000e8 100%);
}
.ui-slider * {
  outline: none;
}
.ui-slider .slider-range-inverse0 {
  background: #CCC;
  position: absolute;
  left: 0;
  height: 12px;
}
.ui-slider .slider-range-inverse1 {
  background: #CCC;
  position: absolute;
  right: 0;
  height: 12px;
}
.ui-slider .ui-slider-range {
  background: transparent;
}
.ui-slider .ui-slider-handle {
  width: 6px;
  height: 20px;
  cursor: pointer;
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
  background: #FFF;
  top: -4px;
  border-width: 0;
  margin-left: -3px;
}
.ui-slider .ui-slider-handle:active {
  box-shadow: 0 3px 20px rgba(0, 0, 0, 0.5);
}
.ui-slider .ui-slider-handle .dot {
  width: 4px;
  height: 18px;
  position: absolute;
  top: 1px;
  left: 1px;
  background: transparent;
  overflow: hidden;
}
.ui-slider .ui-slider-handle .dot .handle-track0 {
  display: block;
  height: 18px;
  background-color: #1ABC9C;
  background-image: linear-gradient(to right, #0000e8 0%, #e80074 25%, #e8e800 50%, #00e874 75%, #0000e8 100%);
  position: absolute;
  margin-left: 0px;
}
.ui-slider .ui-slider-handle .dot .handle-track1 {
  display: block;
  height: 18px;
  background-color: #1ABC9C;
  background-image: linear-gradient(to right, #0000e8 0%, #e80074 25%, #e8e800 50%, #00e874 75%, #0000e8 100%);
  position: absolute;
  margin-left: 8px;
}

.sixty {
    width: 65%
}
.thirty {
    width: 30%
}
.floatright {
    float: right;
    /* vertical-align: top; */
    margin-top: -1em;
}
.floatleft {
    float: left;
    /* vertical-align: top; */
    margin-right: 0.5em;
}
.sixth {
    width: 16.66%;
}
.paddingonleft {
    padding-left: 2em;
}
.centerIcon {
    display: block;
    margin-left: auto;
    margin-right: 1em;
    width: 32px;
    image-rendering: -moz-crisp-edges; /* Firefox */
    image-rendering: -o-crisp-edges; /* Opera */
    image-rendering: -webkit-optimize-contrast; /* Webkit (non-standard naming) */
    image-rendering: crisp-edges;
    image-rendering: pixelated;
    -ms-interpolation-mode: nearest-neighbor; /* IE (non-standard property) */
}
.marginRight {
    margin-right: 2em;
}
.center_img {
    display: block;
    margin-left: auto;
    margin-right: auto;
    width: 40%;
}
.chosen-drop .chosen-results {
    max-height: 40em;
}
.areaRandoDiv {
  display: flex;
  align-items: center;
}
.areaRandoDiv .full{
  width: 60px;
}
#areaRandomizationText {
  flex-grow: 1;
}
.rando_button {
    cursor: pointer;
    width: 2em;
}
.btn.btn-default[disabled] {
    background: inherit;
    opacity: 0.25;
}
</style>

<script type="text/javascript">
{{include 'solver_web/_randomizer_data.js'}}
// https://stackoverflow.com/questions/16960690/chosen-harvesthq-resize-width-dynamically
$(document).ready(function(){
   jQuery(window).on('resize', resizeChosen);
});

// chosen elements need a special method to update their value
var chosenElements = ["preset", "startLocationMultiSelect", "majorsSplitMultiSelect", "progressionSpeedMultiSelect", "progressionDifficultyMultiSelect", "morphPlacementMultiSelect", "energyQtyMultiSelect", "gravityBehaviourMultiSelect", "tourianMultiSelect", "areaRandomizationMultiSelect"];
var currentMultiValues = {{response.write(currentMultiValues, escape=False)}};
var defaultMultiValues = {{response.write(defaultMultiValues, escape=False)}};
// not a regular multi select
var logicMultiSelect = {{response.write(currentMultiValues["logic"], escape=False)}};

function resizeChosen() {
   $(".chosen-container").each(function() {
       $(this).attr('style', 'width: 100%');
   });
}

function isElemRandom(elem) {
    return elem.className.search("active") != -1;
}

function isElemIdRandom(elemId) {
    return isElemRandom(document.getElementById(elemId+"Random"));
}

function randomizeTarget(evt, elemId) {
    var e = document.getElementById(elemId);

    var isActive;
    if(isElemRandom(evt.currentTarget)) {
        evt.currentTarget.className = evt.currentTarget.className.replace(" active", "");
        isActive = false;

        // store multiple selected values for next time the dice is pressed
        logicMultiSelect = $('#'+elemId).data('picker').selected_values();
        // go back to single selection
        $('#'+elemId).prop('multiple', false);
    } else {
        evt.currentTarget.className += " active";
        isActive = true;
        $('#'+elemId).prop('multiple', true);

        // set selected values, default to all selected
        $('#'+elemId).val(logicMultiSelect);
    }

    // recreate select with updated multiple
    $('#'+elemId).data('picker').destroy();
    var params = {show_label: true};
    $('#'+elemId).imagepicker(params);
}

function randomize(evt, elemId) {
  var e = document.getElementById(elemId);

  var isActive;
  if(isElemRandom(evt.currentTarget)) {
    evt.currentTarget.className = evt.currentTarget.className.replace(" active", "");
    isActive = false;

    defaultValues = {"missileQty": 3, "superQty": 2, "powerBombQty": 1, "minorQty": 100, "scavNumLocs": 10, "nbObjective": 4, "nbObjectivesRequired": "off"};

    if(e.value.length == 0 && elemId in defaultValues) {
      e.value = defaultValues[elemId];
    }

  } else {
    evt.currentTarget.className += " active";
    isActive = true;
  }

  disableElement(elemId, isActive);

  // disable elements on the same line
  var additionnal = {"escapeRando": ["removeEscapeEnemies"]};
  if(elemId in additionnal) {
      for(var i=0; i<additionnal[elemId].length; i++) {
          // disable it if isActive is false
          disableElement(additionnal[elemId][i], isActive);
      }
  }

  // hide some params
  var hideAdditionnal = {"majorsSplit": ["scavengerParams"]};
  if(elemId in hideAdditionnal) {
      for(var i=0; i<hideAdditionnal[elemId].length; i++) {
          var subElem = document.getElementById(hideAdditionnal[elemId][i]);
          if(isActive) {
              subElem.style.display = "none";
          } else {
              subElem.style.display = "block";
          }
      }
  }

  // when random is removed call the onchange function to enable/disable dependent elements based on elemId value
  if (!isActive && typeof e.onchange === "function") {
      e.onchange();
  }

  // special case for multi select
  var multi = document.getElementById(elemId+"MultiSelectDiv");
  if(multi != null) {
    if(isActive == true) {
      e.style.display = "none";
      multi.style.display = "block";
      // chosen must be activated when it's visible, else it doesn't work...
      $("#"+elemId+"MultiSelect").chosen("destroy");
      $("#"+elemId+"MultiSelect").chosen({ width: '100%' });
    } else {
      e.style.display = "block";
      multi.style.display = "none";
    }
  }

  if (e.id === 'areaRandomization') {
    if (isActive) {
      $("#areaRandomizationMultiSelect").change();
      window.$randomizer.set('areaRandomization', 'random');
    } else {
      e.onchange();
    }
  }
}

function randomizeMinimizer(evt) {
  // randomizer the number of locations between 30 and 60.
  // click on random dice: click on mininizer if not already active
  var minimizer = document.getElementById("minimizer");
  var elemId = "minimizerQty"
  var e = document.getElementById(elemId);

  var isActive;
  if(isElemRandom(evt.currentTarget)) {
    evt.currentTarget.className = evt.currentTarget.className.replace(" active", "");
    e.value = 45;
    if(minimizer.checked) {
      disableElement(elemId, false);
    }
  } else {
    setSwitchToOn(minimizer);
    evt.currentTarget.className += " active";
    disableElement(elemId, true);
  }
}

function get_selected_objectives() {
    // return a copy of selected objectives
    return $randomizer.state.objective.slice()
}
function is_limit_objective(objective) {
    return "type" in objectives_exclusions[objective];
}
function get_limit_objective_type(objective) {
    return objectives_exclusions[objective]["type"];
}
function get_limit_objective_limit(objective) {
    return objectives_exclusions[objective]["limit"];
}
function is_count_objective(objective) {
    for (const [key, value] of Object.entries(objectives_types)) {
        if(value.includes(objective)) {
            return true;
        }
    }
    return false;
}
function get_count_objective_type(objective) {
    for (const [key, value] of Object.entries(objectives_types)) {
        if(value.includes(objective)) {
            return key;
        }
    }
}
function is_objective_of_type(objective, type) {
    return objectives_types[type].includes(objective);
}
function get_objectives_count(type, list) {
    var count = 0;
    for(var i=0; i<list.length; i++) {
        if(is_objective_of_type(list[i], type)) {
            count++;
        }
    }
    return count;
}
function is_clear_area_objective(objective) {
    return "tourian" in objectives_exclusions[objective];
}
function setObjectives(objectives) {
    // This will be undefined when loading most preset
    $randomizer.set('objective', objectives || ['kill all G4']);
}

var objectives_exclusions = {{response.write(objectivesExclusions, escape=False)}};
var objectives_types = {{response.write(objectivesTypes, escape=False)}};
var objectives_sort = {{response.write(objectivesSort, escape=False)}};
var objectives_categories = {{response.write(objectivesCategories, escape=False)}};
var removed_objectives = [];


{{
def writeObjectiveList(key):
    value = session.randomizer.get(key, [])
    if isinstance(value, str):
        value = value.split(',')
        pass
    response.write("{}".format(value), escape=False)
    pass
}}


var objectiveBackup = {
    true: {{ writeObjectiveList('objectiveMultiSelect') }},
    false: {{ writeObjectiveList('objective') }},
}
var appIsReady = false;

function randomizeObjective(evt) {
    var isActive;
    var wasRandom = isElemRandom(evt.currentTarget)
    var selectedArray = get_selected_objectives();

    window.$randomizer.objective.setRandom(!wasRandom)
    if(wasRandom) {
        evt.currentTarget.className = evt.currentTarget.className.replace(" active", "");

        // restore previous value
        var backup_values = objectiveBackup.false
        if (backup_values.length === 0) {
            backup_values = ['kill all G4']
        }
        setObjectives(backup_values);
    } else {
        evt.currentTarget.className += " active";
        var backup_values = objectiveBackup.true

        function removeHundreds(array) {
            return array.filter(s => s !== 'collect 100% items' && s !== "explore 100% map");
        }

        var all_objectives = defaultMultiValues.objective.slice();
        all_objectives = removeHundreds(all_objectives)
        if (backup_values.length === 0) {
            backup_values = all_objectives
        }
        if (backup_values.length >= all_objectives.length) {
            backup_values = removeHundreds(backup_values)
        }
        setObjectives(backup_values);
    }
}

function disableElement(id, disable) {
  var elem = document.getElementById(id);
  elem.disabled = disable;
  // grey out the disabled text
  var text = document.getElementById(id+"Text");
  if(elem.disabled) {
      text.className = "disabledText";
  } else {
      text.className = "";
  }
  // tell switchery
  if(id in globalSwitchs) {
    var sw = globalSwitchs[id];
    if(disable) {
      sw.disable();
    } else {
      sw.enable();
    }
  }
}

function getComplexity() {
  tablinks = document.getElementsByClassName("tablinks");
  for (i = 0; i < tablinks.length; i++) {
    if(tablinks[i].className.includes("active")) {
      return tablinks[i].id;
    }
  }
}

function setRandom() {
{{
    for id in ["missileQty", "superQty", "powerBombQty", "minorQty", "energyQty", "majorsSplit", "suitsRestriction", "morphPlacement", "funCombat", "funMovement", "funSuits", "progressionDifficulty", "hideItems", "strictMinors", "progressionSpeed", "areaRandomization", "doorsColorsRando", "bossRandomization", "escapeRando", "startLocation", "minimizerQty", "gravityBehaviour", "scavNumLocs", "tourian"]:
      if id in session.randomizer and session.randomizer[id] == "random":
        response.write("  document.getElementById(\"{}Random\").click();\n".format(id), escape=False)
        if "{}MultiSelect".format(id) in session.randomizer:
          response.write("  $(\"#{}MultiSelect\").val({});\n".format(id, session.randomizer["{}MultiSelect".format(id)]), escape=False)
          pass
        pass
      pass

    for id in ["logic"]:
      if id in session.randomizer and session.randomizer[id] == "random":
        response.write("  document.getElementById(\"{}Random\").click();\n".format(id), escape=False)
        if "{}MultiSelect".format(id) in session.randomizer:
          response.write("  $(\"#{}MultiSelect\").val({});\n".format(id, session.randomizer["{}MultiSelect".format(id)]), escape=False)
          pass
        pass
      pass

}}
}

function initializeState() {
    /* called once when page loads to load values into vue client
       currently handles:
       - objective
       - objectiveRandom
       - tourian
       - majorsSplit
    */
    const data = {{response.write(session.randomizer,escape=False)}}
    $randomizer.init(data);

    if (['0', 'random'].includes(data.objectiveRandom)) {
        document.getElementById('objectiveRandom').click()
    }

    if (['0', 'random'].includes(data.nbObjective)) {
        document.getElementById('nbObjectiveRandom').click()
    } else {
        document.getElementById('nbObjective').value = data.nbObjective
    }

    if (['0', 'random'].includes(data.nbObjectivesRequired)) {
        document.getElementById('nbObjectivesRequiredRandom').click()
    } else {
        document.getElementById('nbObjectivesRequired').value = data.nbObjectivesRequired
    }
}

function setComplexity() {
{{
  if "complexity" in session.randomizer:
    response.write('  document.getElementById("{}").click();'.format(session.randomizer["complexity"]), escape=False)
  else:
    response.write('  document.getElementById("simple").click();', escape=False)
    pass
}}
}

function changeComplexity(evt, name) {
  if(name == "simple") {
    var show = ["noPatchesVisibility"];
    var hide = ["seedVisibility", "itemsQuantityVisibility", "minorsProportionVisibility", "maxDiffVisibility", "progDiffVisibility", "suitsRestrictionVisibility", "morphPlacementVisibility", "superFunVisibility", "patchesVisibility", "hideItemsVisibility", "raceModeVisibility", "escapeRandoVisibility", "helperPatchesVisibility", "objectivesVisibility", "saveLoadRandoPresetVisibility"];
    showHide(show, hide);
  }

  else if(name == "medium") {
    var show = ["maxDiffVisibility", "patchesVisibility", "morphPlacementVisibility", "itemsQuantityVisibility", "nerfedChargeVisibility", "musicVisibility", "escapeRandoVisibility", "objectivesVisibility", "helperPatchesVisibility"];
    var hide = ["seedVisibility", "progDiffVisibility", "suitsRestrictionVisibility", "minorsProportionVisibility", "superFunVisibility", "mainPatchesVisibility", "gravityBehaviourVisibility", "hideItemsVisibility", "raceModeVisibility", "miscVisibility", "noPatchesVisibility", "saveLoadRandoPresetVisibility"];
    showHide(show, hide);
  }

  else {
    var show = ["seedVisibility", "itemsQuantityVisibility", "maxDiffVisibility", "progDiffVisibility", "suitsRestrictionVisibility", "morphPlacementVisibility", "minorsProportionVisibility", "superFunVisibility", "patchesVisibility", "mainPatchesVisibility", "gravityBehaviourVisibility", "hideItemsVisibility", "raceModeVisibility", "nerfedChargeVisibility", "miscVisibility", "musicVisibility", "escapeRandoVisibility", "helperPatchesVisibility", "objectivesVisibility", "saveLoadRandoPresetVisibility"];
    var hide = ["noPatchesVisibility"];
    showHide(show, hide);
  }

  // set current button to active
  tablinks = document.getElementsByClassName("tablinks");
  for (i = 0; i < tablinks.length; i++) {
      tablinks[i].className = tablinks[i].className.replace(" active", "");
  }

  evt.currentTarget.className += " active";
}

function showHide(show, hide) {
  for(var i=0; i<show.length; i++) {
    var showId = show[i];
    var elem = document.getElementById(showId);
    elem.classList.remove("hidden");
  }
  for(var i=0; i<hide.length; i++) {
    var hideId = hide[i];
    var elem = document.getElementById(hideId);
    elem.classList.add("hidden");
  }
}

function getRandomizerParameters(setDisabledToOff, trueJson) {
    var dataDict = {};

    var elems = ["seed", "preset", "raceMode", "removeEscapeEnemies", "nerfedCharge", "itemsounds", "elevators_speed", "fast_doors", "spinjumprestart", "rando_speed", "animals", "No_Music", "randoPreset", "random_music", "maxDifficulty", "Infinite_Space_Jump", "refill_before_save", "minimizer", "allowGreyDoors", "hud", "revealMap", "scavRandomized", "relaxed_round_robin_cf", "hiddenObjectives", "better_reserves"];
    var randomElems = ["missileQty", "superQty", "powerBombQty", "minorQty", "suitsRestriction", "funCombat", "funMovement", "funSuits", "hideItems", "strictMinors", "areaRandomization", "doorsColorsRando", "bossRandomization", "escapeRando", "minimizerQty", "scavNumLocs"];
    var multiElems = ["majorsSplit", "startLocation","energyQty", "morphPlacement", "progressionDifficulty", "progressionSpeed", "gravityBehaviour", "tourian", "areaRandomization"];
    var imgPickers = ["logic"];

    for(var i=0; i<elems.length; i++) {
        if(setDisabledToOff) {
            // if element is disabled set it to off
            var elem = document.getElementById(elems[i]);
            if(elem.disabled == true) {
                dataDict[elems[i]] = "off";
            } else {
                dataDict[elems[i]] = elem.value;
            }
        } else {
            dataDict[elems[i]] = document.getElementById(elems[i]).value;
        }
    }
    for(var i=0; i<randomElems.length; i++) {
       // check if random dice is checked
       if(isElemIdRandom(randomElems[i])) {
         dataDict[randomElems[i]] = "random";
       } else {
         dataDict[randomElems[i]] = document.getElementById(randomElems[i]).value;
       }
    }
    for(var i=0; i<multiElems.length; i++) {
       // check if random dice is checked
       var elemId = multiElems[i];
       if(isElemIdRandom(elemId)) {
         dataDict[elemId] = "random";
         multiElemId = elemId+"MultiSelect";
         if(trueJson) {
             dataDict[multiElemId] = $("#"+multiElemId).val();
         } else {
             dataDict[multiElemId] = $("#"+multiElemId).val().join();
         }
       } else {
         dataDict[elemId] = document.getElementById(elemId).value;
       }
    }
    for(var i=0; i<imgPickers.length; i++) {
       // check if random dice is checked
       var elemId = imgPickers[i];
       if(isElemIdRandom(elemId)) {
         dataDict[elemId] = "random";
         multiElemId = elemId+"MultiSelect";
         if(trueJson) {
             dataDict[multiElemId] = $("#"+elemId).data('picker').selected_values();
         } else {
             dataDict[multiElemId] = $("#"+elemId).data('picker').selected_values().join();
         }
       } else {
         dataDict[elemId] = document.getElementById(elemId).value;
       }
    }

    getSpecialValues(dataDict, trueJson);

    return dataDict;
}

function AjaxPresetCallCompleted(data) {
    console.log("AjaxPresetCallCompleted");

    var dataDict = getRandomizerParameters(true, false);
    dataDict["complexity"] = getComplexity();
    dataDict["paramsFileTarget"] = data;

    // if production server randomly use one of the two redirect webapps
    var prodUrls = ["varia.run", "www.varia.run"];
    var url = "{{=URL(f='randomizerWebService')}}";
    if(isProduction()) {
        url = window.location.protocol+"//"+prodUrls[Math.floor(Math.random() * 2)]+"/randomizerWebService";
    }

    dataDict.wantsCustomize = wantsCustomize

    // call web service with parameters
    var request = $.ajax({
      url: url,
      method: "POST",
      data: dataDict,
      dataType: "json",
      crossDomain: true
    });

    request.done(AjaxRandomizerCallCompleted);
    request.fail(ajaxFailJSON);
}

function isProduction() {
    return window.location.hostname == "randommetroidsolver.pythonanywhere.com";
}

function ajaxFail(jqXHR, textStatus) {
  document.getElementById("flash").innerHTML = jqXHR.responseText;
  $('#flash').show();
  $('#overlay').hide();
  $('#loadingGIF').hide();
}

function ajaxFailJSON(jqXHR, textStatus) {
  // cross domain calls currently return 'undefined' information... (cf. https://www.html5rocks.com/en/tutorials/cors/)
  if(jqXHR.responseJSON == null) {
    document.getElementById("flash").innerHTML = "Something wrong happened or the VARIA randomizer aborted: please try again.";
  } else {
    document.getElementById("flash").innerHTML = jqXHR.responseJSON;
  }
  $('#flash').show();
  $('#overlay').hide();
  $('#loadingGIF').hide();
}

function unpack_3bytes(ips, i) {
  var b1 = ips[i];
  var b2 = ips[i+1];
  var b3 = ips[i+2];
  return (b1*65536) + (b2*256) + b3;
}

function unpack_2bytes(ips, i) {
  var b1 = ips[i];
  var b2 = ips[i+1];
  return (b1*256) + b2;
}

function applyIpsAndDownload(data) {
    // with items/Locations patch the local rom in memory
    // always make a copy to avoid modifying vanilla rom buffer from local storage
    var bytes_temp = new Uint8Array(vanillaROM);
    var bytes = new Uint8Array(bytes_temp.length);
    bytes.set(bytes_temp);

    var binary_string = atob(data["ips"]);
    var len = binary_string.length;
    var ips = new Uint8Array(len);
    for(var i = 0; i < len; i++) {
        ips[i] = binary_string.charCodeAt(i);
    }

    console.log("IPS size: "+ips.length);
    var i = 5;
    var offset = 0;
    var size = 0;
    var rle_size = 0;

    while(i < ips.length - 3) {
        offset = unpack_3bytes(ips, i);
        i += 3;
        size = unpack_2bytes(ips, i);
        i += 2;

        if(size == 0) {
            // RLE
            rle_size = unpack_2bytes(ips, i);
            i += 2;
            for(j=0; j<rle_size; j++) {
                bytes[offset+j] = ips[i];
            }
            i += 1;
        } else {
            for(j=0; j<size; j++) {
                bytes[offset+j] = ips[i+j];
            }
            i += j;
        }
    }

    // fix checksum
    var sum1 = 0;
    for(var i=0; i<0x200000; i++) { sum1 += bytes[i]; }
    var sum2 = 0;
    for(var i=0x200000; i<0x300000; i++) { sum2 += bytes[i]; }
    var sum = (sum1 + (sum2 * 2)) & 0xFFFF;
    var sumlo = sum & 0x00FF;
    var sumhi = (sum & 0xFF00) >> 8;
    var invSum = sum ^ 0xFFFF;
    var invSumlo = invSum & 0x00FF;
    var invSumhi = (invSum & 0xFF00) >> 8;
    bytes[0x7FDC] = invSumlo;
    bytes[0x7FDD] = invSumhi;
    bytes[0x7FDE] = sumlo;
    bytes[0x7FDF] = sumhi;

    var blob = new Blob([bytes], {type: "octet/stream"});

    var outFileName = data['fileName'];
    saveAs(blob, outFileName);
}

function AjaxRandomizerCallCompleted(data) {
    console.log("AjaxRandomizerCallCompleted");

    $('#overlay').hide();
    $('#loadingGIF').hide();

    // info message to display ?
    if("errorMsg" in data && data["errorMsg"].length > 0) {
        document.getElementById("flash").innerHTML = data["errorMsg"];
        $('#flash').show();
    }

    if("status" in data) {
        var status = data["status"];
        if(status != "OK") {
            return;
        }
    } else {
        document.getElementById("flash").innerHTML = "Something wrong happened or the VARIA randomizer aborted: please try again.";
        return;
    }

    if (data["ips"]) {
        // If data is missing ips it is most likely because they hit "Randomize + Customize"
        applyIpsAndDownload(data);
    }

    // add permalink
    if('seedKey' in data) {
        var host = window.location.protocol+"//"+window.location.hostname;
        if(window.location.port.length > 0) {
            host = host+":"+window.location.port;
        }
        var seedKey = data['seedKey'];
        var link = encodeURI(host+"/customizer/"+seedKey);
        document.getElementById("permalink").innerHTML = "<a href=\""+link+"\" target=\"_blank\">"+link+"</a>";
        if (wantsCustomize) {
            var target = link
            if (data['errorMsg']) {
                 target += `?msg=${data['errorMsg']}`
            }
            window.location = target
        }
    }

    // set backup button text to Randomize
    document.getElementById("submitBtn").data = "Randomize";

    var dataDict = getRandomizerParameters(false, false);
    dataDict["complexity"] = getComplexity();

    // call webservice to update the session
    var request = $.ajax({
      url: "{{=URL(f='sessionWebService')}}",
      method: "POST",
      data: dataDict,
      dataType: "html"
    });

    request.fail(ajaxFail);
}

function getSpecialValues(dataDict, trueJson) {
    dataDict["objectiveRandom"] = isElemIdRandom("objective")

    // Note both objective and objectiveMultiSelect are passed via dataDict.objective
    // The backend decides to use this for one or the other
    if(trueJson) {
        var values = get_selected_objectives();
    } else {
        var values = get_selected_objectives().join(",");
    }
    dataDict["objective"] = values ? values : "nothing"
    if (dataDict["objectiveRandom"]) {
        dataDict["objectiveMultiSelect"] = values
    }
    if (isElemIdRandom("nbObjective")) {
        dataDict["nbObjective"] = "random"
    } else {
        dataDict["nbObjective"] = document.getElementById("nbObjective").value
    }
    if (isElemIdRandom("nbObjectivesRequired")) {
        dataDict["nbObjectivesRequired"] = "random"
    } else {
        dataDict["nbObjectivesRequired"] = document.getElementById("nbObjectivesRequired").value
    }

    Object.keys(window.PATCHES).forEach(group_key => {
        const custom_key = group_key + 'Custom'
        // this is an inconsistency in variable name that should be fixed (if possible)
        const backend_key = group_key === 'layout' ? 'layoutPatches' : group_key
        dataDict[backend_key] = 'off'
        dataDict[custom_key] = ''
        if (window.$randomizer.isPatchGroupAllowed(group_key)) {
            dataDict[custom_key] = window.$randomizer.state[custom_key] || []
            dataDict[backend_key] = dataDict[custom_key].length > 0 ? 'on' : 'off'
            if (!trueJson) {
                dataDict[custom_key] = dataDict[custom_key].join(',')
            }
        }
    })
}

function validateObjectives() {
    var values = get_selected_objectives();

    if(isElemIdRandom("objective")) {
        // if objectives are randomized, check that there's at least one in the list
        if(values.length == 0) {
            alert("Objectives are randomized but objectives list is empty");
            return false;
        }
    } else {
        // if not randomized, check that there's max 18 objectives in the list (17 in scav hunt)
        const max = $randomizer.objective.getMax();
        const count = values.length;
        const splits = document.getElementById('majorsSplit').value
        if(values.length > max) {
            alert(`You can only have ${max} objectives for ${splits} (${count} currently selected)`);
            return false
        }
    }
    return true;
}

var wantsCustomize = false

function doSubmit() {
    wantsCustomize = document.activeElement === document.getElementById('customizeBtn')

    if(window.File && window.FileList && window.FileReader) {

        if(vanillaROMStored == false) {
            alert("Please select a Super Metroid Vanilla ROM first");
            return false;
        }

        if(!validateObjectives()) {
            return false;
        }

        var dataDict = {"preset": document.getElementById("preset").value};

        // call preset web service with parameters
        var request = $.ajax({
            url: "{{=URL(f='presetWebService')}}",
            method: "POST",
            data: dataDict,
            dataType: "html"
        });

        request.done(AjaxPresetCallCompleted);
        request.fail(ajaxFail);

        // while WS is working, display "working" message
        $('#overlay').show();
        $('#loadingGIF').show();
    }

    return false;
}

function getRndInteger(max) {
  return Math.floor(Math.random() * max );
}

var tips = [
    "You can display the logic details for a skill preset by loading it on the Presets page",
    "With VARIA tweaks on (default) you can activate Lower Norfair Chozo (left of entrance) without Space Jump",
    "With VARIA tweaks on (default) you can access Wrecked Ship Etank location without killing Phantoon (via Forgotten Highway)",
    "By default Gravity Suit environmental protection (heat, spikes, electricity...) is removed, it balances more the two suits abilities",
    "Creating your own skills preset will lead to a better experience overall, as the generated ROMs will be tailored for you",
    "The skills preset is used by the Randomizer, Solver, Tracker and Plandomizer to know which techniques are available to reach the item locations",
    "Majors split Chozo: Put all the upgrades as well as minimal ammo/energy to finish the seed in the Chozo locations",
    "Majors split Full: All items are shuffled in all locations",
    "Majors split Majors/Minors: Use major (upgrades and energy) and minor (ammo) item pools",
    "Majors split Majors/Minors: High-Jump boots Energy Tank location is considered minor, and right Super Missile in Wrecked ship is considered major for balancing purposes",
    "Use the Full Countdown Majors split to know how many major upgrades are left in the current area using the HUD",
    "Use the Scavenger Majors split, and experience a different mode where you have to follow a given route using the HUD",
    "The VARIA HUD comfort patch will help you keep track of how many actual items there are if you play with non-vanilla ammo/energy or Super Fun settings.",
    "Progression speed setting will have a big impact on seed difficulty. The slower the speed is, the harder the seed will be (usually)",
    "VARIAble progression speed will randomly change internal progression speed while placing items, creating seeds that are more unpredictable",
    "speedrun progression speed is less item hunt oriented, and is well suited for racing",
    "Progression difficulty setting will have a moderate impact on seed difficulty compared to progression speed",
    "In Scavenger mode, the name in the HUD points to the location to go to, not the item to find",
    "Scavenger mode forces speedrun progression speed, but you can change progression difficulty to influence the hunt order",
    "Late Morph is best suited when used along area randomization, to find Morph in peculiar places",
    "For the Late morph setting to work at full power, you must enable Area+Full randomization, and leave Suits Restriction off. If the seed generation fails, just retry.",
    "The Tracker can be use in seedless mode, aka I use my tablet on my couch. Just click 'Init' without picking a seed file",
    "If you're stuck while playing a seed, use the Solver or the Tracker to know where to go next",
    "All generated seeds are MSU-1 compatible",
    "Anti soft-lock layout modification are applied by default",
    "You can use the tracker to track the connections between the areas and avoid getting too lost in area rando",
    "If you play on a platform compatible with QUsb2Snes, try out the auto tracker on the Tracker page",
    "With Boss randomization, the areas or rooms unlocked by the bosses stay unchanged. For example, you still have to kill Phantoon to activate Wrecked Ship.",
    "The aim buttons can be assigned to any button",
    "You can save your own button layout as well as moonwalk option in your skills preset to avoid doing the setup every seed",
    "Using a non-standard or randomized start location will enable all anti-softlock patches and VARIA tweaks",
    "All starting locations come with their layout changes or doors opened, be sure to check them by clicking on '?' next to the option",
    "During randomized escape sequence, your hyper beam can destroy super/bomb/PB blocks, and open all gates",
    "During randomized escape sequence, if you 'forgot' to pick up a suit during your run and cannot escape, you can reload and exit Tourian at any time",
    "During randomized escape sequence, you can find the animals behind a map station door or/and try different escape by going to vanilla animals",
    "Click on the '?' buttons to get help and tutorials in all pages of the VARIA site",
    "You can alter the Suits behaviour in the Advanced tab (Patches section). Choose between Balanced (default), Progressive (like DASH randomizer), and Vanilla.",
    "Tired of looking for Charge beam? Check out the 'Nerfed Charge' patch accessible in Medium and Advanced tabs",
    "Super Fun settings (Advanced tab) do not require any specific skill in your preset. The seeds generated will always be completable.",
    "Check out the Plandository to play plandos published VARIA users, as well as VARIA weekly races seeds/plandos",
    "If you're new to area rando, or don't want to use the tracker, try out Light Area Randomization",
    "In Light Area rando, vanilla area transitions are preserved, only their place is changed",
    "In for a quick play? Try out Boss Rush/Minimizer mode. Load 'minimizer' settings preset to easily set it up",
    "In Minimizer mode, areas and bosses transition are mixed together, and you can make the map as big as you want between 30 and 100 locations",
    "With Doors Colors randomization, all 3 ammo types and all 4 beams (not counting Charge) are distinct keys for locked colored doors",
    "With Doors Colors, Areas Randomization, or non-standard start location, rolling backup saves are enabled. You can safely save in two different save stations even if unsure you can come back.",
    "In Medium/Advanced tabs of the randomizer page, you can access settings to define custom objectives to access Tourian, as well as endgame behaviour with Tourian",
    "'Clear area' objectives mean collecting all items of the current major split in the given areas. They also use the HUD, making them incompatible with Scavenger Hunt",
    "Use Fast Tourian to skip Metroids, Zebetites, and all cutscenes (including Mother Brain 3 fight)",
    "Disabled Tourian setting will trigger the escape sequence as soon as objectives are completed",
    "'activate chozo robots' objective is heavily dependent on VARIA tweaks setting, because they alter Bomb Torizo and Lower Norfair Chozo behavior",
    "When randomizing objectives list, you can also decide to set a fixed number of objectives, or randomize it as well",
    "There is a distinction between 'possible objectives' (the objective list) and 'required objectives' (the number of objectives to complete)",
    "If you choose more than 9 objectives, only 9 will be required",
    "To easily check if something is in logic, use the tracker in seedless mode, give yourself some equipment, and see what locations are available",
    "Press Start+Select+L+R to quickly reload your last save"
];

var myTimer = null;
var curLoadingTips = 0;
var globalSwitchs = {};

function loadTip(first = true) {
    if(first == true) {
      curLoadingTips = 0;
    } else {
      // first fadeout the current one
      var elem = "loadingTips" + curLoadingTips;
      $("#"+elem).fadeOut(1000);
      curLoadingTips = 1 - curLoadingTips;
    }

    var tip = tips[getRndInteger(tips.length)];
    var elem = "loadingTips" + curLoadingTips;
    document.getElementById(elem).innerHTML = tip;
    document.getElementById(elem).style.marginLeft = "-" + tip.length/4 + "em";
    $("#"+elem).fadeIn(1000);
    myTimer = setTimeout(loadTip, 10000, false);
}

function isMobileDevice() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

var vanillaROMStored = false;
var vanillaROM = null;
window.onload = function(){
    //Check File API support
    if(window.File && window.FileList && window.FileReader) {
        var filesInput = document.getElementById("uploadFile");
        filesInput.addEventListener("change", function(event){
            var files = event.target.files; //It returns a FileList object
            var file = files[0];

            var crc32 = new Crc32();

            var reader = new FileReader();
            reader.readAsArrayBuffer(file)
            reader.onload = function(e) {
                var arrayBuffer = e.target.result;
                var bytes = new Uint8Array(arrayBuffer);

                // check sfc or smc extention
                var re = /(?:\.([^.]+))?$/;
                var ext = re.exec(file.name)[1];
                console.log("ext: "+ext)
                if(! (ext === "sfc" || ext === "smc" || ext === "SFC" || ext === "SMC")) {
                    document.getElementById("uploadFile").value = "";
                    alert("wrong extension: "+ext);
                    return false;
                }

                var fileSize = file.size;
                if(fileSize > 4*1024*1024) {
                    document.getElementById("uploadFile").value = "";
                    alert("wrong ROM file size: "+fileSize.toString());
                    return false;
                } else if(fileSize == 3146240) {
                    console.log("headered ROM detected, removing first 512 bytes of the header");
                    var headerSize = 512;
                    bytes = bytes.slice(headerSize);
                }

                crc32.update(bytes);
                var digest = crc32.digest();
                console.log("crc32: "+digest);
                if(digest == "ad2cbf9c") {
                    document.getElementById("uploadFile").value = "";
                    alert("Europe vanilla ROM detected, you need the USA,JP ROM");
                    return false;
                } else if(digest != "d63ed5f8") {
                    document.getElementById("uploadFile").value = "";
                    alert("Non vanilla ROM detected");
                    return false;
                }

                // store file in localforage
                localforage.setItem('vanillaROM', bytes, function(err, value) {
                    if(err != null) {
                        alert("Error detected with local storage: "+err+" Please try again");
                        clearLocalStorage();
                    } else {
                        console.log("vanilla ROM stored in local storage");
                        vanillaROM = value;
                        vanillaROMStored = true;
                        displayROMInput(false);
                    }
                });
            }
        }, false);
    } else {
        alert("This website requires the HTML5 File API, please upgrade your browser to a newer version.");
    }

    function triggerArea(is_on) {
        var patches = document.getElementById("areaLayout");
        var lateMorph = document.getElementById("morphPlacement");
        var suits = document.getElementById("suitsRestriction");
        var escapeRando = document.getElementById("escapeRando");

        if(is_on){
            window.$randomizer.state.areaLayoutCustom = window.PATCHES.areaLayout.map(p => p.id)
            disableElement("areaLayout", false);

            setSwitchToOn(escapeRando);

            // uncheck suits restrictions when late morph + area
            if(lateMorph.options[lateMorph.selectedIndex].text == "late"){
                setSwitchToOff(suits);
            }
        } else {
            window.$randomizer.state.areaLayoutCustom = []
            setSwitchToOff(escapeRando);
            var minimizer = document.getElementById("minimizer");
            setSwitchToOff(minimizer);

            disableElement("areaLayout", true);
        }
    }

    var area = document.getElementById("areaRandomization");
    area.onchange = function(){
        var area = document.getElementById("areaRandomization");
        var is_on = ['light', 'full'].includes(area.value);
        triggerArea(is_on);
        window.$randomizer.set('areaRandomization', area.value);
    };

    area.onchange()

    $('#areaRandomizationMultiSelect').change(e => {
        var values = $('#areaRandomizationMultiSelect').val();
        window.$randomizer.set('areaRandomizationMultiSelect', values);
        var is_on = values.includes('full') || values.includes('light');
        triggerArea(is_on);
    })

    var boss = document.getElementById("bossRandomization");
    boss.onchange = function(){
        if(! boss.checked){
            var minimizer = document.getElementById("minimizer");
            setSwitchToOff(minimizer);
        }
        switchCheckbox("bossRandomization");
    }

    var escapeRando = document.getElementById("escapeRando");
    escapeRando.onchange = function(){
        var escapeRando = document.getElementById("escapeRando");
        var removeEscapeEnemies = document.getElementById("removeEscapeEnemies");

        if(escapeRando.checked){
            disableElement("removeEscapeEnemies", false);
            disableElement("animals", true);
            setSwitchToOn(removeEscapeEnemies);
        } else {
            setSwitchToOff(removeEscapeEnemies);
            disableElement("removeEscapeEnemies", true);
            disableElement("animals", false);
        }
        switchCheckbox("escapeRando");
    }
    if(! escapeRando.checked){
        disableElement("removeEscapeEnemies", true);
    }
    if(escapeRando.checked){
        disableElement("animals", true);
    }

    // uncheck suits restrictions when late morph + area
    var lateMorph = document.getElementById("morphPlacement");
    lateMorph.onchange = function(){
        var lateMorph = document.getElementById("morphPlacement");
        var area = document.getElementById("areaRandomization");
        var suits = document.getElementById("suitsRestriction");

        if(lateMorph.options[lateMorph.selectedIndex].text == "late"){
            if (['light', 'full'].includes(area.value)) {
                setSwitchToOff(suits);
            }
        }
    }

    var progSpeed = document.getElementById("progressionSpeed");
    progSpeed.onchange = function(){
        var progSpeed = document.getElementById("progressionSpeed");
        if(progSpeed.value == 'slow' || progSpeed.value == 'slowest'){
            // set suits restriction only if not area + late morph
            var suitsRestriction = document.getElementById("suitsRestriction");
            var lateMorph = document.getElementById("morphPlacement");
            var area = document.getElementById("areaRandomization");
            if(! suitsRestriction.checked && ! (['light', 'full'].includes(area.value) && lateMorph.options[lateMorph.selectedIndex].text == "late")){
                suitsRestriction.click();
            }
        }
        if(progSpeed.value == 'fast' || progSpeed.value == 'fastest'){
            var suitsRestriction = document.getElementById("suitsRestriction");
            setSwitchToOff(suitsRestriction);
        }
    }

    // change parameters depending on start location value
    var startLocation = document.getElementById("startLocation");
    startLocation.onchange = function(){
        var startLocation = document.getElementById("startLocation");

        var selected = startLocation.value; //startLocation.options[startLocation.selectedIndex].text;
        if(selected != "Ceres" && selected != "Landing Site"){
            var majorsSplit = document.getElementById("majorsSplit");
            var suitsRestriction = document.getElementById("suitsRestriction");

            if(majorsSplit.value == "Scavenger") {
                majorsSplit.value = "Full";
                // changing a value in js doesn't call onchange, so explicitly call it
                majorsSplit.onchange();
            }
            window.$randomizer.setPatches('variaTweaks', 'all')
            window.$randomizer.setPatches('layout', 'all')
            setSwitchToOff(suitsRestriction);
            if(selected == "Red Brinstar Elevator" || selected == "Golden Four") {
                var areaRandomization = document.getElementById("areaRandomization");
                var areaRandom = document.getElementById('areaRandomizationRandom');
                if (isElemRandom(areaRandom)) {
                    const multiselect = $("#areaRandomizationMultiSelect")
                    const val = multiselect.val().filter(v => v !== 'off')
                    if (val.length === 0) {
                        val.append('full')
                    }
                    multiselect.val(val)
                    multiselect.trigger("chosen:updated");
                } else if ($("#areaRandomization").val() === 'off') {
                    $("#areaRandomization").val('full')
                    $("#areaRandomization").change()
                }
                window.$randomizer.setPatches('areaLayout', 'all')
            }
        }
    }

    // race mode is disabled by default
    var text = document.getElementById("raceModeText");
    text.className = "disabledText";

    var raceMode = document.getElementById("raceMode");
    raceMode.onchange = function() {
      var raceMode = document.getElementById("raceMode");
      var text = document.getElementById("raceModeText");
      if(raceMode.checked){
        text.className = "";
      } else {
        text.className = "disabledText";
      }
      switchCheckbox("raceMode");
    }

    // set boss + area rando when minimizer is on
    var minimizer = document.getElementById("minimizer");
    minimizer.onchange = function() {
        var boss = document.getElementById("bossRandomization");
        var tourian = document.getElementById("tourian");

        if(minimizer.checked) {
            setSwitchToOn(boss);
            if ($("#areaRandomization").val() === 'off') {
                $("#areaRandomization").val('full')
                $("#areaRandomization").change()
            }
            disableElement("minimizerQty", false);
            if(tourian.value == "Vanilla") {
                tourian.value = "Fast";
            }
        } else {
            disableElement("minimizerQty", true);
            var minimizerRandom = document.getElementById("minimizerQtyRandom");
            if(isElemRandom(minimizerRandom)) {
                minimizerRandom.className = minimizerRandom.className.replace(" active", "");
            }
        }
        switchCheckbox("minimizer");
    }
    if(minimizer.checked) {
        disableElement("minimizerQty", false);
    } else {
        disableElement("minimizerQty", true);
        var minimizerRandom = document.getElementById("minimizerQtyRandom");
        if(isElemRandom(minimizerRandom)) {
            minimizerRandom.className = minimizerRandom.className.replace(" active", "");
        }
    }

    var tourian = document.getElementById("tourian");
    tourian.onchange = function() {
        $randomizer.set('tourian', tourian.value)
    }
    tourian.onchange();

    var majorsSplit = document.getElementById("majorsSplit");
    majorsSplit.onchange = function() {
        $randomizer.set('majorsSplit', majorsSplit.value);
        var scavengerParams = document.getElementById("scavengerParams");
        if(majorsSplit.value == "Scavenger") {
            scavengerParams.style.display = "block";
            var startLocation = document.getElementById("startLocation");
            if(startLocation.value != "Landing Site") {
                startLocation.value = "Landing Site";
            }
            var progressionSpeed = document.getElementById("progressionSpeed");
            if(progressionSpeed.value != "speedrun") {
                progressionSpeed.value = "speedrun";
            }
            var morphPlacement = document.getElementById("morphPlacement");
            if(morphPlacement.value == "late") {
                morphPlacement.value = "normal";
            }
            var hud = document.getElementById("hud");
            setSwitchToOn(hud);
        } else {
            scavengerParams.style.display = "none";
        }
    }
    majorsSplit.onchange();

    var inputs = document.getElementsByTagName("input");
    for(var i = 0; i < inputs.length; i++) {
        if(inputs[i].type == "checkbox") {
            // progression speed checkboxes don't need switchery, so they don't have a name property
            if(inputs[i].name != "") {
              var s = new Switchery(document.getElementById(inputs[i].name), { size: 'small', color: '#ddd' });
              globalSwitchs[inputs[i].name] = s;
            }
        }
    }

    setComplexity();

    setRandom();

    initializeState();

    // in case we're in nothing objectives

    $("#preset").chosen({ width: '100%' });
    $("#randoPreset").chosen({ width: '100%' });
    resizeChosen();
    if(! isMobileDevice()) {
        // on a mobile device tips take all the screen width, so remove them
        loadTip();
    }

    // check if a vanilla ROM is already in local storage
    localforage.getItem('vanillaROM', function(err, value) {
        if(err != null) {
            clearLocalStorage();
        } else {
            if(value != null) {
                vanillaROMStored = true;
                displayROMInput(false);
                vanillaROM = value;
                vanillaROMStored = true;
            } else {
                clearLocalStorage();
            }
        }
    });

    $("#logic").imagepicker({show_label: true});

    appIsReady = true;
}

function displayROMInput(show) {
    if(show == true) {
        document.getElementById("uploadFileVisibility").style.display = "block";
        document.getElementById("uploadFileOKVisibility").style.display = "none";
    } else {
        document.getElementById("uploadFileVisibility").style.display = "none";
        document.getElementById("uploadFileOKVisibility").style.display = "block";
    }
}

function clearLocalStorage() {
    displayROMInput(true);
    localforage.clear();
    vanillaROMStored = false;
    vanillaROM = null;
}

function switchCheckbox(id, elems=[]) {
  var check = document.getElementById(id);
  if(check.checked){
    check.value = "on";
  } else {
    check.value = "off";
  }

  for(var i=0; i<elems.length; i++){
    disableElement(elems[i], check.checked);
  }
}

function setSwitchToOn(elem) {
    if(appIsReady && ! elem.checked) {
        elem.click();
        elem.value = "on";
    }
}

function setSwitchToOff(elem) {
    if(appIsReady && elem.checked) {
        elem.click();
        elem.value = "off";
    }
}

function saveRandoPresetLocal() {
    // ask user for preset name
    var filename = prompt("What is your randomizer preset name?");
    if(filename == null) {
        return false;
    }

    var data = getRandomizerParameters(false, true);

    var blob = new Blob([JSON.stringify(data, null, 2)], {type: "text/plain"});
    saveAs(blob, filename+'.json');
}

function loadRandoPreset() {
  console.log("loadRandoPreset: "+document.getElementById("randoPreset").value);

  var dataDict = {"randoPreset": document.getElementById("randoPreset").value, "origin": "randomizer"};

  // call web service to update the session with the params from the rando preset and update the parameters in the page
  var request = $.ajax({
      url: "{{=URL(f='randoPresetWebService')}}",
      method: "POST",
      data: dataDict,
      dataType: "json"
  });

  request.done(loadRandoPresetOK);
  request.fail(ajaxFail);
}

function loadRandoPresetLocal() {
    var fileSelector = $('<input type="file" onchange="loadRandoPresetLocalCallbak(event)">');
    fileSelector.click();
}
function loadRandoPresetLocalCallbak(e) {
    var file = e.target.files[0];
    var reader = new FileReader();
    reader.readAsDataURL(file);

    reader.onload = function(readerEvent) {
        var content = readerEvent.target.result;
        (async function () {
            const response = await fetch(content);
            const data = await response.json();
            loadRandoPresetOK(data);
        })();
    }
}

function loadRandoPresetOK(data) {
    // instead of reloading the page which remove the sm ROM, update all fields manually
    for(var key in data) {
        if(key == "objective" || key == "objectiveMultiSelect" || key == "randoPreset") {
            continue;
        }
        value = data[key];
        // console.log("loadRandoPresetOK "+key+": "+value);

        var elem = document.getElementById(key);
        if(elem == null) {
            // in case there's unknown parameter in the json file
            // TODO distributeObjective
            console.log("error loading elem: "+key);
            continue;
        }

        var elemRandom = document.getElementById(key+"Random");
        if(value == "random") {
            // if not already set as random, set it
            if(! isElemRandom(elemRandom)) {
                randomize({currentTarget: elemRandom}, key);
            }
        } else {
            // check if it was random before
            if(elemRandom != null && isElemRandom(elemRandom)) {
                randomize({currentTarget: elemRandom}, key);
            }

            // tell switchery for checkboxes
            if(key in globalSwitchs) {
                if(value != elem.value){
                    elem.click();
                }
            }

            elem.value = value;
            if(chosenElements.includes(key)) {
                $("#"+key).val(value).trigger("chosen:updated");
            }

            if(typeof elem.onchange === "function") {
                elem.onchange();
            }
        }
    }

    // check if multi select has been set by the rando preset, otherwise load default values
    for(var key in defaultMultiValues) {
        if(key == "objective") {
            continue;
        }
        if(! (key+"MultiSelect" in data) ) {
            $("#"+key+"MultiSelect").val(defaultMultiValues[key]).trigger("chosen:updated");
        }
    }

    window.$randomizer.init(data)
    $("select").data('picker').sync_picker_with_select(); // syncs the logic image picker
}

function startTheTour(step=-1) {
  // the tour tutorial
  var tour = new Tour({
    storage: false,
    autoscroll: false,
    steps: [
    {
      element: "#permalinkStep",
      title: "Permanent link",
      content: "Use this permalink to share your seed with other players.<br/><b>Notes:</b> You have to click at least once on the link to activate it, else it won't work after seven days. If you want to retrieve a previous seed (from less than seven days ago) and lost the link, you can search for it at the bottom of <a href=\"/stats\" target=\"_blank\">VARIA usage statistics page</a> (search for your seed number in the page)."
    },
    {
      element: "#romStep",
      title: "Vanilla Super Metroid ROM",
      content: "<p>Use an American/Japan ROM of Super Metroid.<br/>\
The vanilla ROM is stored in the browser local storage and is never sent to our server, all the patching is done locally in the browser.</p>"
    },

    {
      element: "#logicStep",
      title: "Flavor",
      content: "<p>Choose which flavor of Super Metroid you want to randomize:\
<ul>\
<li>Super Metroid: The original vanilla Super Metroid game</li>\
<li>Super Mirrortroid: The map and rooms are mirrored horizontally</li>\
</ul>\
You still provide the vanilla Super Metroid ROM, VARIA handles patching it to the desired flavor.\
</p><p>\
Flavor hacks by BuggMann.</p><p>\
Click on the dice button to randomly set this parameter.</p>"
    },
    {
      element: "#randoPresetStep",
      title: "Settings Preset",
      content: "<p>Choose from a list of typical Randomizer usages. They're independent from skills preset, and settings can still be changed after loading the preset.</p>\
{{
  for categorie, presets in randoPresetsCategories.items():
    response.write('{} presets:\\\n<ul>'.format(categorie), escape=False)
    for preset in presets:
      if preset == "":
        continue
      else:
        response.write('<li>{}: {}</li>\\\n'.format(preset, randoPresetsDesc.get(preset, '')), escape=False)
        pass
      pass
    response.write('</ul>\\\n', escape=False)
    pass
}}"
    },
    {
      element: "#saveLoadRandoPresetStep",
      title: "Save and Load custom Randomizer presets",
      content: "<p>Use the save and load buttons to save your favorite Randomizer parameters on your computer and keep them for later use.</p>"
    },
    {
      element: "#raceStep",
      title: "Race",
      content: "<p>When enabled, makes it difficult to cheat by using a Super Metroid editor like SMILE.</p>\
<p>You won't be able to solve/track a race protected seed on the VARIA website.</p>"
    },
    {
      element: "#seedStep",
      title: "Randomizer seed",
      content: "Choose a seed number between 1 and {{=maxsize}}, choose 0 to generate a random one."
    },
    {
      element: "#presetStep",
      title: "Skills Preset",
      content: "<p>The preset is used by the Randomizer to know which techniques are available to reach items locations.</p>\
<p>You can check which techniques are required as well as create and manage your own preset on the <a href=\"/solver/solver_web/presets\" target=\"_blank\">Presets part of the website</a>.</p>\
<p>Load one of the standard presets (sorted in increased difficulty), tournament presets, or your own from the community presets.</p>\
<p>Creating your own preset will lead to a better experience overall, as the generated ROMs will be tailored for you.</p>\
<p><b>Standard presets outlook:</b><br/><ul>\
<li><b>newbie: </b>New to randomizers, but completed Super Metroid 100% and knows basic techniques (<a href=\"https://wiki.supermetroid.run/Walljump\" target=\"_blank\">Wall Jump</a>, <a href=\"https://wiki.supermetroid.run/Shinespark\" target=\"_blank\">Shinespark</a>, Mid-air Morph)</li>\
<li><b>casual:</b> occasional rando player. No hell runs or <a href=\"https://www.youtube.com/watch?v=G5bB03j5GZc\" target=\"_blank\">suitless Maridia</a>, some easy to learn tricks in logic.</li>\
<li><b>regular: </b>plays rando regularly. Knows tricks that are not too hard and open up the game: hell runs (generous energy requirements), <a href=\"https://www.youtube.com/watch?v=G5bB03j5GZc\" target=\"_blank\">suitless Maridia</a>, <a href=\"https://www.youtube.com/watch?v=pdyBy_54dB0\" target=\"_blank\">lava dive</a>, <a href=\"https://wiki.supermetroid.run/index.php?title=Gate_Glitch\" target=\"_blank\">gate glitches</a>, <a href=\"https://www.youtube.com/watch?v=XSBeLJJafjY\" target=\"_blank\">Alcatraz</a>, <a href=\"https://www.youtube.com/watch?v=uVU2X-egOTI&t=25s\" target=\"_blank\">Gauntlet</a>...</li>\
<li><b>veteran:</b> experienced rando player. Harder everything, some tougher tricks in logic.</li>\
<li><b>expert: </b>knows almost all tricks: <a href=\"https://www.youtube.com/watch?v=Fn2z0ByOcj4\" target=\"_blank\">full suitless Maridia</a>, Lower Norfair hell runs, <a href=\"https://www.youtube.com/watch?v=qmlSDfw8FXQ\" target=\"_blank\">hi-jumpless Lava Dive</a> (mania difficulty only, so not by default in most rando settings)</li>\
<li><b>master:</b> Everything on hardest, all tricks known.</li></ul></p>"
    },
    {
      element: "#tourianStep",
      title: "Endgame Tourian",
      content: "<p>Choose endgame <a href=\"https://metroid.fandom.com/wiki/Tourian\" target=\"_blank\">Tourian</a> behaviour:\
<ul>\
<li><b>Vanilla:</b> regular vanilla <a href=\"https://metroid.fandom.com/wiki/Tourian\" target=\"_blank\">Tourian</a></li>\
<li><b>Fast:</b> speed up <a href=\"https://metroid.fandom.com/wiki/Tourian\" target=\"_blank\">Tourian</a> to skip Metroids, <a href=\"https://metroid.fandom.com/wiki/Zebetite\" target=\"_blank\">Zebetites</a>, and all cutscenes (including Mother Brain 3 fight). <a href=\"https://metroid.fandom.com/wiki/Golden_Statues\" target=\"_blank\">Golden Four statues</a> are replaced by an <a href=\"https://metroid.fandom.com/wiki/Gadora\" target=\"_blank\">invincible Gadora</a> until all objectives are completed.</li>\
<li><b>Disabled:</b> skip <a href=\"https://metroid.fandom.com/wiki/Tourian\" target=\"_blank\">Tourian</a> entirely, ie. escape sequence is triggered as soon as all objectives are completed.</li>\
</ul></p>\
<p>Click on the dice button to randomly set this parameter.</p>"
    },
    {
      element: "#nbObjectivesRequiredStep",
      title: "Number of required objectives",
      content: "<p>Number of objectives to complete from the objectives list. When set to 'all' (default), it will try to match the size of the complete objective list, with a maximum of 9 objectives required.</p>\
<p>Click on the dice button to randomly set this parameter.</p>",
    },
    {
      element: "#nbObjectiveStep",
      title: "Number of possible objectives",
      content: "<p>When objectives are randomized, determine the size of the objective list in game. See 'Number of required objectives' setting help for more information. Maximum possible number is 18.<br><b>Note: </b>The actual number can be lower than requested, due to conflict with other settings.</p>\
<p>Click on the dice button to randomly set this parameter.</p>",
    },
    {
      element: "#hiddenObjectivesStep",
      title: "Hidden Objectives",
      content: "<p>When objectives are randomized, the objective list is hidden in game until you reach the <a href=\"https://metroid.fandom.com/wiki/Golden_Statues\" target=\"_blank\">Golden Statues</a> (or equivalent, depending on Tourian setting).<br>Mostly interesting with area randomization or custom start location settings.</p>",
    },
    {
      element: "#objectiveStep",
      title: "Custom Objectives",
      content: "<p>Choose which objectives are required to sink the <a href=\"https://metroid.fandom.com/wiki/Golden_Statues\" target=\"_blank\">Golden Four statue</a> and to open access to <a href=\"https://metroid.fandom.com/wiki/Tourian\" target=\"_blank\">Tourian</a>.</p>\
<p>You can choose from 0 to 18 objectives (17 if Majors Split is Scavenger Hunt):\
<p><b>Bosses:</b>\
<ul>\
<li>Kill Kraid: kill boss <a href=\"https://metroid.fandom.com/wiki/Kraid\" target=\"_blank\">Kraid</a> (vanilla)</li>\
<li>Kill Phantoon: kill boss <a href=\"https://metroid.fandom.com/wiki/Phantoon\" target=\"_blank\">Phantoon</a> (vanilla)</li>\
<li>Kill Draygon: kill boss <a href=\"https://metroid.fandom.com/wiki/Draygon\" target=\"_blank\">Draygon</a> (vanilla)</li>\
<li>Kill Ridley: kill boss <a href=\"https://metroid.fandom.com/wiki/Ridley\" target=\"_blank\">Ridley</a> (vanilla)</li>\
<li>Kill one G4: kill any G4</li>\
<li>Kill two G4: kill two G4, you can add one namely</li>\
<li>Kill three G4: kill three G4, you can add up to two namely</li>\
<li>Kill all G4: \"meta\" objective, kill Kraid & Phantoon & Draygon & Ridley</li>\
</ul></p>\
<p><b>Minibosses:</b><ul>\
<li>Kill Spore Spawn: kill mini boss <a href=\"https://metroid.fandom.com/wiki/Spore_Spawn\" target=\"_blank\">Spore Spawn</a></li>\
<li>Kill Crocomire: kill mini boss <a href=\"https://metroid.fandom.com/wiki/Crocomire\" target=\"_blank\">Crocomire</a></li>\
<li>Kill Botwoon: kill mini boss <a href=\"https://metroid.fandom.com/wiki/Botwoon\" target=\"_blank\">Botwoon</a></li>\
<li>Kill Golden Torizo: kill mini boss <a href=\"https://metroid.fandom.com/wiki/Golden_Torizo\" target=\"_blank\">Golden Torizo</a></li>\
<li>Kill one Mini Boss: kill any Mini Boss</li>\
<li>Kill two Mini Bosses: kill two Mini Bosses, you can add one namely</li>\
<li>Kill three Mini Bosses: kill three Mini Bosses, you can add up to two namely</li>\
<li>Kill all Mini Bosses: \"meta\" objective, kill Spore Spawn & Crocomire & Botwoon & Golden Torizo</li>\
</ul></p>\
<p><b>Items:</b><ul>\
<li>Collect 25% items: collect 25% of available items</li>\
<li>Collect 50% items: collect 50% of available items</li>\
<li>Collect 75% items: collect 75% of available items</li>\
<li>Collect 100% items: collect 100% of available items</li>\
<li>Collect all upgrades: collect all available suit upgrades (all items but energy/ammo)</li>\
<li>Clear 'area': collect all available items <b>of the current major split</b> in 'area'. Forces 'VARIA HUD' on to see how many are left in each area. <b>Incompatible with Scavenger Hunt and Disabled Tourian.</b></li>\
</ul></p>\
<p><b>Map:</b><ul>\
<li>Explore 25% map: explore 25% of available map tiles</li>\
<li>Explore 50% map: explore 50% of available map tiles</li>\
<li>Explore 75% map: explore 75% of available map tiles</li>\
<li>Explore 100% map: explore 100% of available map tiles</li>\
<li>Explore 'area': explore all map tiles in 'area'.</li>\
</ul>Forces 'Reveal Map' on to see how many are left in each area.</p>\
<p><b>Memes:</b><ul>\
<li>Tickle the Red Fish: use grapple on the <a href=\"https://wiki.supermetroid.run/Red_Fish_Room\" target=\"_blank\">Red Fish</a></li>\
<li>Kill the orange Geemer: kill the orange Geemer that follows you on the little bridge before <a href=\"https://wiki.supermetroid.run/Bowling_Alley\">Bowling Alley</a></li>\
<li>Kill Shaktool: pay a \"visit\" to <a href=\"https://wiki.supermetroid.run/Shaktool_Room\">Shaktool</a></li>\
<li>Activate Chozo robots: kill <a href=\"https://wiki.supermetroid.run/Bomb_Torizo_Room\">Bomb Torizo</a>, <a href=\"https://wiki.supermetroid.run/Golden_Torizo%27s_Room\">Golden Torizo</a>, activate the <a href=\"https://wiki.supermetroid.run/Acid_Statue_Room\">Lower Norfair Chozo</a>, and the <a href=\"https://wiki.supermetroid.run/Bowling_Alley\">Bowling Chozo</a> (note: VARIA tweaks being enabled or not changes Bomb Torizo and Lower Norfair Chozo requirements considerably, check the option's help for more information)</li>\
<li>Visit the animals: go visit the <a href=\"https://wiki.supermetroid.run/Green_Brinstar_Main_Shaft\">Etecoons</a> and the <a href=\"https://wiki.supermetroid.run/Dachora_Room\">Dachora</a></li>\
<li>Kill King Cacatac: kill the most evil boss of Super Metroid, contemplating its subjects from the top of <a href=\"https://wiki.supermetroid.run/Bubble_Mountain\">Bubble Mountain</a></li>\
</ul></p>\
</p><p>\
<b>Note:</b> If you leave the list empty no objective is required to access Tourian, ie. it's open.<br/>\
<b>Note:</b> See the Tourian parameter to enable fast Tourian or trigger the escape when all objectives are completed.<br/>\
<b>Note:</b> Current percentage of collected items is displayed in the inventory pause menu.<br/>\
<b>Note:</b> 100% items and 100% map are excluded by default when randomizing the objectives list as they cover too much of the other objectives.\
</p>\
<p>Click on the dice button to randomize custom objectives. You can choose which objectives are available for the randomizer to choose from. The randomizer will choose between 1 and 18 objectives from the list (between 1 and 17 if Scavenger Hunt). To know the list of randomized objectives in-game a new pause screen has been added:<br/><img src=\"/solver/static/images/help/objectives.png\" alt=\"objectives.png\" title=\"objectives.png\"/></p>"
    },
    {
      element: "#StartLocationStep",
      title: "Start location",
      content: "<p>Choose where you want to start the game:\
<table class=\"full\">\
<tr>\
<td><a href=\"https://wiki.supermetroid.run/Red_Brinstar_Elevator_Room\" target=\"_blank\">Red Brinstar elevator</a> top door is always blue:</td><td><img src=\"/solver/static/images/help/red_bt_blue_door.png\" alt=\"Red Brinstar blue door\" title=\"Red Brinstar blue door\" class=\"full\"/></td><td></td>\
</tr>\
<tr>\
<tr><td colspan=3 class=\"blankLastRow\"></td></tr>\
<th>Start location</th><th colspan=\"2\">Layout modification</th>\
</tr>\
<tr>\
<td><a href=\"https://wiki.supermetroid.run/Ceres_Elevator_Room\" target=\"_blank\">Ceres Station</a></td><td><a href=\"https://wiki.supermetroid.run/Construction_Zone\" target=\"_blank\">Blue Brinstar</a> blue door</td><td></td>\
</tr>\
<tr>\
<td><img src=\"/solver/static/images/help/ceres_start.png\" alt=\"Ceres\" title=\"Ceres\" class=\"full\"/></td><td><img src=\"/solver/static/images/help/blue_bt_blue_door.png\" alt=\"Blue Brinstar blue door\" title=\"Blue Brinstar blue door\" class=\"full\"/></td><td></td>\
</tr>\
<tr>\
<td><a href=\"https://wiki.supermetroid.run/Landing_Site\" target=\"_blank\">Landing Site</a></td><td><a href=\"https://wiki.supermetroid.run/Construction_Zone\" target=\"_blank\">Blue Brinstar</a> blue door</td><td></td>\
</tr>\
<tr>\
<td><img src=\"/solver/static/images/help/landing_site_start.png\" alt=\"Landing Site\" title=\"Landing Site\" class=\"full\"/></td><td><img src=\"/solver/static/images/help/blue_bt_blue_door.png\" alt=\"Blue Brinstar blue door\" title=\"Blue Brinstar blue door\" class=\"full\"/></td><td></td>\
</tr>\
<tr>\
<td><a href=\"https://wiki.supermetroid.run/Green_Pirates_Shaft\" target=\"_blank\">Gauntlet Top</a></td><td>Position to access both items</td><td></td>\
</tr>\
<tr>\
<td><img src=\"/solver/static/images/help/gauntlet_start.png\" alt=\"Gauntlet\" title=\"Gauntlet\" class=\"full\"/></td><td><img src=\"/solver/static/images/help/gauntlet_position.png\" alt=\"Gauntlet\" title=\"Gauntlet\" class=\"full\"/></td><td></td>\
</tr>\
<tr>\
<td><a href=\"https://wiki.supermetroid.run/Green_Brinstar_Main_Shaft\" target=\"_blank\">Green Brinstar Elevator</a></td><td><a href=\"https://wiki.supermetroid.run/Early_Supers_Room\" target=\"_blank\">Brinstar reserve</a> blue door</td><td><a href=\"https://wiki.supermetroid.run/Brinstar_Reserve_Tank_Room\" target=\"_blank\">Brinstar reserve</a> blue door</td>\
</tr>\
<tr>\
<td><img src=\"/solver/static/images/help/green_bt_elevator_start.png\" alt=\"Green Brinstar Elevator\" title=\"Green Brinstar Elevator\" class=\"full\"/></td><td><img src=\"/solver/static/images/help/bt_reserve_blue_door1.png\" alt=\"Brinstar reserve blue door\" title=\"Brinstar reserve blue door\" class=\"full\"/></td><td><img src=\"/solver/static/images/help/bt_reserve_blue_door2.png\" alt=\"Brinstar reserve blue door\" title=\"Brinstar reserve blue door\" class=\"full\"/></td>\
</tr>\
<tr>\
<td><a href=\"https://wiki.supermetroid.run/Big_Pink\" target=\"_blank\">Big Pink</a></td><td></td><td></td>\
</tr>\
<tr>\
<td><img src=\"/solver/static/images/help/big_pink_start.png\" alt=\"Big Pink\" title=\"Big Pink\" class=\"full\"/></td><td></td><td></td>\
</tr>\
<tr>\
<td><a href=\"https://wiki.supermetroid.run/Etecoon_Super_Room\" target=\"_blank\">Etecoons Supers</a></td><td><a href=\"https://wiki.supermetroid.run/Etecoon_Energy_Tank_Room\" target=\"_blank\">Etecoons Super</a> blue door</td><td></td>\
</tr>\
<tr>\
<td><img src=\"/solver/static/images/help/etecoons_supers_start.png\" alt=\"Etecoons Supers\" title=\"Etecoons Supers\" class=\"full\"/></td><td><img src=\"/solver/static/images/help/etecoons_blue_door.png\" alt=\"Etecoons Super blue door\" title=\"Etecoons Super blue door\" class=\"full\"/></td><td></td>\
</tr>\
<tr>\
<td><a href=\"https://wiki.supermetroid.run/Wrecked_Ship_Main_Shaft\" target=\"_blank\">Wrecked Ship Main</a></td><td><a href=\"https://wiki.supermetroid.run/Sponge_Bath\" target=\"_blank\">Sponge Bath</a> blue door</td><td></td>\
</tr>\
<tr>\
<td><img src=\"/solver/static/images/help/wrecked_ship_start.png\" alt=\"Wrecked Ship Main\" title=\"Wrecked Ship Main\" class=\"full\"/></td><td><img src=\"/solver/static/images/help/sponge_bath_blue_door.png\" alt=\"Sponge Bath blue door\" title=\"Sponge Bath blue door\" class=\"full\"/></td><td></td>\
</tr>\
<tr>\
<td><a href=\"https://wiki.supermetroid.run/Lower_Norfair_Escape_Power_Bomb_Room\" target=\"_blank\">Firefleas Top</a> (heat removed)</td><td><a href=\"https://wiki.supermetroid.run/Fune\" target=\"_blank\">Fune</a> removed</td><td>Shot blocks at save station</td>\
</tr>\
<tr>\
<td><img src=\"/solver/static/images/help/firefleas_top_start.png\" alt=\"Firefleas Top\" title=\"Firefleas Top\" class=\"full\"/></td><td><img src=\"/solver/static/images/help/fune_removed.png\" alt=\"Fune removed\" title=\"Fune removed\" class=\"full\"/></td><td><img src=\"/solver/static/images/help/firefleas_shot_blocks.png\" alt=\"Firefleas shot blocks\" title=\"Firefleas shot blocks\" class=\"full\"/></td>\
</tr>\
<tr>\
<td><a href=\"https://wiki.supermetroid.run/Business_Center\" target=\"_blank\">Business Center</a></td><td><a href=\"https://wiki.supermetroid.run/Hi_Jump_Energy_Tank_Room\" target=\"_blank\">Hi-Jump area</a> blue door</td><td></td>\
</tr>\
<tr>\
<td><img src=\"/solver/static/images/help/business_center_start.png\" alt=\"Business Center\" title=\"Business Center\" class=\"full\"/></td><td><img src=\"/solver/static/images/help/hijump_blue_door.png\" alt=\"Hi-Jump area blue door\" title=\"Hi-Jump area blue door\" class=\"full\"/></td><td></td>\
</tr>\
<tr>\
<td><a href=\"https://wiki.supermetroid.run/Bubble_Mountain\" target=\"_blank\">Bubble Mountain</a></td><td><a href=\"https://wiki.supermetroid.run/Bat_Cave\" target=\"_blank\">Speed area</> blue door</td><td><a href=\"https://wiki.supermetroid.run/Speed_Booster_Hall\" target=\"_blank\">Speed area</a> blue door</td>\
</tr>\
<tr>\
<td><img src=\"/solver/static/images/help/bubble_mountain_start.png\" alt=\"Bubble Mountain\" title=\"Bubble Mountain\" class=\"full\"/></td><td><img src=\"/solver/static/images/help/speed_blue_door1.png\" alt=\"Speed area blue door\" title=\"Speed area blue door\" class=\"full\"/></td><td><img src=\"/solver/static/images/help/speed_blue_door2.png\" alt=\"Speed area blue door\" title=\"Speed area blue door\" class=\"full\"/></td>\
</tr>\
<tr>\
<td><a href=\"https://wiki.supermetroid.run/Mama_Turtle_Room\" target=\"_blank\">Mama Turtle</a></td><td><a href=\"https://wiki.supermetroid.run/Fish_Tank\" target=\"_blank\">Mama Turtle</a> blue door</td><td></td>\
</tr>\
<tr>\
<td><img src=\"/solver/static/images/help/mama_turtle_start.png\" alt=\"Mama Turtle\" title=\"Mama Turtle\" class=\"full\"/></td><td><img src=\"/solver/static/images/help/mama_turtle_blue_door.png\" alt=\"Mama Turtle blue door\" title=\"Mama Turtle blue door\" class=\"full\"/></td><td></td>\
</tr>\
<tr>\
<td><a href=\"https://wiki.supermetroid.run/Watering_Hole\" target=\"_blank\">Watering Hole</a></td><td><a href=\"https://wiki.supermetroid.run/Glass_Tunnel\" target=\"_blank\">Maridia tube</a> opened</td><td></td>\
</tr>\
<tr>\
<td><img src=\"/solver/static/images/help/watering_hole_start.png\" alt=\"Watering Hole\" title=\"Watering Hole\" class=\"full\"/></td><td><img src=\"/solver/static/images/help/maridia_tube_opened.png\" alt=\"Maridia tube opened\" title=\"Maridia tube opened\" class=\"full\"/></td><td></td>\
</tr>\
<tr>\
<td><a href=\"https://wiki.supermetroid.run/Aqueduct\" target=\"_blank\">Aqueduct</a></td><td><a href=\"https://wiki.supermetroid.run/Aqueduct_Save_Room\" target=\"_blank\">Aqueduct Save</a> blue door</td><td></td>\
</tr>\
<tr>\
<td><img src=\"/solver/static/images/help/aqueduct_start.png\" alt=\"Aqueduct\" title=\"Aqueduct\" class=\"full\"/></td><td><img src=\"/solver/static/images/help/aqueduct_save_blue.png\" alt=\"Aqueduct Save door\" title=\"Aqueduct Save door\" class=\"full\"/></td><td></td>\
</tr>\
<tr>\
<td><a href=\"https://wiki.supermetroid.run/Red_Tower_Elevator_Room\" target=\"_blank\">Red Brinstar Elevator</a></td><td><a href=\"https://wiki.supermetroid.run/Hellway\" target=\"_blank\">Hellway</a> blue door</td><td><a href=\"https://wiki.supermetroid.run/Alpha_Power_Bomb_Room\" target=\"_blank\">Alpha Power Bomb</a> blue door</td>\
</tr>\
<tr>\
<td><img src=\"/solver/static/images/help/red_bt_elevator_start.png\" alt=\"Red Brinstar Elevator\" title=\"Red Brinstar Elevator\" class=\"full\"/></td><td><img src=\"/solver/static/images/help/hellway_blue_door.png\" alt=\"Hellway blue door\" title=\"Hellway blue door\" class=\"full\"/></td><td><img src=\"/solver/static/images/help/alpha_pb_blue_door.png\" alt=\"Alpha Power Bomb blue door\" title=\"Alpha Power Bomb blue door\" class=\"full\"/></td>\
</tr>\
<tr>\
<td><a href=\"https://wiki.supermetroid.run/Statues_Hallway\" target=\"_blank\">Golden Four</a></td><td></td><td></td>\
</tr>\
<tr>\
<td><img src=\"/solver/static/images/help/golden_four_start.png\" alt=\"Golden Four\" title=\"Golden Four\" class=\"full\"/></td><td></td><td></td>\
</tr>\
</table>\
</p>\
<p>Patches developed by Flo.</p>"
    },
    {
      element: "#majorsSplitStep",
      title: "Majors Split",
      content: "<p>Choose how you want to split Majors and Minors items:\
<ul><li><b>Full</b>: All items are shuffled in all locations</li>\
<li><b>Full Countdown</b>: Randomize like Full and display in the HUD the number of remaining unique upgrades (everything but energy and ammo) in the current area. See \"VARIA HUD\" comfort patch help in the advanced tab for more information about it.</li>\
<li><b>Majors/Minors</b>: Use major (unique upgrades and energy) and minor (ammo) item pools.</p><p><b>Note:</b> <a href=\"https://wiki.supermetroid.run/Hi_Jump_Energy_Tank_Room\" target=\"_blank\">High-Jump boots Energy Tank location</a> is considered minor, and <a href=\"https://wiki.supermetroid.run/Wrecked_Ship_East_Super_Room\" target=\"_blank\">right Super Missile in Wrecked ship</a> is considered major to balance the number of major items between Norfair and Wrecked Ship.</li>\
<li><b>Chozo</b>: Put all unique upgrades as well as minimal ammo/energy to finish the seed in the Chozo locations. These are <a href=\"https://metroid.fandom.com/wiki/Chozo_Statue\" target=\"_blank\">Chozo statues</a>, <a href=\"https://wiki.supermetroid.run/Morph_Ball_Room\" target=\"_blank\">Morph Ball</a> and boss item locations (<a href=\"https://wiki.supermetroid.run/Wrecked_Ship_East_Super_Room\" target=\"_blank\">Right Super in Wrecked Ship</a>, <a href=\"https://wiki.supermetroid.run/Varia_Suit_Room\" target=\"_blank\">Varia Suit</a>, <a href=\"https://wiki.supermetroid.run/Ridley_Tank_Room\" target=\"_blank\">Ridley ETank</a>). Depending on progression speed and item distribution settings, you will be able to <a href=\"https://metroid.fandom.com/wiki/Sequence_Breaking\" target=\"_blank\">'sequence break'</a> by going to other locations as well.</li>\
<li><b>Scavenger</b>: You must visit a given number of locations in a mandatory order in a scavenger hunt, and collect items there. The scavenger locations are the 16 locations where a unique upgrade is in the vanilla game, plus <a href=\"https://wiki.supermetroid.run/Ridley\" target=\"_blank\">Ridley</a>. By default items in the mandatory locations will be vanilla. Other unique upgrades will be randomized between the remaining scavenger locations, and can be collected at any time. By default, you will have to collect all items in the mandatory locations to access <a href=\"https://metroid.fandom.com/wiki/Tourian\" target=\"_blank\">Tourian</a> (on top of finishing other objectives). You can also choose to trigger the escape immediately after the hunt is over by setting Tourian parameter to 'Disabled'.<br/>The next mandatory location will be displayed in the HUD, and the whole route will be displayed in the HUD during pause (see \"VARIA HUD\" comfort patch help in the advanced tab for more information).</li></ul></p>\
<p>Check the map for the list of Majors, Chozo and Scavenger locations and items:<br/><a href=\"/solver/static/images/help/chozo_map.png\" class=\"highslide\" onclick=\"return hs.expand(this, {wrapperClassName: 'borderless', dimmingOpacity: 0.75, align: 'center'})\"><div class=\"parent-center\"><img id=\"chozoThumb\" src=\"/solver/static/images/help/chozo_map_thumbnail.png\" alt=\"Chozo Map\" title=\"Click to enlarge\" class=\"child-center half\"/></div></a></p>\
<p>Using a non-standard or randomized start location and any other split than 'Full' will enable the VARIA HUD, as Major/Chozo locations are slightly modified depending on the start location.</p>\
<p>Click on the dice button to randomly set this parameter.</p>"
    },
    {
      element: "#scavNumLocsStep",
        title: "Mandatory locations to visit",
      content: "You can choose between 4 and 17 major locations to be included in the scavenger hunt, 10 being the default.<br/><a href=\"https://wiki.supermetroid.run/Ridley\" target=\"_blank\">Ridley</a> is a scavenger hunt location.<br/>Click on the dice button to randomize the quantity of major locations."
    },
    {
      element: "#scavRandomizedStep",
        title: "Randomize items in mandatory scavenger hunt locations",
      content: "By default items in scavenger hunt locations are vanilla, you can decide to also randomize what items will be in the mandatory locations."
    },
    {
      element: "#maxDifficultyStep",
      title: "Maximum difficulty for picking up an item",
      content: "<p>Depending on the perceived difficulties of the techniques, bosses, hell runs etc. from the preset, it will prevent the Randomizer from placing an item in a location too difficult to reach with the current items.</p><p><b>Warning:</b> if too low may cause the randomizer to up the difficulty for some boss fight.</p>"
    },
    {
      element: "#progSpeedStep",
      title: "Progression speed",
      content: "<p>A progression item can be a suit, a movement item, or any item that opens up new locations. This parameter influences how fast progression items are likely to be found.<br/>\
Standard speeds go from <b>slowest</b>, stuffing your way with as many non-progression items as possible, to <b>fastest</b>, where you will be able to visit <a href=\"https://metroid.fandom.com/wiki/Zebes\" target=\"_blank\">Zebes</a> pretty shortly.</p><p><b>VARIAble</b> speed will randomly change internal progression speed while placing items, creating seeds that are more unpredictable.</p><p>You can also pick <b>basic</b>, in which case VARIA will place the items exactly like Dessyreqt Randomizer, or Total Randomizer in its Normal/Casual setting (ie: front fill placement).</p>\
<p>The <b>speedrun</b> progression speed uses a random fill algorithm, which allows for a more uniform placement of items. Good setting for racing, item hunts are less likely.</p>\
<p>Click on the dice button to access <b>random progression speed</b> mode where you can choose on which progression speeds the randomization will take place.</p>\
<p><b>Note:</b> usually, slower settings will result in more difficult seeds, and faster settings in easier seeds. Basic progression speed usually results in easy/fast seeds, but not always.</p>"
    },
    {
      element: "#progDiffStep",
      title: "Progression difficulty",
      content: "<p>This parameter influences the choice of the next location. It uses the perceived difficulties from the preset to compute the difficulty to reach the locations. Then if <b>easier</b> or <b>harder</b> is selected, the easiest or hardest location will have a higher chance of being chosen.<br/>Set it to <b>normal</b> for the Randomizer to randomly choose the next location.</p><p><b>Note:</b> this setting has less of an influence on actual seed difficulty than Progression Speed.</p><p>Click on the dice button to randomly set this parameter.</p>"
    },
    {
      element: "#morphPlacementStep",
      title: "Morph Placement",
      content: "<p>Influences where VARIA will place <a href=\"https://metroid.fandom.com/wiki/Morph_Ball\" target=\"_blank\">Morphing Ball</a>:<ul>\
<li><b>early</b> (default): Morph will be placed as soon as possible</li>\
<li><b>normal</b>: Morph will be placed randomly</li>\
<li><b>late</b>: Prevents Morph to be placed in the first available locations of the game. Best suited when used along area randomization, to find Morph in peculiar places.<br/>\
<b>Warning: </b>In Chozo Majors Split, or when using a non-standard or randomized start location, <b>late</b> will be replace by <b>normal</b></li></ul></p>\
<p>Click on the dice button to randomly set this parameter.</p>"
    },
    {
      element: "#suitsRestrictionStep",
      title: "Suits restriction",
      content: "<p>Prevent Gravity <img src=\"/solver/static/images/tracker/inventory/Gravity.png\" alt=\"Gravity.png\" title=\"Gravity.png\" class=\"width: 32px\"/> or Varia <img src=\"/solver/static/images/tracker/inventory/Varia.png\" alt=\"Varia.png\" title=\"Varia.png\" class=\"width: 32px\"/> suits to be placed early in the game (<a href=\"https://metroid.fandom.com/wiki/Crateria\" target=\"_blank\">Crateria</a>/Blue <a href=\"https://metroid.fandom.com/wiki/Brinstar\" target=\"_blank\">Brinstar</a>). Using a non-standard or randomized start location will force this setting off.</p><p>Click on the dice button to randomly set this parameter.</p>"
    },
    {
      element: "#hideItemsStep",
      title: "Hide Items",
      content: "<p>Hides half of the visible items.<br/>Items always visible:<ul>\
<li><a href=\"https://wiki.supermetroid.run/Gauntlet_Energy_Tank_Room\" target=\"_blank\">Energy Tank, Gauntlet</a></li>\
<li><a href=\"https://wiki.supermetroid.run/Terminator_Room\" target=\"_blank\">Energy Tank, Terminator</a></li>\
<li><a href=\"https://wiki.supermetroid.run/Morph_Ball_Room\" target=\"_blank\">Morphing Ball</a></li>\
<li><a href=\"https://wiki.supermetroid.run/The_Moat\" target=\"_blank\">Missile (Crateria moat)</a></li>\
<li><a href=\"https://wiki.supermetroid.run/Early_Supers_Room\" target=\"_blank\">Missile (green Brinstar below super missile)</a></li>\
<li><a href=\"https://wiki.supermetroid.run/Crocomire_Escape\" target=\"_blank\">Missile (above Crocomire)</a></li>\
<li><a href=\"https://wiki.supermetroid.run/Lower_Norfair_Escape_Power_Bomb_Room\" target=\"_blank\">Power Bomb (lower Norfair above fire flea room)</a></li>\
<li><a href=\"https://wiki.supermetroid.run/Bowling_Alley\" target=\"_blank\">Missile (Gravity Suit)</a></li>\
<li><a href=\"https://wiki.supermetroid.run/Main_Street\" target=\"_blank\">Missile (green Maridia shinespark)</a></li></ul></p>\
<p>Click on the dice button to randomly set this parameter.</p>"
    },
    {
      element: "#minorQtyStep",
      title: "Percentage of Ammunition available",
      content: "<p>From 7%: minimum number of ammunition required to finish the game to 100%: all ammunition locations contain an ammo (vanilla like).</p><p>Click on the dice button to randomly set this parameter.</p>"
    },
    {
      element: "#energyQtyStep",
      title: "Quantity of Energy/Reserve Tanks available",
      content: "<p>Choose how many Energy <img src=\"/solver/static/images/tracker/inventory/ETank.png\" class=\"width: 32px\"/> / Reserve Tanks <img src=\"/solver/static/images/tracker/inventory/Reserve.png\" class=\"width: 32px\"/> will be available, from 0-1 in ultra sparse, 4-6 in sparse, 8-12 in medium and 18 in vanilla.</p>\
<p>In ultra sparse <a href=\"https://metroid.fandom.com/wiki/Mother_Brain\" target=\"_blank\">Mother Brain's</a> <a href=\"https://metroid.fandom.com/wiki/Laser_Brain_Attack\" target=\"_blank\">rainbow beam</a> only does 20 damage instead of 300.</p><p>Click on the dice button to randomly set this parameter.</p>"
    },
    {
      element: "#missileQtyStep",
      title: "Distribution of <img src=\"/solver/static/images/tracker/inventory/Missile.png\" class=\"width: 32px\"/>/<img src=\"/solver/static/images/tracker/inventory/Super.png\" class=\"width: 32px\"/>/<img src=\"/solver/static/images/tracker/inventory/PowerBomb.png\" class=\"width: 32px\"/>",
      content: "<p>For each ammo types, the higher the number relative to other proportions the higher the probability of choosing it when placing an ammo.</p>\
<p>For example with default distribution of <img src=\"/solver/static/images/tracker/inventory/Missile.png\" class=\"width: 32px\"/>: 3, <img src=\"/solver/static/images/tracker/inventory/Super.png\" class=\"width: 32px\"/>: 2 and <img src=\"/solver/static/images/tracker/inventory/PowerBomb.png\" class=\"width: 32px\"/>: 1 the randomizer will place a <img src=\"/solver/static/images/tracker/inventory/Missile.png\" class=\"width: 32px\"/> 3 times out of 6, a  <img src=\"/solver/static/images/tracker/inventory/Super.png\" class=\"width: 32px\"/> 2 times out of 6 and a <img src=\"/solver/static/images/tracker/inventory/PowerBomb.png\" class=\"width: 32px\"/> 1 time out of 6.</p>\
<p>Click on the dice button to randomly set this parameter.</p>"
    },
    {
      element: "#strictMinorsStep",
      title: "Strict Ammunition distribution",
      content: "<p>Instead of using ammunition proportions as probabilities, enforce a strict distribution to match the proportions as exactly as possible. Use it when you want to mimick vanilla distribution (<img src=\"/solver/static/images/tracker/inventory/Missile.png\" class=\"width: 32px\"/> 4.6 / <img src=\"/solver/static/images/tracker/inventory/Super.png\" class=\"width: 32px\"/> 1 / <img src=\"/solver/static/images/tracker/inventory/PowerBomb.png\" class=\"width: 32px\"/> 1).</p><p>Click on the dice button to randomly set this parameter.</p>"
    },
    {
      element: "#areaRandomizationStep",
      title: "Areas randomization",
      content: "<p>Randomize areas together using bidirectional access portals.</p>\
<p><b>Off:</b> No change. All rooms are connected the same as in the original game.</p>\
<p><b>Full:</b> All doors connecting the areas will be randomized.</p>\
<p><b>Light:</b> We keep the same number of transitions between areas as in vanilla.<br/>\
So <a href=\"https://metroid.fandom.com/wiki/Crocomire\" target=\"_blank\">Crocomire</a> area will always be connected to Upper <a href=\"https://metroid.fandom.com/wiki/Norfair\" target=\"_blank\">Norfair</a>, there'll always be two transitions between <a href=\"https://metroid.fandom.com/wiki/Crateria\" target=\"_blank\">Crateria</a>/blue <a href=\"https://metroid.fandom.com/wiki/Brinstar\" target=\"_blank\">Brinstar</a> and green/pink <a href=\"https://metroid.fandom.com/wiki/Brinstar\" target=\"_blank\">Brinstar</a>, ...<br/>\
This mode can be use as an introduction before doing full Area Randomization or to get less lost when you don't use the <a href=\"/tracker\" target=\"_blank\">Area Tracker</a>.</p>\
<p>When 'Areas randomization' dice button is on, Light Area Randomization is greyed and it's not used.</p>\
<hr />\
<h3>Area Randomization Details</h3>\
<a href=\"/solver/static/images/common/area_map_20200112.png\" class=\"highslide\" onclick=\"return hs.expand(this, {wrapperClassName: 'borderless', dimmingOpacity: 0.75, align: 'center'})\"><div class=\"parent-center\"><img id=\"areathumb\" src=\"/solver/static/images/help/area_map_thumbnail.png\" alt=\"Area Map\" title=\"Click to enlarge\" class=\"half child-center\"/></div></a>\
<p>All portals can be linked to one another, even if it means following an incompatible transition (Left-Left, Up-Right, ...).</p>\
<p>To find your way more easily, you can use in-game map area tracking (see Patches section help for more details), or the <a href=\"/solver/solver_web/tracker\" target=\"_blank\">Area Tracker</a> to have the exact transitions.</p>\
<p>By default, the escape sequence will spawn you outside a random map station, and you have to find your way to the ship. See Escape Randomization section (in medium/advanced tab) for more information.</p>\
<p> All portal doors has been turn to blinking blue doors.</p>\
<p>In order to have usable save stations in all areas, some have been added or modified:</p>\
<table class=\"full\">\
<tr>\
<td class=\"knowsUsed\"><p class=\"top\">New save station at <a href=\"https://wiki.supermetroid.run/Main_Street\" target=\"_blank\">Main Street</a>:</td>\
<td class=\"knowsUsed\"><p class=\"top\">New save station at <a href=\"https://wiki.supermetroid.run/Crab_Shaft\" target=\"_blank\">Crab Shaft</a>:</td>\
<td class=\"knowsUsed\"><p class=\"top\"><a href=\"https://wiki.supermetroid.run/Wrecked_Ship_Save_Room\" target=\"_blank\">Wrecked Ship save station</a> is always active:</td>\
</tr>\
<tr>\
<td class=\"knowsUsed\"><img src=\"/solver/static/images/help/main_street_save.png\" alt=\"main_street_save.png\" title=\"main_street_save.png\" class=\"full\"/></td>\
<td class=\"knowsUsed\"><img src=\"/solver/static/images/help/crab_shaft_save.png\" alt=\"crab_shaft_save.png\" title=\"crab_shaft_save.png\" class=\"full\"/></td>\
<td class=\"knowsUsed\"><img src=\"/solver/static/images/help/ws_save.png\" alt=\"ws_save.png\" title=\"ws_save.png\" class=\"full\"/></td>\
</tr>\
</table>\
</p>\
<p>\
To have a self contained <a href=\"https://metroid.fandom.com/wiki/Maridia\" target=\"_blank\">East Maridia</a> area <a href=\"https://wiki.supermetroid.run/West_Sand_Hall\" target=\"_blank\">West Sand Hall</a> and the <a href=\"https://wiki.supermetroid.run/Below_Botwoon_Energy_Tank\" target=\"_blank\">room below Botwoon Energy Tank</a> are now linked, and <a href=\"https://wiki.supermetroid.run/West_Sand_Hall_Tunnel\" target=\"_blank\">West Sand Hall Tunnel</a> door is sealed:\
<table class=\"full\">\
<tr>\
<td class=\"knowsUsed\"><p class=\"top\"><a href=\"https://wiki.supermetroid.run/West_Sand_Hall\" target=\"_blank\">West Sand Hall</a> left door:</td>\
<td class=\"knowsUsed\"><p class=\"top\"><a href=\"https://wiki.supermetroid.run/Below_Botwoon_Energy_Tank\" target=\"_blank\">Below Botwoon Energy Tank</a> new door:</td>\
<td class=\"knowsUsed\"><p class=\"top\">Grey door at <a href=\"https://wiki.supermetroid.run/West_Sand_Hall_Tunnel\" target=\"_blank\">West Sand Hall Tunnel</a> right:</td>\
</tr>\
<tr>\
<td class=\"knowsUsed\"><img src=\"/solver/static/images/help/west_sand_hall.png\" alt=\"west_sand_hall.png\" title=\"west_sand_hall.png\" class=\"full\"/></td>\
<td class=\"knowsUsed\"><img src=\"/solver/static/images/help/below_botwoon_etank.png\" alt=\"below_botwoon_etank.png\" title=\"below_botwoon_etank.png\" class=\"full\"/></td>\
<td class=\"knowsUsed\"><img src=\"/solver/static/images/help/west_sand_hall_tunnel.png\" alt=\"west_sand_hall_tunnel.png\" title=\"west_sand_hall_tunnel.png\" class=\"full\"/></td>\
</tr>\
</table>\
</p>\
<p>Even with all layout modifications, it is still possible to softlock in some occurrences. To avoid softlocking your save file, an automatic rolling backup save system is enabled. See Patches section help for more details.</p>\
Click on the dice button to randomly set this parameter.",
      placement: "auto left"
    },
    {
      element: "#areaLayoutStep",
      title: "Areas randomization additional layout modifications",
      content: "<p>These patches minimize soft-locks and increase the variation of the area randomizer. Some additional cosmetic changes may not be shown. These patches are only available when full or light area randomization is enabled. </p><div id='tourPortal'></div>",
      onShown: () => window.$randomizer.mountHelp('areaLayout'),
      placement: "auto right",
    },
    {
      element: "#doorsColorsRandoStep",
      title: "Doors Colors Randomization",
      content: "<p>Randomize the color of Red/Green/Yellow doors.<br/>\
Add four new type of doors which require Ice <img src=\"/solver/static/images/tracker/inventory/Ice.png\" class=\"width: 32px\"/> / Wave <img src=\"/solver/static/images/tracker/inventory/Wave.png\" class=\"width: 32px\"/> / Spazer <img src=\"/solver/static/images/tracker/inventory/Spazer.png\" class=\"width: 32px\"/> / Plasma <img src=\"/solver/static/images/tracker/inventory/Plasma.png\" class=\"width: 32px\"/>  beams to open them.<br/>\
<table>\
<tr><td><img src=\"/solver/static/images/tracker/inventory/Missile.png\" class=\"centerIcon\"></td><td><img src=\"/solver/static/images/help/missile_door.png\" class=\"marginRight\"></td>\
<td><img src=\"/solver/static/images/tracker/inventory/Super.png\" class=\"centerIcon\"></td><td><img src=\"/solver/static/images/help/super_door.png\" class=\"marginRight\"></td>\
<td><img src=\"/solver/static/images/tracker/inventory/PowerBomb.png\" class=\"centerIcon\"></td><td><img src=\"/solver/static/images/help/powerbomb_door.png\" class=\"marginRight\"></td><td></td></tr>\
<tr><td><img src=\"/solver/static/images/tracker/inventory/Wave.png\" class=\"centerIcon\"></td><td><img src=\"/solver/static/images/help/wave_door.png\" class=\"marginRight\"></td>\
<td><img src=\"/solver/static/images/tracker/inventory/Plasma.png\" class=\"centerIcon\"></td><td><img src=\"/solver/static/images/help/plasma_door.png\" class=\"marginRight\"></td>\
<td><img src=\"/solver/static/images/tracker/inventory/Spazer.png\" class=\"centerIcon\"></td><td><img src=\"/solver/static/images/help/spazer_door.png\" class=\"marginRight\"></td>\
<td><img src=\"/solver/static/images/tracker/inventory/Ice.png\" class=\"centerIcon\"></td><td><img src=\"/solver/static/images/help/ice_door.png\" class=\"marginRight\"></td></tr>\
</table>\
Missile doors can no longer be opened with a Super Missile <img src=\"/solver/static/images/tracker/inventory/Super.png\" class=\"width: 32px\"/>. Only one Missile <img src=\"/solver/static/images/tracker/inventory/Missile.png\" class=\"width: 32px\"/> is required to open a Missile door.<br/>\
For Plasma/Spazer doors, when you have both beams collected and one equipped you can open both door types.<br/>\
Colored doors to save stations / refills / map stations are excluded from randomization.<br/>\
Colored doors to save / refill stations are forced to blue.<br/>\
Blue doors with a colored door on the other side will blink in the matching color (you can disable it by disabling 'Anti-softlock layout patches').<br/>\
The fill algorithm will be more trolly about ammo/beam if you use slower progression speed.</p>\
<p>In this mode there are seven distinct door keys, and sometimes (especially with non standard starting location or area rando), if you go through a blue door you can end up locked on the other side if you don't have or find the item required to come back. If you save in that situation, your save file will be hardlocked. To avoid this, a rolling backup save system is enabled. See Patches section help for more defails.</p>\
<p>Click on the dice button to randomly set this parameter.</p>\
Beams doors patch by Mettyk25jigsaw.<br/>\
Beams doors gfx by prankard.<br/>\
CRE gfx fix by Sirkura.<br/>\
Missile doors patchby Flo.",
      placement: "auto left"
    },
    {
      element: "#doorsColorsGreyStep",
      title: "Allow some doors to be grey",
      content: "<p>When randomizing the color of Red/Green/Yellow doors, some doors can be randomized to Grey.<br/>\
Grey doors will never open, you will have to go around them.</p>",
      placement: "auto left"
    },
    {
      element: "#bossRandomizationStep",
      title: "Bosses randomization",
      content: "<p>Randomize Golden 4 bosses access doors (<a href=\"https://wiki.supermetroid.run/Kraid\" target=\"_blank\">Kraid</a>, <a href=\"https://wiki.supermetroid.run/Phantoon\" target=\"_blank\">Phantoon</a>, <a href=\"https://wiki.supermetroid.run/Draygon\" target=\"_blank\">Draygon</a>, <a href=\"https://wiki.supermetroid.run/Ridley\" target=\"_blank\">Ridley</a>) using bidirectional access portals (the same access portals as in Areas randomization).</p>\
<p>Areas or rooms unlocked by bosses stay unchanged. For example, you still have to kill <a href=\"https://wiki.supermetroid.run/Phantoon\" target=\"_blank\">Phantoon</a> to activate <a href=\"https://metroid.fandom.com/wiki/Wrecked_Ship\" target=\"_blank\">Wrecked Ship</a>.</p>\
<p><a href=\"https://wiki.supermetroid.run/Wrecked_Ship_Save_Room\" target=\"_blank\">Wrecked Ship save station</a> is always active:</p>\
<table class=\"quarter\">\
<tr><td><img src=\"/solver/static/images/help/ws_save.png\" alt=\"ws_save.png\" title=\"ws_save.png\" class=\"full\"/></td></tr>\
</table>\
Click on the dice button to randomly set this parameter.",
      placement: "auto left"
    },
    {
      element: "#minimizerStep",
      title: "Minimizer",
      content: "<p>Create a <b>'boss rush'</b> seed with a minimal layout by only connecting together enough areas to match the given number of locations (from 30 to 100). There will usually be slightly more locations available. <br/>\
You can generate anything from a densely packed game with just <a href=\"https://metroid.fandom.com/wiki/Crateria\" target=\"_blank\">Crateria</a>, <a href=\"https://metroid.fandom.com/wiki/Wrecked_Ship\" target=\"_blank\">Wrecked Ship</a>, and bosses, to a full area+boss rando<br/>\
<b>Boss and Area transitions are mixed together</b>, <a href=\"https://metroid.fandom.com/wiki/Gadora\" target=\"_blank\">Gadoras</a> are removed, and you can <b>exit boss fights</b> at any point (they are also considered dead as soon as they start exploding instead of when the drops appear).</p>\
<p>\
You can also <b>speed up <a href=\"https://metroid.fandom.com/wiki/Tourian\" target=\"_blank\">Tourian</a></b> (on by default: sets the Tourian parameter to 'Fast'), to skip Metroids, <a href=\"https://metroid.fandom.com/wiki/Zebetite\" target=\"_blank\">Zebetites</a>, and all cutscenes (including <a href=\"https://metroid.fandom.com/wiki/Mother_Brain\" target=\"_blank\">Mother Brain</a> 3 fight). <a href=\"https://metroid.fandom.com/wiki/Golden_Statues\" target=\"_blank\">Golden Four statues</a> are replaced by an invincible <a href=\"https://metroid.fandom.com/wiki/Gadora\" target=\"_blank\">Gadora</a> until all objectives are completed. It also adds a layout patch to open <a href=\"https://metroid.fandom.com/wiki/Zebetite\" target=\"_blank\">Zebetites</a> to pass them without Morph <img src=\"/solver/static/images/tracker/inventory/Morph.png\" class=\"width: 32px\"/>, allowing the creation of morphless plandos.\
</p>\
<p>Minimizer layout example:<a href=\"/solver/static/images/help/minimizer_example.png\" class=\"highslide\" onclick=\"return hs.expand(this, {wrapperClassName: 'borderless', dimmingOpacity: 0.75, align: 'center'})\"><div class=\"parent-center\"><img id=\"minimizerThumb\" src=\"/solver/static/images/help/minimizer_example_thumbnail.png\" alt=\"Minimizer example\" title=\"Click to enlarge\" class=\"child-center half\"/></div></a></p>\
<b>Note:</b> will set Area and Boss randomization.<br/>\
Click on the dice button to randomly set the number of locations (between 30 and 60).",
      placement: "auto left"
    },
    {
      element: "#escapeRandoStep",
      title: "Escape sequence randomization",
      content: "<p>When leaving <a href=\"https://metroid.fandom.com/wiki/Tourian\" target=\"_blank\">Tourian</a>, get teleported to the exit of a random <a href=\"https://metroid.fandom.com/wiki/Map_Station\" target=\"_blank\">Map station</a> (between <a href=\"https://metroid.fandom.com/wiki/Brinstar\" target=\"_blank\">Brinstar</a>/<a href=\"https://metroid.fandom.com/wiki/Maridia\" target=\"_blank\">Maridia</a>/<a href=\"https://metroid.fandom.com/wiki/Norfair\" target=\"_blank\">Norfair</a>/<a href=\"https://metroid.fandom.com/wiki/Wrecked_Ship\" target=\"_blank\">Wrecked Ship</a>).<br/>You then have to find your way to the <a href=\"https://metroid.fandom.com/wiki/Samus's_Gunship\" target=\"_blank\">ship</a> in the remaining time. Allotted time depends on area layout, but not on skill settings and is pretty generous.</p>\
During the escape sequence:\
<ul>\
<li>All doors are opened</li>\
<li><a href=\"https://wiki.supermetroid.run/Glass_Tunnel\" target=\"_blank\">Maridia tube</a> is opened</li>\
<li>The <a href=\"https://metroid.fandom.com/wiki/Hyper_Beam_(Super_Metroid)\" target=\"_blank\">Hyper Beam</a> can destroy Bomb <img src=\"/solver/static/images/tracker/inventory/Bomb.png\" class=\"width: 32px\"/>, Power Bomb <img src=\"/solver/static/images/tracker/inventory/PowerBomb.png\" class=\"width: 32px\"/> and Super Missile <img src=\"/solver/static/images/tracker/inventory/Super.png\" class=\"width: 32px\"/> blocks and open blue/green gates from both sides</li>\
<li>All mini bosses are defeated</li>\
<li>All minor enemies are removed to allow you to move faster and remove lag</li>\
</ul>\
<p>During regular game only <a href=\"https://wiki.supermetroid.run/Crateria_Map_Room\" target=\"_blank\">Crateria Map station</a> door can be opened and activating the station will act as if all map stations were activated at once.</p>\
<b>Animals Challenges:</b>\
<p>You can use the extra available time to:\
<ul>\
<li>find the <a href=\"https://metroid.fandom.com/wiki/Dachora\" target=\"_blank\">animals</a> that are hidden behind a (now blue) map station door</li>\
<li>go to the <a href=\"https://wiki.supermetroid.run/Flyway\" target=\"_blank\">vanilla animals door</a> to cycle through the 4 available escapes, and complete as many escapes as you can</li>\
</ul>\
Pick your challenge, or try to do both, but watch your timer!</p>",
      placement: "auto left"
    },
    {
      element: "#removeEscapeEnemiesStep",
      title: "Remove enemies during escape",
      content: "<p>Remove enemies during escape sequence, disable it to blast through enemies with your <a href=\"https://metroid.fandom.com/wiki/Hyper_Beam_(Super_Metroid)\" target=\"_blank\">Hyper Beam</a> and cause lag.</p>",
      placement: "auto left"
    },
    {
      element: "#funCombatStep",
      title: "Super Fun Combat",
      content: "<p>Forces removal of Plasma Beam <img src=\"/solver/static/images/tracker/inventory/Plasma.png\" alt=\"Plasma.png\" title=\"Plasma.png\" class=\"width: 32px\"/>, and Screw Attack <img src=\"/solver/static/images/tracker/inventory/ScrewAttack.png\" alt=\"ScrewAttack.png\" title=\"ScrewAttack.png\" class=\"width: 32px\"/> if the preset and settings allow it.<br/>In addition, can randomly remove some items from the Combat set:</p>\
<ul>\
<li><img src=\"/solver/static/images/tracker/inventory/Spazer.png\" alt=\"Spazer.png\" title=\"Spazer.png\" class=\"width: 32px\"/> Spazer</li>\
<li><img src=\"/solver/static/images/tracker/inventory/Wave.png\" alt=\"Wave.png\" title=\"Wave.png\" class=\"width: 32px\"/> Wave Beam</li>\
</ul>\
Click on the dice button to randomly set this parameter.",
      placement: "auto left"
    },
    {
      element: "#funMovementStep",
      title: "Super Fun Movement",
      content: "<p>Forces removal of Space Jump <img src=\"/solver/static/images/tracker/inventory/SpaceJump.png\" alt=\"SpaceJump.png\" title=\"SpaceJump.png\" class=\"width: 32px\"/> if the preset allows it.<br/>\
In addition, can randomly remove some items from the Movement set:</p>\
<ul>\
<li><img src=\"/solver/static/images/tracker/inventory/HiJump.png\" alt=\"HiJump.png\" title=\"HiJump.png\" class=\"width: 32px\"/> Hi Jump</li>\
<li><img src=\"/solver/static/images/tracker/inventory/Grapple.png\" alt=\"Grapple.png\" title=\"Grapple.png\" class=\"width: 32px\"/> Grappling Beam</li>\
<li><img src=\"/solver/static/images/tracker/inventory/SpringBall.png\" alt=\"SpringBall.png\" title=\"SpringBall.png\" class=\"width: 32px\"/> Spring Ball</li>\
<li><img src=\"/solver/static/images/tracker/inventory/SpeedBooster.png\" alt=\"SpeedBooster.png\" title=\"SpeedBooster.png\" class=\"width: 32px\"/> Speed Booster</li>\
<li><img src=\"/solver/static/images/tracker/inventory/Bomb.png\" alt=\"Bomb.png\" title=\"Bomb.png\" class=\"width: 32px\"/> Bombs</li>\
</ul>\
Click on the dice button to randomly set this parameter.",
      placement: "auto left"
    },
    {
      element: "#funSuitsStep",
      title: "Suitless",
      content: "<p>If the preset and seed layout allow it, will force removal of at least one suit (Varia Suit <img src=\"/solver/static/images/tracker/inventory/Varia.png\" alt=\"Varia.png\" title=\"Varia.png\" class=\"width: 32px\"/> and/or Gravity Suit <img src=\"/solver/static/images/tracker/inventory/Gravity.png\" alt=\"Gravity.png\" title=\"Gravity.png\" class=\"width: 32px\"/>).</p>\
<p>Click on the dice button to randomly set this parameter.</p>",
      placement: "auto left"
    },
    {
      element: "#patchesStep",
      title: "Default Patches",
      content: "Patches always applied:\
<ul>\
<li>Press Start+Select+L+R to quickly reload your last save</li>\
<li>Allows the aim buttons to be assigned to any button (by Kejardon)</li>\
<li>Max Ammo Display (by Personitis)</li>\
<li>Play music with <a href=\"https://www.zeldix.net/t1607-msu1-getting-started-guide\" target=\"_blank\">MSU1 chip</a> on <a href=\"https://www.retrorgb.com/fxpakpro.html\" target=\"_blank\">SD2SNES/FXPak</a> and compatible emulators (by DarkShock)</li>\
<li>Disable <a href=\"https://wiki.supermetroid.run/Golden_Torizo_Code\" target=\"_blank\">GT Code</a> and <a href=\"https://wiki.supermetroid.run/Weapon_Techniques#Glitched_Beams\" target=\"_blank\">gliched beams</a>, also fixes to some vanilla bugs</li>\
<li>When doors are colored on one side and blue on the other, the blue side blinks to indicate the color of the other side</li>\
<li>When your save point is different from the last one, an automatic backup is done in an available spot: a cleared or unlocked save file. A file is locked when you start/load a game from it, or when you lock it manually. Files can be locked/unlocked in the load menu by pressing left, right, X or Y.</li>\
<table>\
<tr>\
<td class=\"knowsUsed\"><p class=\"top\">Load menu with file A and C locked:</td>\
<td class=\"knowsUsed\"><p class=\"top\">When saving, file copy is notified:</td>\
<td class=\"knowsUsed\"><p class=\"top\">Unlock files with left, right, X or Y in the load menu if no more slots available:</td>\
</tr>\
<tr>\
<td class=\"knowsUsed\"><img src=\"/solver/static/images/help/backup_locks.png\" alt=\"backup_locks.png\" title=\"backup_locks.png\" class=\"full\"/></td>\
<td class=\"knowsUsed\"><img src=\"/solver/static/images/help/backup_copy.png\" alt=\"backup_copy.png\" title=\"backup_copy.png\" class=\"full\"/></td>\
<td class=\"knowsUsed\"><img src=\"/solver/static/images/help/backup_no_slots.png\" alt=\"no_slots.png\" title=\"no_slots.png\" class=\"full\"/></td>\
</tr>\
</table>\
<li>Change in-game font for HUD and pause menu with <a href=\"https://damieng.com/typography/zx-origins/zx-eurostile/\" target=\"_blank\">ZX Eurostile by damieng</a></li>\
<li>Display collected items percentage and RTA time in pause inventory menu :</li>\
<img src=\"/solver/static/images/help/inventory.png\" alt=\"inventory.png\" title=\"Inventory menu\" class=\"third center_img\"/>\
<li>Integrate Map Overhaul patch by MFreak, with VARIA adaptations:</li>\
<ul>\
<li>In-game map is now easier to read (room connections are clearly shown), and the mini-map is drawn the same way as the main map (except colors and map icons)</li>\
<li>Use the select button to switch between visited areas</li>\
<li>Depending on item splits, major item locations (if applicable) will have a distinct icon</li>\
<li>Each area in the VARIA sense (Green/Pink Brinstar, Crocomire, Wrecked Ship etc.) has its own distinct color inside the original game maps</li>\
<li>The map automatically tracks door colors when they have been seen by the player</li>\
<li>In area randomizer, portals are automatically tracked as well when they have been taken once, as the map adds portal icons with the color of the destination area</li>\
<img src=\"/solver/static/images/help/map.png\" alt=\"map.png\" title=\"Brinstar map example\" class=\"third center_img\"/>\
</ul>\
</ul>",
      placement: "auto left"
    },
    {
      element: "#layoutPatchesStep",
      title: "Anti-softlock Layout patches",
      content: "Include the anti-softlock layout patches. Disable at your own softlocking risk!<br/>\
Disabling it will also disable blinking blue doors with a color door on the other side (see Doors Colors Randomization). <div id='tourPortal'></div>",
      onShown: () => window.$randomizer.mountHelp('layout'),
      placement: "auto right",
    },
    {
      element: "#variaTweaksStep",
      title: "VARIA Tweaks",
      content: "<p>Include minor tweaks for the game to behave 'as it should' in a randomizer context:</p>\
<table class=\"full\"> <div id='tourPortal'></div>",
      onShown: () => window.$randomizer.mountHelp('variaTweaks'),
      placement: "auto right",
    },
    {
      element: "#nerfedChargeStep",
      title: "Nerfed Charge Beam",
      content: "<ul>\
<li>Samus begins with a starter Charge Beam <img src=\"/solver/static/images/tracker/inventory/Charge.png\" alt=\"Charge.png\" title=\"Charge.png\" class=\"width: 32px\"/> that does one third of charged shot damage, effectively bringing a nerfed charge shot damage to a standard shot damage, but that can damage bosses.</li>\
<li><a href=\"https://wiki.supermetroid.run/Pseudo_Screw_Attack\" target=\"_blank\">Pseudo Screws</a> also do one third damage.</li>\
<li><a href=\"https://wiki.supermetroid.run/Charge_Beam_Combos\" target=\"_blank\">Special Beam Attacks</a> do normal damage but cost 3 Power Bombs instead of 1.</li>\
<li>Once the Charge Beam <img src=\"/solver/static/images/tracker/inventory/Charge.png\" alt=\"Charge.png\" title=\"Charge.png\" class=\"width: 32px\"/> item has been collected, it does full damage and special attacks are back to normal.</li>\
</ul>\
<p>Patch developed by Smiley and Flo.</p>",
      placement: "auto left"
    },
    {
      element: "#relaxed_round_robin_cfStep",
      title: "Relaxed Round Robin Crystal Flash",
      content: "<p>Changes <a href=\"https://metroid.fandom.com/wiki/Crystal_Flash\" target=\"_blank\">Crystal Flashes</a> <img src=\"/solver/static/images/preset/crystal_flash.png\" alt=\"CF.png\" title=\"CF.png\" class=\"width: 32px\"/> behavior and requirements as follows:</p>\
<p><ul><li>You can perform a Crystal Flash with any amount of ammo, but you need at least one Power Bomb <img src=\"/solver/static/images/tracker/inventory/PowerBomb.png\" class=\"width: 32px\"/> to begin the process.</li>\
<li>After consuming 1 ammo, Samus gains 50 energy, and it will try a different ammo type next. Cycling through Missiles <img src=\"/solver/static/images/tracker/inventory/Missile.png\" class=\"width: 32px\"/>, Supers <img src=\"/solver/static/images/tracker/inventory/Super.png\" class=\"width: 32px\"/>, and Power Bombs <img src=\"/solver/static/images/tracker/inventory/PowerBomb.png\" class=\"width: 32px\"/> as available. The cycling is to keep the consumption even between ammo types.</li>\
<li>If one of your ammo types is at 0, it will be skipped.</li>\
<li>The Crystal Flash ends when Samus is out of ammo or a total of 30 ammo has been consumed.</li></ul></p>\
<p>Patch developed by Dagit.</p>",
      placement: "auto left"
    },
    {
      element: "#gravityBehaviourStep",
      title: "Suits Properties",
      content: "<p><ul>\
<li>Balanced:<p>Removes Gravity <img src=\"/solver/static/images/tracker/inventory/Gravity.png\" alt=\"Gravity.png\" title=\"Gravity.png\" class=\"width: 32px\"/> environmental protection (heat, spikes, electricity...). It also doubles the Varia <img src=\"/solver/static/images/tracker/inventory/Varia.png\" alt=\"Varia.png\" title=\"Varia.png\" class=\"width: 32px\"/> environmental protection, to balance the two suits abilities. Enemy damage protection is still vanilla (50% for Varia, 75% for Gravity).</p></li>\
<li>Progressive:\
<p><ul>\
<li>Gravity <img src=\"/solver/static/images/tracker/inventory/Gravity.png\" alt=\"Gravity.png\" title=\"Gravity.png\" class=\"width: 32px\"/> provides 50% heat damage reduction. Varia <img src=\"/solver/static/images/tracker/inventory/Varia.png\" alt=\"Varia.png\" title=\"Varia.png\" class=\"width: 32px\"/> still provides full heat protection.</li>\
<li>Varia <img src=\"/solver/static/images/tracker/inventory/Varia.png\" alt=\"Varia.png\" title=\"Varia.png\" class=\"width: 32px\"/> and Gravity  <img src=\"/solver/static/images/tracker/inventory/Gravity.png\" alt=\"Gravity.png\" title=\"Gravity.png\" class=\"width: 32px\"/> each add 50% damage reduction to enemy attacks and environmental damage.</li>\
<li>Varia <img src=\"/solver/static/images/tracker/inventory/Varia.png\" alt=\"Varia.png\" title=\"Varia.png\" class=\"width: 32px\"/> and Gravity  <img src=\"/solver/static/images/tracker/inventory/Gravity.png\" alt=\"Gravity.png\" title=\"Gravity.png\" class=\"width: 32px\"/> stack to reach 75% reduction to enemy attacks and environmental damage.</li>\
</ul></p>\
</li>\
<li>Vanilla:<p>No change to vanilla suits properties. Most notably, Gravity <img src=\"/solver/static/images/tracker/inventory/Gravity.png\" alt=\"Gravity.png\" title=\"Gravity.png\" class=\"width: 32px\"/> provides full protection against environmental damages (heat, spikes, electricity...).</p></li>\
</ul></p>\
<p>Click on the dice button to randomly set this parameter.</p>\
<p>Patches developed by Total and Smiley.</p>",
      placement: "auto left"
    },
    {
      element: "#itemsoundsStep",
      title: "Fanfare",
      content: "<p>Replaces the quite long fanfare played when picking up an item by a short sound effect related with the item picked, and does not restart game music on item pickup.</p>\
<p>Patch developed by Scyzer.</p>",
      placement: "auto left"
    },
    {
      element: "#ElevatorDoorsStep",
      title: "Transitions",
      content: "<p>Accelerate doors and/or elevators transitions</p>\
<p>Doors patch developed by Rakki and elevators patch by Lioran.</p>",
      placement: "auto left"
    },
    {
      element: "#spinjumprestartStep",
      title: "Spin jump restart",
      content: "<p>Allows Samus to start spinning in mid air after jumping or falling</p>\
<p>Patch developed by Kejardon.</p>",
      placement: "auto left"
    },
    {
      element: "#rando_speedStep",
      title: "Momentum conservation",
      content: "<p>Let Samus keeps her momentum when landing from a fall or from jumping</p>\
<p>This patch was developed by Oi27.</p>",
      placement: "auto left"
    },
    {
      element: "#Infinite_Space_JumpStep",
      title: "Infinite Space Jump",
      content: "<p>Space jumps can be done quicker and at any time in air, water or lava, even after falling long distances.</p>\
<p>This patch was developed by MetConst.</p>",
      placement: "auto left"
    },
    {
      element: "#refill_before_saveStep",
      title: "Refill before save",
      content: "<p>Refill energy and ammo when saving.</p>\
<p>This patch was developed by Adam.</p>",
      placement: "auto left"
    },
    {
      element: "#hudStep",
      title: "VARIA HUD",
      content: "<p>Displays the current area name and the number of remaining items of selected item split in the HUD for the current area (see area map on the <a href=\"/solver/solver_web/tracker\" target=\"_blank\">tracker page</a>).<br/>\
As it takes the place of the top energy tank rows, all energy is displayed on a single row (like the Arcade hack).<br/>\
This patch is automatically enabled when using Full Countdown item split, or Majors/Chozo split and non-standard start location. It is also helpful to keep track of how many actual items there are if you play with non-vanilla ammo/energy or Super Fun settings.</p>\
<p>It is also enabled automatically in Scavenger item split. In that case, its purpose is to show the next location to get to during gameplay, and also to allow you to know the Scavenger Hunt locations of the seed.</p>\
<p><b>Examples :</b>\
<table class=\"full\">\
<tr>\
<td>Crateria start with Chozo split</td><td>In Full or Full Countdown split</td><td>Major items split</td>\
</tr>\
<tr>\
<td><img src=\"/solver/static/images/help/hud_chozo_start.png\" class=\"full\"/></td><td><img src=\"/solver/static/images/help/hud_full.png\" class=\"full\"/></td><td><img src=\"/solver/static/images/help/hud_major_energy.png\" class=\"full\"/></td>\
</tr>\
<tr>\
<td>Scavenger gameplay</td><td>Scavenger Hunt over</td><td>Prompt during pause to show Scavenger locations</td>\
</tr>\
<tr>\
<td><img src=\"/solver/static/images/help/hud_scav.png\" class=\"full\"/></td><td><img src=\"/solver/static/images/help/hud_scav_over.png\" class=\"full\"/></td><td><img src=\"/solver/static/images/help/hud_scav_pause.png\" class=\"full\"/></td>\
</tr>\
</table></p>\
<p>This patch was developed by Flo (Area/Item track) and Lioran (Etank bar combine).</p>",
      placement: "auto left"
    },
    {
      element: "#revealMapStep",
      title: "Reveal Map",
      content: "<p>Reveals the whole in game map on start, showing item locations and class depending on item split. Map areas are available as soon as you step in them once.</p>\
<img src=\"/solver/static/images/help/reveal_map.png\" alt=\"reveal_map.png\" title=\"Brinstar map with the reveal patch\" class=\"third center_img\"/>\
<p>Patch developed by Flo</p>",
      placement: "auto left"
    },
    {
      element: "#better_reservesStep",
      title: "Better Reserves",
      content: "<p>This patch does a few things:<ul>\
<li>Reserve tanks come filled up</li>\
<li>Different color for HUD reserve indicator when full</li>\
<li>Prevents heat damage and the loss of invincibility frames when auto reserves activate (no more getting hit twice!)</li>\
<li>Makes reserve tanks not empty if Samus is fully healed when they are used in auto or manual mode.</li>\
<li>Fix jank where deselecting and reselecting refill button during manual refill causes it to resume.</li>\
<li>Can also press A during manual refill at any time to stop refilling.</li>\
</ul></p>\
<p>Patch developed by NoDever2</p>",
      placement: "auto left"
    },
    {
      element: "#animalsStep",
      title: "Animals surprise",
      content: "<p>Replace saving the animals in the escape sequence by a random surprise.<br/>\
<b>Note:</b> This setting is not available when Escape Randomization is enabled, as it is replaced by Animals Challenges (see Escape Randomization help for more information).<br/>\
<b>Note:</b> This setting is not available when using non vanilla flavor like Super Mirrortroid.</p>\
<p>Patch developed by Foosda.</p>",
      placement: "auto left"
    },
    {
      element: "#No_MusicStep",
      title: "No music",
      content: "<p>Disable the background music to let you hear you favorite tunes instead.</p>\
<p>Patch developed by Kejardon.</p>",
      placement: "auto left"
    },
    {
      element: "#random_musicStep",
      title: "Random Music",
      content: "<p>Randomize the background music.</p>\
<p>Patch developed by dude & flo.</p>",
      placement: "auto left"
    },
 ]});

  // Initialize the tour
  tour.init();

  if (typeof step === "object") {
    // step is an event, not a number. Get ID from parent element
    let parent = event.target.parentNode
    step = parent.id
    while (!step) {
        parent = parent.previousElementSibling
        step = parent.id
    }
  }
    console.log("startTheTour step is " + step);
  if (typeof step === 'string') {
    step = tour._options.steps.findIndex((tour_step) => tour_step.element === `#${step}`)
  }
  // Start the tour
  if(step != -1) {
    console.log("startTheTour final step is " + step);
    tour.goTo(step);
  }
  tour.start();
}

function DoPost(){
    $.redirect("/presets", { action: "Load", currenttab: "Techniques1", preset: document.getElementById("preset").value }, "POST", "_blank");
}
</script>
{{
def displayCheckbox(id, defaultTrue=False):
  if (id in session.randomizer and session.randomizer[id] == 'on') or (id not in session.randomizer and defaultTrue == True):
}}
    {{=INPUT(_id=id, _name=id, _type="checkbox", _checked="checked", _value="on", _class="js-switch", _onchange="switchCheckbox('{}')".format(id))}}
{{
  else:
}}
    {{=INPUT(_id=id, _name=id, _type="checkbox", _value="off", _class="js-switch", _onchange="switchCheckbox('{}')".format(id))}}
    {{pass}}
  {{pass}}

{{
def displaySelect(id, values, default, replace=True):
  value = session.randomizer.get(id, default)
  if replace:
}}
  {{
     =SELECT(*[OPTION(displayNames.get(value, value), _value=value) for value in values],
             **dict(_id=id, _name=id, value=value, _class="full"))
  }}
{{
  else:
}}
  {{
     =SELECT(*values, **dict(_id=id, _name=id, value=value, _class="full"))
  }}
    {{pass}}
{{pass}}

{{
def displayMultiSelect(id, selectedValues, default, multipleValues, replace=True):
  displaySelect(id, multipleValues, default, replace)

  response.write("<div id=\"{}MultiSelectDiv\" style=\"display:none\">".format(id), escape=False)
  response.write("<select id=\"{}MultiSelect\" class=\"chzn-select\" multiple>".format(id), escape=False)
  for value in multipleValues:
    if replace:
      displayValue = displayNames.get(value, value)
    else:
      displayValue = value
      pass
    if value in selectedValues:
      response.write("  <option value=\"{}\" selected=\"selected\">{}</option>".format(value, displayValue), escape=False)
    else:
      response.write("  <option value=\"{}\">{}</option>".format(value, displayValue), escape=False)
      pass
    pass
  response.write("</select>", escape=False)
  response.write("</div>", escape=False)
  pass
}}

{{
def displayNumber(id, min, max, default, step="1"):
  if id in session.randomizer:
    value = session.randomizer[id]
    if value in ['0', 'random'] and id == 'nbObjective':
      # "random" for this is actually 0, but the input field is 1-5
      # since the value only matters when the dice is not checked, set to the default value: 4
      value = 4
      pass
  else:
    value = default
    pass

  response.write("<input name=\"{}\" id=\"{}\" type=\"number\" value=\"{}\" min=\"{}\" max=\"{}\" step=\"{}\" class=\"full\" required>".format(id, id, value, min, max, step), escape=False)
  pass
}}
<body>
  <div id="overlay"></div>
  <div id="loadingGIF"><img src={{=URL('static/images/rando','ajax-loader.gif')}}/></div>
  <div id="loadingTips0" class="loadingTips"></div>
  <div id="loadingTips1" class="loadingTips"></div>

  <div class="fixed">
    <div class="menu">
    <table class="full menuTable">
      <tr>
        <td>{{=A("Home", _href=URL(f="home"), _class="menu")}}</td>
        <td>{{=A("Presets", _href=URL(f="presets"), _class="menu")}}</td>
        <td class="menu_selected">{{=A("Randomizer", _href=URL(f="randomizer"), _class="menu")}}</td>
        <td>{{=A("Solver", _href=URL(f="solver"), _class="menu")}}</td>
        <td>{{=A("Tracker", _href=URL(f="tracker"), _class="menu")}}</td>
        <td>{{=A("Plandomizer", _href=URL(f="plando"), _class="menu")}}</td>
        <td>{{=A("Plandository", _href=URL(f="plandorepo"), _class="menu")}}</td>
        <td>{{=A("Customizer", _href=URL(f="customizer"), _class="menu")}}</td>
        <td>{{=A("Statistics", _href=URL(f="extStats"), _class="menu")}}</td>
        <td>{{=A("Information & Contact", _href=URL(f="infos"), _class="menu")}}</td>
      </tr>
    </table>
    </div>
  </div>

  <div class="main">
    <div id="complexityTabs" class="center">
      <div class="tab">
        <button class="tablinks" id="simple" onclick="changeComplexity(event, 'simple');">Simple</button>
        <button class="tablinks" id="medium" onclick="changeComplexity(event, 'medium');">Medium</button>
        <button class="tablinks" id="advanced" onclick="changeComplexity(event, 'advanced');">Advanced</button>
        <div class="donate">
          <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank" class="nomargin">
            <input type="hidden" name="cmd" value="_s-xclick" />
            <input type="hidden" name="hosted_button_id" value="J6BEK8K8LVG7Y" />
            <input type="image" src="/solver/static/images/rando/donate_randomizer.png" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Donate with PayPal button" class="inputImage"/>
            <img alt="" border="0" src="https://www.paypal.com/en_FR/i/scr/pixel.gif" width="1" height="1" />
          </form>
        </div>
      </div>
    </div>
    <div id="tabRando" class="tabcontent">
    <form id="mainform" name="mainform" onsubmit="doSubmit(); return false;">
        <div class="row">
          <div class="column">
            <p>The Very Adaptive Randomizer of Items and Area (VARIA) randomizer will generate a Super Metroid ROM finishable using the known techniques of the chosen preset.</p>
            <table class="full">
              <colgroup><col class="small"/><col class="half" /><col class="half" /><col class="small"/></colgroup>
              <tr>
                <td class="small"></td>
                <td>Last generated seed permalink:</td><td><span id="permalink"></span></td><td id="permalinkStep"><button type="button" onclick="startTheTour(event)">?</button></td>
              </tr>
              <tr>
                <td class="small"></td>
                <td>Vanilla Super Metroid ROM:</td>
                <td>
                   <div id="uploadFileVisibility">
                     {{=INPUT(_type="file", _name="uploadFile", _id="uploadFile", _class="full")}}
                   </div>
                   <div id="uploadFileOKVisibility">
                     Vanilla ROM already loaded
                   </div>
                </td>
                <td id="romStep"><button type="button" onclick="startTheTour(event)">?</button></td>
              </tr>
              <tr>
                <td class="small"><div class="random"><button id="logicRandom" type="button" onclick="randomizeTarget(event, 'logic')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                <td colspan="2" class="full">
                  <div class="flex-row">
                    <span id="logicText">Flavor:</span>
                    <div class="border">
                      <select class="filldropdown" id="logic" name="logic">
{{
  for (logic, name) in logics:
    response.write("  <option data-img-src=\"/solver/static/images/rando/{}.png\" data-img-label=\"{}\" value=\"{}\" {}>{}</option>\n".format(logic, name, logic, 'selected="selected"' if logic == session.randomizer['logic'] else "", name), escape=False)
    pass
}}
                        </optgroup>
                      </select>
                    </div>
                  </div>
                </td>
                <td id="logicStep"><button type="button" onclick="startTheTour(event)">?</button></td>
              </tr>
              <tr>
                <td class="small"></td>
                <td>Settings Preset:</td>
                <td>
                  <select class="chzn-select" id="randoPreset" name="randoPreset" onchange="loadRandoPreset()">
{{
  for categorie, presets in randoPresetsCategories.items():
    response.write('<optgroup label="{} presets">'.format(categorie), escape=False)
    for preset in presets:
      if preset == "":
        response.write('<option selected="selected" value="{}">{}</option>\\\n'.format(preset, preset), escape=False)
      else:
        response.write('<option value="{}">{}: {}</option>\\\n'.format(preset, preset, randoPresetsDesc.get(preset, "")), escape=False)
        pass
      pass
    pass
}}
                </select>
                </td>
                <td id="randoPresetStep"><button type="button" onclick="startTheTour(event)">?</button></td>
              </tr>
              <tr id="saveLoadRandoPresetVisibility">
                <td class="small"></td>
                <td><img class="rando_button" id="save" src="/solver/static/images/ui/save.svg" title="Save" alt="Save" onclick="saveRandoPresetLocal()"> Save Randomizer parameters</td>
                <td><img class="rando_button" id="load" src="/solver/static/images/ui/cloud_upload.png" title="Load" alt="Load" onclick="loadRandoPresetLocal()"> Load Randomizer parameters</td>
                <td id="saveLoadRandoPresetStep"><button type="button" onclick="startTheTour(event)">?</button></td>
              </tr>
              <tr id="raceModeVisibility">
                <td class="small"></td>
                <td>{{displayCheckbox("raceMode")}}<span id="raceModeText">Race Mode</span></td>
                <td></td>
                <td id="raceStep"><button type="button" onclick="startTheTour(event)">?</button></td>
              </tr>
            </table>
            <br/>
            <h4>Randomizer parameters</h4>
            <table class="full">
              <colgroup><col class="small"/><col class="half" /><col class="half" /><col class="small"/></colgroup>
              <tr id="seedVisibility">
                <td class="small"></td>
                <td>Randomizer seed:</td>
                <td>{{displayNumber("seed", "0", maxsize, "0")}}</td>
                <td id="seedStep"><button type="button" onclick="startTheTour(event)">?</button></td>
              </tr>
              <tr>
                <td class="small"></td>
                <td>Skills Preset: <span class="rightStep"><a href="javascript:DoPost()">What's in the logic for this skills preset ?</a><span></td><!-- ' -->
                <td>{{=SELECT(OPTGROUP(*stdPresets, **dict(_label="Standard presets")), OPTGROUP(*tourPresets, **dict(_label="Tournament presets")), OPTGROUP(*comPresets, **dict(_label="Community presets")), **dict(_name="preset", _id="preset", value=session.randomizer["preset"], _class="chzn-select"))}}</td>
                <td id="presetStep"><button type="button" onclick="startTheTour(event)">?</button></td>
              </tr>
            </table>
            <table class="full">
              <colgroup><col class="small"/><col class="half" /><col class="half" /><col class="small"/></colgroup>
              <tr>
                <td class="small"><div class="random"><button id="tourianRandom" type="button" onclick="randomize(event, 'tourian')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                <td><span id="tourianText">Endgame behaviour with Tourian:</span></td>
                <td>{{displayMultiSelect("tourian", currentMultiValues["tourian"], "Vanilla", defaultMultiValues["tourian"])}}</td>
                <td id="tourianStep"><button type="button" onclick="startTheTour(event)">?</button></td>
              </tr>
            </table>
            <table class="full">
              <colgroup><col class="small"/><col class="half" /><col class="half" /><col class="small"/></colgroup>
              <tr>
                <td class="small"><div class="random"><button id="startLocationRandom" type="button" onclick="randomize(event, 'startLocation')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                <td><span id="startLocationText">Start location:</span></td>
                <td>{{displayMultiSelect("startLocation", currentMultiValues["startLocation"], "Landing Site", defaultMultiValues["startLocation"])}}</td>
                <td id="StartLocationStep"><button type="button" onclick="startTheTour(event)">?</button></td>
              </tr>
              <tr>
                <td class="small"><div class="random"><button id="majorsSplitRandom" type="button" onclick="randomize(event, 'majorsSplit')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                <td><span id="majorsSplitText">Majors Split:</span></td>
                <td>{{displayMultiSelect("majorsSplit", currentMultiValues["majorsSplit"], "Full", defaultMultiValues["majorsSplit"])}}</td>
                <td id="majorsSplitStep"><button type="button" onclick="startTheTour(event)">?</button></td>
              </tr>
            </table>
            <table class="full" id="scavengerParams">
              <colgroup><col class="small"/><col class="quarter" /><col class="quarter" /><col class="small"/><col class="half"/><col class="small"/></colgroup>
              <tr>
                <td class="small"><div class="random"><button id="scavNumLocsRandom" type="button" onclick="randomize(event, 'scavNumLocs')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                <td id="scavNumLocsStep"><span id="scavNumLocsText">Mandatory locations to visit:</span></td>
                <td>{{displayNumber("scavNumLocs", "4", "17", "10", "1")}}</td>
                <td><button type="button" onclick="startTheTour(event)">?</button></td>
                <td id="scavRandomizedStep">{{displayCheckbox("scavRandomized")}}Randomize items in mandatory locations</td>
                <td><button type="button" onclick="startTheTour(event)">?</button></td>
              </tr>
            </table>
            <table class="full">
              <colgroup><col class="small"/><col class="half" /><col class="half" /><col class="small"/></colgroup>
              <tr id="maxDiffVisibility">
                <td class="small"></td>
                <td><span id="maxDifficultyText">Maximum difficulty for picking up an item:</span></td>
                <td>{{displaySelect("maxDifficulty", ['easy', 'medium', 'hard', 'harder', 'hardcore', 'mania', 'infinity'], "hardcore")}}</td>
                <td id="maxDifficultyStep"><button type="button" onclick="startTheTour(event)">?</button></td>
              </tr>
              <tr>
                <td class="small"><div class="random"><button id="progressionSpeedRandom" type="button" onclick="randomize(event, 'progressionSpeed')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                <td class="half"><span id="progressionSpeedText">Progression speed:</span></td>
                <td class="half">
                  {{displayMultiSelect("progressionSpeed", currentMultiValues["progressionSpeed"], "medium", defaultMultiValues["progressionSpeed"])}}
                </td>
                <td id="progSpeedStep"><button type="button" onclick="startTheTour(event)">?</button></td>
              </tr>
              <tr id="progDiffVisibility">
                <td class="small"><div class="random"><button id="progressionDifficultyRandom" type="button" onclick="randomize(event, 'progressionDifficulty')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                <td class="half"><span id="progressionDifficultyText">Progression difficulty:</span></td>
                <td class="half">{{displayMultiSelect("progressionDifficulty", currentMultiValues["progressionDifficulty"], "normal", defaultMultiValues["progressionDifficulty"], replace=False)}}</td>
                <td id="progDiffStep"><button type="button" onclick="startTheTour(event)">?</button></td>
              </tr>
              <tr id="morphPlacementVisibility">
                <td class="small"><div class="random"><button id="morphPlacementRandom" type="button" onclick="randomize(event, 'morphPlacement')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                <td class="half"><span id="morphPlacementText">Morph Placement:</span></td>
                <td class="half">{{displayMultiSelect("morphPlacement", currentMultiValues["morphPlacement"], "normal", defaultMultiValues["morphPlacement"])}}</td>
                <td id="morphPlacementStep"><button type="button" onclick="startTheTour(event)">?</button></td>
              </tr>
              <tr id="suitsRestrictionVisibility">
                <td class="small"><div class="random"><button id="suitsRestrictionRandom" type="button" onclick="randomize(event, 'suitsRestriction')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                <td colspan="2">{{displayCheckbox("suitsRestriction")}}<span id="suitsRestrictionText">Suits restriction</span></td>
                <td id="suitsRestrictionStep"><button type="button" onclick="startTheTour(event)">?</button></td>
              </tr>
              <tr id="hideItemsVisibility">
                <td class="small"><div class="random"><button id="hideItemsRandom" type="button" onclick="randomize(event, 'hideItems')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                <td colspan="2">{{displayCheckbox("hideItems")}}<span id="hideItemsText">Hide some items</span></td>
                <td id="hideItemsStep"><button type="button" onclick="startTheTour(event)">?</button></td>
              </tr>
            </table>
            <div id="objectivesVisibility">
              <h4>Objectives to Access Tourian</h4>
              <table class="full">
                <colgroup><col class="small"/><col class="half" /><col class="half" /><col class="small"/></colgroup>
                <tr id="nbObjectivesRequiredVisiblity">
                  <td class="small"><div class="random"><button id="nbObjectivesRequiredRandom" type="button" onclick="randomize(event, 'nbObjectivesRequired')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                  <td><span id="nbObjectivesRequiredText">Number of required objectives:</span></td>
                  <td>
                    <select class="full" id="nbObjectivesRequired" name="nbObjectivesRequired" style="display: block;" value="{{response.write(session.randomizer.get('nbObjectivesRequired', 'off'))}}">
                      <option selected="selected" value="off">all</option>
                      <option value="1">1</option>
                      <option value="2">2</option>
                      <option value="3">3</option>
                      <option value="4">4</option>
                      <option value="5">5</option>
                      <option value="6">6</option>
                      <option value="7">7</option>
                      <option value="8">8</option>
                      <option value="9">9</option>
                    </select>
                  </td>
                  <td id="nbObjectivesRequiredStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr id="nbObjectiveVisiblity">
                  <td class="small"><div class="random"><button id="nbObjectiveRandom" type="button" onclick="randomize(event, 'nbObjective')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                  <td><span id="nbObjectiveText">Number of possible objectives:</span></td>
                  <td>{{displayNumber("nbObjective", "1", "18", "4", "1")}}</td>
                  <td id="nbObjectiveStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr id="hiddenObjectivesVisibility">
                  <td class="small"></td>
                  <td colspan="2">{{displayCheckbox("hiddenObjectives")}}<span id="hiddenObjectivesText">Hidden Objectives</span></td>
                  <td id="hiddenObjectivesStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr>
                  <td class="small"><div class="random"><button id="objectiveRandom" type="button" onclick="randomizeObjective(event)" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                  <td><span id="objectiveText">Objectives to access Tourian:</span></td>
                  <td>
                    <div id="objectivePortal" class="vue-app" />
                  </td>
                  <td id="objectiveStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
              </table>
            </div>
            <div id="itemsQuantityVisibility">
              <h4>Ammunition and Energy</h4>
              <h5>Quantity of Ammunition and Energy available</h5>
              <table class="full">
                <colgroup><col class="small"/><col class="half" /><col class="half" /><col class="small"/></colgroup>
                <tr>
                  <td class="small"><div class="random"><button id="minorQtyRandom" type="button" onclick="randomize(event, 'minorQty')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                  <td><span id="minorQtyText">Percentage of Ammunition (<img src="/solver/static/images/tracker/inventory/Missile.png" class="width: 32px"/>/<img src="/solver/static/images/tracker/inventory/Super.png" class="width: 32px"/>/<img src="/solver/static/images/tracker/inventory/PowerBomb.png" class="width: 32px"/>) available:</span></td>
                  <td>{{displayNumber("minorQty", "7", "100", "100")}}</td>
                  <td id="minorQtyStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr>
                  <td class="small"><div class="random"><button id="energyQtyRandom" type="button" onclick="randomize(event, 'energyQty')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                  <td><span id="energyQtyText">Quantity of Energy <img src="/solver/static/images/tracker/inventory/ETank.png" class="width: 32px"/> / Reserve Tanks <img src="/solver/static/images/tracker/inventory/Reserve.png" class="width: 32px"/> available:</span></td>
                  <td>{{displayMultiSelect("energyQty", currentMultiValues["energyQty"], "vanilla", defaultMultiValues["energyQty"])}}</td>
                  <td id="energyQtyStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
              </table>
            </div>
            <div id="minorsProportionVisibility">
              <h5>Ammunition distribution</h5>
              <table>
                <colgroup><col class="small"/><col class="half" /><col class="half" /><col class="small"/></colgroup>
                <tr>
                  <td class="small"><div class="random"><button id="missileQtyRandom" type="button" onclick="randomize(event, 'missileQty')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                  <td><span id="missileQtyText">Missiles <img src="/solver/static/images/tracker/inventory/Missile.png" class="width: 32px"/> proportion:</span></td>
                  <td>{{displayNumber("missileQty", "1", "9", "3", "0.1")}}</td>
                  <td id="missileQtyStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr>
                  <td class="small"><div class="random"><button id="superQtyRandom" type="button" onclick="randomize(event, 'superQty')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                  <td><span id="superQtyText">Super Missiles <img src="/solver/static/images/tracker/inventory/Super.png" class="width: 32px"/> proportion:</span></td>
                  <td>{{displayNumber("superQty", "1", "9", "3", "0.1")}}</td>
                </tr>
                <tr>
                  <td class="small"><div class="random"><button id="powerBombQtyRandom" type="button" onclick="randomize(event, 'powerBombQty')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                  <td><span id="powerBombQtyText">Power Bombs <img src="/solver/static/images/tracker/inventory/PowerBomb.png" class="width: 32px"/> proportion:</span></td>
                  <td>{{displayNumber("powerBombQty", "1", "9", "1", "0.1")}}</td>
                </tr>
                <tr id="strictMinorsVisibility">
                  <td class="small"><div class="random"><button id="strictMinorsRandom" type="button" onclick="randomize(event, 'strictMinors')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                  <td colspan="2">{{displayCheckbox("strictMinors")}}<span id="strictMinorsText">Strict Ammunition distribution</span></td>
                  <td id="strictMinorsStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
              </table>
            </div>
          </div>
          <div class="column">
            <h4>Areas Randomization</h4>
            <p>
              Add more randomness to your seed by randomizing the access between the areas.<br/>
              Check the help button for the map of the areas and the access points between them.
            </p>
            <table class="full">
              <tr id="areaRandomizationStep">
                <td class="small"><div class="random"><button id="areaRandomizationRandom" type="button" onclick="randomize(event, 'areaRandomization')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                <td class="half">
                  <div class="areaRandoDiv">
                    <span id="areaRandomizationText">Area Randomization:</span>
                  </div>
                </td>
                <td class="half">
                    <div>
                      {{displayMultiSelect("areaRandomization", currentMultiValues["areaRandomization"], "off", defaultMultiValues["areaRandomization"])}}
                    </div>
                  </div>
                </td>
                <td class="small">
                  <button type="button" onclick="startTheTour('areaRandomizationStep')">?</button>
                </td>
              </tr>
              <tr id="areaLayoutStep">
                <td class="small"></td>
                <td colspan="2" class="full">
                  <div class="flex-row">
                    <div class="flex-row__text">
                      <span id="areaLayout"></span>
                      <span id="areaLayoutText">Area Randomization Patches</span>
                    </div>
                    <div class="vue-app"></div>
                  </div>
                </td>
                <td class="small">
                  <button type="button" onclick="startTheTour('areaLayoutStep')">?</button>
                </td>
              </tr>
            </table>

            <h4>Doors Colors Randomization</h4>
            <table class="full">
              <tr>
                <td class="small"><div class="random"><button id="doorsColorsRandoRandom" type="button" onclick="randomize(event, 'doorsColorsRando')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                <td class="half" id="doorsColorsRandoStep">{{displayCheckbox("doorsColorsRando")}}<span id="doorsColorsRandoText">Randomize the color of Red/Green/Yellow doors</span></td>
                <td><button type="button" onclick="startTheTour(event)">?</button></td>
                <td class="half" id="doorsColorsGreyStep">{{displayCheckbox("allowGreyDoors")}}Allow some doors to be randomized to grey doors</td>
                <td><button type="button" onclick="startTheTour(event)">?</button></td>
              </tr>
            </table>
            <h4>Bosses Randomization</h4>
            <p>
              Randomize the access doors to the Golden 4 bosses.
            </p>
            <table class="full">
              <tr>
                <td class="small"><div class="random"><button id="bossRandomizationRandom" type="button" onclick="randomize(event, 'bossRandomization')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                <td colspan="3" class="full" id="bossRandomizationStep">{{displayCheckbox("bossRandomization")}}<span id="bossRandomizationText">Bosses randomization</span></td>
                <td><button type="button" onclick="startTheTour(event)">?</button></td>
              </tr>
              <tr>
                <td class="small"><div class="random"><button id="minimizerQtyRandom" type="button" onclick="randomizeMinimizer(event)" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                <td id="minimizerStep" class="half">{{displayCheckbox("minimizer")}}<span id="minimizerText">Boss rush, aka Minimizer</span></td>
                <td class="quarter"><span id="minimizerQtyText">Number of locations:</span></td>
                <td class="quarter">{{displayNumber("minimizerQty", "30", "100", "45", "1")}}</td>
                <td><button type="button" onclick="startTheTour(event)">?</button></td>
              </tr>
            </table>
            <div id="escapeRandoVisibility">
              <h4>Escape Randomization</h4>
              <table class="full">
                <tr>
                  <td class="small"><div class="random"><button id="escapeRandoRandom" type="button" onclick="randomize(event, 'escapeRando')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                  <td class="half" id="escapeRandoStep">{{displayCheckbox("escapeRando", False)}}<span id="escapeRandoText">Randomize the escape sequence</span></td>
                  <td><button type="button" onclick="startTheTour(event)">?</button></td>
                  <td class="half" id="removeEscapeEnemiesStep">{{displayCheckbox("removeEscapeEnemies", False)}}<span id="removeEscapeEnemiesText">Remove enemies during randomized escape sequence</span></td>
                  <td><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
              </table>
            </div>
            <div id="superFunVisibility">
              <h4>Super Fun Times&trade;</h4>
              <p>
                Have fun randomly removing major items!
              </p>
              <table class="full">
                <tr>
                  <td class="small" id="funCombatStep"><div class="random"><button id="funCombatRandom" type="button" onclick="randomize(event, 'funCombat')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                  <td class="third">{{displayCheckbox("funCombat")}}<span id="funCombatText">Super Fun Combat</span></td>
                  <td><button type="button" onclick="startTheTour(event)">?</button></td>

                  <td class="small" id="funMovementStep"><div class="random"><button id="funMovementRandom" type="button" onclick="randomize(event, 'funMovement')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                  <td class="third">{{displayCheckbox("funMovement")}}<span id="funMovementText">Super Fun Movement</span></td>
                  <td><button type="button" onclick="startTheTour(event)">?</button></td>

                  <td class="small" id="funSuitsStep"><div class="random"><button id="funSuitsRandom" type="button" onclick="randomize(event, 'funSuits')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                  <td class="third">{{displayCheckbox("funSuits")}}<span id="funSuitsText">Suitless</span></td>
                  <td><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
              </table>
            </div>
            <div>
              <h4 id="patchesStep">Patches</h4>
              <span class="rightStep"><button type="button" onclick="startTheTour(event)">?</button></span>
            </div>
            <div id="noPatchesVisibility">
              <p>Some patches are always applied, check out the '?' button to see them. Other optional patches are applied by default, use 'advanced' tab to see them.</p>
            </div>
            <div id="patchesVisibility">
              <p>Some patches are always applied, check out the '?' button to see them. Other optional patches are applied by default, use 'advanced' tab to see them.</p>
              <table class="full">
                <colgroup><col class="quarter" /><col class="threequarter" /><col class="check" /></colgroup>
                <tr><td colspan="2"><h5 class="center"><b>Randomizer adaptations (logic impact)</b></h5></td><td></td></tr>
              </table>
              <table class="full" id="mainPatchesVisibility">
                <tr id="layoutPatchesStep">
                  <td colspan="2" class="full">
                    <div class="flex-row">
                      <div class="flex-row__text">
                        <span id="layoutPatches"></span><!-- TODO remove these dummy elements? -->
                        Anti-softlock layout patches
                      </div>
                      <div class="vue-app"></div>
                    </div>
                  </td>
                  <td><button type="button" onclick="startTheTour('layoutPatchesStep')">?</button></td>
                </tr>
                <tr id="variaTweaksStep">
                  <td colspan="2" class="full">
                    <div class="flex-row">
                      <div class="flex-row__text">
                        <span id="variaTweaks"></span><!-- TODO remove these dummy elements? -->
                        VARIA tweaks
                      </div>
                      <div class="vue-app"></div>
                    </div>
                  </td>
                  <td><button type="button" onclick="startTheTour('variaTweaksStep')">?</button></td>
                </tr>
              </table>
              <table class="full" id="nerfedChargeVisibility">
                <tr>
                  <td class="half" id="nerfedChargeStep">
                    {{displayCheckbox("nerfedCharge")}}
                    Nerfed Charge Beam available from the start
                  </td>
                  <td><button type="button" onclick="startTheTour(event)">?</button></td>
                  <td id="relaxed_round_robin_cfStep" class="half">
                    {{displayCheckbox("relaxed_round_robin_cf")}}
                    Relaxed Round Robin Crystal Flash
                  </td>
                  <td><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
              </table>
              <table class="full" id="gravityBehaviourVisibility">
                <tr>
                  <td class="small" id="gravityBehaviourStep"><div class="random"><button id="gravityBehaviourRandom" type="button" onclick="randomize(event, 'gravityBehaviour')" class="small"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                  <td class="half"><span id="gravityBehaviourText">Suits properties</span></td>
                  <td class="half">
                    {{displayMultiSelect("gravityBehaviour", currentMultiValues["gravityBehaviour"], "Balanced", defaultMultiValues["gravityBehaviour"])}}
                  </td>
                  <td><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
              </table>
              <table class="full" id="helperPatchesVisibility">
                <colgroup><col class="half" /><col class="small"/><col class="half" /><col class="small"/></colgroup>
                <tr><td colspan="4"><h5 class="center"><b>Game comfort</b></h5></td></tr>
                <tr>
                  <td id="itemsoundsStep">
                    {{displayCheckbox("itemsounds")}}
                    Remove fanfare when picking up an item
                  </td>
                  <td><button type="button" onclick="startTheTour(event)">?</button></td>
                  <td>
                    <table class="full">
                      <tr>
                        <td id="ElevatorDoorsStep" class="half innertd">
                          {{displayCheckbox("fast_doors")}}
                          Accelerate doors
                        </td>
                        <td class="half innertd">
                          {{displayCheckbox("elevators_speed")}}
                          Accelerate elevators
                        </td>
                      </tr>
                    </table>
                  </td>
                  <td><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr>
                  <td id="spinjumprestartStep" class="half">
                    {{displayCheckbox("spinjumprestart")}}
                    Spin jump restart (a.k.a. Respin)
                  </td>
                  <td><button type="button" onclick="startTheTour(event)">?</button></td>
                  <td id="rando_speedStep" class="half">
                    {{displayCheckbox("rando_speed")}}
                     Momentum conservation (a.k.a. Speedkeep)
                  </td>
                  <td><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr>
                  <td id="Infinite_Space_JumpStep" class="half">
                    {{displayCheckbox("Infinite_Space_Jump")}}
                    Infinite Space Jump
                  </td>
                  <td><button type="button" onclick="startTheTour(event)">?</button></td>
                  <td id="refill_before_saveStep" class="half">
                    {{displayCheckbox("refill_before_save")}}
                     Refill energy and ammo when saving
                  </td>
                  <td><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr>
                  <td id="hudStep" class="half">
                    {{displayCheckbox("hud")}}
                     VARIA HUD
                  </td>
                  <td><button type="button" onclick="startTheTour(event)">?</button></td>
                  <td id="revealMapStep" class="half">
                    {{displayCheckbox("revealMap")}}
                     Reveal the whole map on start
                  </td>
                  <td><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr>
                  <td id="better_reservesStep" class="half">
                    {{displayCheckbox("better_reserves")}}
                     Better Reserves <img src="/solver/static/images/tracker/inventory/Reserve.png" class="width: 32px"/>
                  </td>
                  <td><button type="button" onclick="startTheTour(event)">?</button></td>
                  <td class="half"></td><td></td>
                </tr>
              </table>
              <table class="full">
                <colgroup><col class="quarter" /><col class="threequarter" /><col class="check" /></colgroup>
                <tr><td colspan="2"><h5 class="center"><b>Miscellaneous</b></h5></td><td></td></tr>
              </table>
              <table class="full" id="miscVisibility">
                <colgroup><col class="half" /><col class="half" /></colgroup>
                <tr>
                  <td id="animalsStep">
                    {{displayCheckbox("animals")}}
                    <span id="animalsText">Save the animals surprise</span>
                  </td>
                  <td></td>
                  <td><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
              </table>
              <table class="full" id="musicVisibility">
                <tr>
                  <td id="No_MusicStep" class="half">
                    {{displayCheckbox("No_Music")}}
                    Disable background music
                  </td>
                  <td><button type="button" onclick="startTheTour(event)">?</button></td>
                  <td id="random_musicStep" class="half">
                    {{displayCheckbox("random_music")}}
                    Randomize background music
                  </td>
                  <td><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
              </table>
            </div>
          </div>
        </div>
        <p class="customizerText">
          <a href="/customizer" target="_blank">You can randomize in-game colors and use a custom Samus sprite on the Customizer page</a>.
        </p>
        {{=INPUT(_type="submit", _value="Randomize", _id="submitBtn", _class="btn btn-default buttonRandom")}}
        {{=INPUT(_type="submit", _value="Randomize + Customize", _id="customizeBtn", _class="btn btn-default buttonRandom")}}
    </form>
  </div>
  <div id="app" />
{{ response.write(app_files, escape=False) }}
