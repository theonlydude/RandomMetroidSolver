{{
extend 'layout.html'
}}

<meta name="description" content="Palettizer for the randomized Super Metroid roms"/>
<link rel="shortcut icon" href={{=URL('static','favicon.ico')}} type="image/ico"/>
<script src="{{=URL('static','js/FileSaver.js')}}"></script>

<link rel="stylesheet" type="text/css" href={{=URL('static','dist/switchery.css')}} media="screen"/>
<script src="{{=URL('static','dist/switchery.js')}}"></script>

<link href={{=URL('static', 'css/bootstrap-tour.min.css')}} rel="stylesheet">
<script src="{{=URL('static','js/bootstrap-tour.min.js')}}"></script>

<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

<link rel="stylesheet" type="text/css" href="{{=URL('static','image-picker/image-picker.css')}}">
<script src="{{=URL('static', 'image-picker/image-picker.js')}}" type="text/javascript"></script>

<script type="text/javascript" src="{{=URL('static', 'js/crc32.js')}}"></script>

<script type="text/javascript" src="{{=URL('static', 'js/localforage.nopromises.min.js')}}"></script>
<script type="text/javascript" src="{{=URL('static', 'js/spc_snes.js')}}"></script>
<script type="text/javascript" src="{{=URL('static', 'js/jquery.redirect.js')}}"></script>

<script type="text/javascript" src="{{=URL('static', 'js/chosen.jquery.min.js')}}"></script>
<link rel="stylesheet" type="text/css" href={{=URL("static", "css/chosen.css")}} />

<title>Super Metroid VARIA Customizer</title>

<style>
{{include 'solver_web/varia.css'}}
.toDisable{
    pointer-events: none;
}
.lighter {
    background-color: #eee
}
.darker {
    background-color: #ddd
}
.song_in_list {
    cursor: pointer;
}
.drop_target {
    border: 1px solid #ddd;
}
.player_table {
    height: {{=len(musics["_list"])*2*1.5}}em;
    overflow-y: auto;
    overflow-x: hidden;
    border-top: 2px solid #aaa;
}
.align_right {
    text-align: right;
}
.align_center {
    text-align: center;
}
.spc_player {
    border: 2px solid #aaa;
}
.music_button {
    cursor: pointer;
    width: 4em;
}
#controlPlayer {
    cursor: pointer;
    width: 2em;
}
.margin_top {
    margin-top: 1em;
}
.bold {
    font-weight: bold;
}
.center_image {
    display: block;
    margin-left: auto;
    margin-right: auto;
}
th {
    border-bottom: 1px solid #ddd;
}
h1 {
  text-align: center;
  color: #444;
  margin-top: 50px;
}

#slider-container {
  width: 80%;
  height: 80px;
  box-sizing: border-box;
  position: relative;
  top: 50%;
  margin: 0 auto;
  text-align: center;
  background: #FFF;
  padding: 35px 40px 30px 40px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

.ui-slider, .ui-slider .slider-range-inverse, .ui-slider .ui-slider-range {
  height: 14px;
  border-radius: 0px;
  border-width: 0;
}
.ui-slider {
  background-color: #1ABC9C;
  background-image: linear-gradient(to right, #0000e8 0%, #e80074 25%, #e8e800 50%, #00e874 75%, #0000e8 100%);
}
.ui-slider * {
  outline: none;
}
.ui-slider .slider-range-inverse0 {
  background: #CCC;
  position: absolute;
  left: 0;
  height: 12px;
}
.ui-slider .slider-range-inverse1 {
  background: #CCC;
  position: absolute;
  right: 0;
  height: 12px;
}
.ui-slider .ui-slider-range {
  background: transparent;
}
.ui-slider .ui-slider-handle {
  width: 6px;
  height: 20px;
  cursor: pointer;
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
  background: #FFF;
  top: -4px;
  border-width: 0;
  margin-left: -3px;
}
.ui-slider .ui-slider-handle:active {
  box-shadow: 0 3px 20px rgba(0, 0, 0, 0.5);
}
.ui-slider .ui-slider-handle .dot {
  width: 4px;
  height: 18px;
  position: absolute;
  top: 1px;
  left: 1px;
  background: transparent;
  overflow: hidden;
}
.ui-slider .ui-slider-handle .dot .handle-track0 {
  display: block;
  height: 18px;
  background-color: #1ABC9C;
  background-image: linear-gradient(to right, #0000e8 0%, #e80074 25%, #e8e800 50%, #00e874 75%, #0000e8 100%);
  position: absolute;
  margin-left: 0px;
}
.ui-slider .ui-slider-handle .dot .handle-track1 {
  display: block;
  height: 18px;
  background-color: #1ABC9C;
  background-image: linear-gradient(to right, #0000e8 0%, #e80074 25%, #e8e800 50%, #00e874 75%, #0000e8 100%);
  position: absolute;
  margin-left: 8px;
}

.popover {
    max-width: 30%;
}
.highslide-dimming {
    background: black;
}
.sixty {
    width: 65%
}
.thirty {
    width: 30%
}
.floatright {
    float: right;
    /* vertical-align: top; */
    margin-top: -1em;
}
.floatleft {
    float: left;
    /* vertical-align: top; */
    margin-right: 0.5em;
}
.border {
    border: 1px solid #cccccc;
    padding-left: 1em;
    padding-right: 1em;
    margin-bottom: 0.5em;
    margin-top: 0.5em;
}
</style>

<script type="text/javascript">
$(document).ready(function(){
   jQuery(window).on('resize', resizeElements);
});

var guid = undefined;
{{
if seedInfo is not None:
    response.write("guid = '{}';".format(seedInfo["key"]), escape=False)
    pass
}}
function DoPost(){
    if(guid != undefined) {
        $.redirect("/randomizer/"+guid, {}, "POST", "_blank");
    }
}

function resizeElements() {
    resizeSlider();
    resizeChosen();
}

function resizeChosen() {
   $(".chosen-container").each(function() {
       $(this).attr('style', 'width: 100%');
   });
}

function resizeSlider() {
   var slider = $("#degree_slider_range");
   var width = slider.width();

   // set new handle tracks width
   slider.find(".handle-track0").css("width", width);
   slider.find(".handle-track1").css("width", width);

   update_handle_track_pos(slider, slider.slider("values", 0), 0);
   update_handle_track_pos(slider, slider.slider("values", 1), 1);
}

var globalSwitchs = {};
// value from permalink seed
var beamDoorsPatch = {{="true" if seedParams != None and seedParams["doorsColorsRando"] == "on" else "false"}};

function ajaxFail(jqXHR, textStatus) {
  document.getElementById("flash").innerHTML = jqXHR.responseText;
  $('#flash').show();
}

function ajaxFailJSON(jqXHR, textStatus) {
  if(jqXHR.responseJSON == null) {
    document.getElementById("flash").innerHTML = "Something wrong happened with the customizer.";
  } else {
    document.getElementById("flash").innerHTML = jqXHR.responseJSON;
  }
  $('#flash').show();
}

function unpack_3bytes(ips, i) {
  var b1 = ips[i];
  var b2 = ips[i+1];
  var b3 = ips[i+2];
  return (b1*65536) + (b2*256) + b3;
}

function unpack_2bytes(ips, i) {
  var b1 = ips[i];
  var b2 = ips[i+1];
  return (b1*256) + b2;
}

function updateROM(bytes, data, filename) {
    // with custom sprites we have to create a bigger array
    if( ("ips" in data && "max_size" in data && data["max_size"] > 0x300000) || romSize > 0x300000) {
        var size = 0x400000;
        var is4MB = true;
    } else {
        var is4MB = false;
        var size = romSize;
    }

    // always make a copy to avoid modifying vanilla rom buffer from local storage
    var tmp = new Uint8Array(size);
    tmp.set(bytes);
    bytes = tmp;

    var binary_string = atob(data["ips"]);
    var len = binary_string.length;
    var ips = new Uint8Array(len);
    for(var i = 0; i < len; i++) {
        ips[i] = binary_string.charCodeAt(i);
    }

    console.log("IPS size: "+ips.length);
    var i = 5;
    var offset = 0;
    var size = 0;
    var rle_size = 0;

    while(i < ips.length - 3) {
        offset = unpack_3bytes(ips, i);
        i += 3;
        size = unpack_2bytes(ips, i);
        i += 2;

        if(size == 0) {
            // RLE
            rle_size = unpack_2bytes(ips, i);
            i += 2;
            for(j=0; j<rle_size; j++) {
                bytes[offset+j] = ips[i];
            }
            i += 1;
        } else {
            for(j=0; j<size; j++) {
                bytes[offset+j] = ips[i+j];
            }
            i += j;
        }
    }

    // fix checksum
    var sum1 = 0;
    for(var i=0; i<0x200000; i++) { sum1 += bytes[i]; }
    var sum2 = 0;
    var max = 0x300000;
    if(is4MB == true){ max = 0x400000; }
    for(var i=0x200000; i<max; i++) { sum2 += bytes[i]; }
    if(is4MB == true){
        var sum = (sum1 + sum2) & 0xFFFF;
    } else {
        var sum = (sum1 + (sum2 * 2)) & 0xFFFF;
    }
    var sumlo = sum & 0x00FF;
    var sumhi = (sum & 0xFF00) >> 8;
    var invSum = sum ^ 0xFFFF;
    var invSumlo = invSum & 0x00FF;
    var invSumhi = (invSum & 0xFF00) >> 8;
    bytes[0x7FDC] = invSumlo;
    bytes[0x7FDD] = invSumhi;
    bytes[0x7FDE] = sumlo;
    bytes[0x7FDF] = sumhi;

    var blob = new Blob([bytes], {type: "octet/stream"});
    saveAs(blob, filename);

    // check if widescreen patch was added
    if(bytes[0xd8] == 0x40) {
        // create blob to store bso configuration file
        var blob = new Blob([getBSO()], {type: "text/plain;charset=utf-8"});
        var bsoFilename = filename.slice(0, -3) + 'bso'
        saveAs(blob, bsoFilename);
    }
}

function AjaxCallCompleted(data) {
    console.log("AjaxCallCompleted");

    // with items/Locations patch the local rom in memory
    if(permalink == true) {
        var inputName = "vanillaUploadFile";
{{
if seedInfo != None:
    response.write('        updateROM(vanillaROMBytes, data, "Custom_{}");'.format(seedInfo["filename"]), escape=False)
    pass
}}
    } else {
        var inputName = "uploadFile";
        var filesInput = document.getElementById(inputName);
        var file = filesInput.files[0];

        var reader = new FileReader();
        reader.fileName = file.name;
        reader.readAsArrayBuffer(file);

        reader.onload = function(e) {
            var bytes = new Uint8Array(e.target.result);

            updateROM(bytes, data, "Custom_"+e.target.fileName);
        }
    }

    // info message to display ?
    if("errorMsg" in data && data["errorMsg"].length > 0) {
        document.getElementById("flash").innerHTML = data["errorMsg"];
        $('#flash').show();
        displayFlash = true;
    } else {
        displayFlash = false;
    }

    // set backup button text to customize
    document.getElementById("submitBtn").data = buttonText;

    // remove "working" message
    if(displayFlash == false){
        $('#flash').hide();
    }
}

function doSubmit() {
    if(window.File && window.FileList && window.FileReader) {

        if(permalink == true) {
            if(vanillaROMBytes == null) {
                alert("Please select a vanilla ROM first");
                return false;
            }
        } else {
            var inputName = "uploadFile";
            var filesInput = document.getElementById(inputName);
            var file = filesInput.files[0]
            if (file === undefined) {
                alert("Please select a VARIA seed first");
                return false;
            }
        }

        var dataDict = {};
        dataDict["logic"] = logic;
        var elems = ["itemsounds", "spinjumprestart", "rando_speed", "elevators_speed", "fast_doors", "Infinite_Space_Jump", "refill_before_save", "better_reserves", "widescreen", "AimAnyButton", "max_ammo_display", "supermetroid_msu1", "base", "colorsRandomization", "suitsPalettes", "beamsPalettes", "tilesPalettes", "enemiesPalettes", "bossesPalettes", "globalShift", "customSpriteEnable", "customItemsEnable", "noSpinAttack", "customShipEnable", "remove_itemsounds", "remove_elevators_speed", "remove_fast_doors", "remove_Infinite_Space_Jump", "remove_rando_speed", "remove_spinjumprestart", "gamepadMapping", "lava_acid_physics", "hell", "hard_mode", "color_blind", "disable_screen_shake", "noflashing"];

        for(var i=0; i<elems.length; i++) {
            var elem = document.getElementById(elems[i]);
            if(elem.disabled == true) {
                dataDict[elems[i]] = "off";
            } else {
                dataDict[elems[i]] = elem.value;
            }
        }

        var multiElems = ["customSprite", "customShip"];
        for(var i=0; i<multiElems.length; i++) {
            var elemId = multiElems[i];
            // check if elem is disabled
            var elem = document.getElementById(elemId);
            if(elem.disabled == true) {
                dataDict[elems[i]] = "off";
            } else {
                // check if random dice is checked
                if(isElemIdRandom(elemId)) {
                    dataDict[elemId] = "random";
                    multiElemId = elemId+"MultiSelect";
                    dataDict[multiElemId] = $('#'+elemId).data('picker').selected_values().join();
                } else {
                    dataDict[elemId] = elem.value;
                }
            }
        }

        // disabled for race seeds, but we don't want the 'off' value set for disabled elements as they're numbers
        dataDict["hellrun_rate"] = document.getElementById("hellrun_rate").value;
        dataDict["etanks"] = document.getElementById("etanks").value;

        dataDict["minDegree"] = $("#degree_slider_range").slider("values", 0);
        dataDict["maxDegree"] = $("#degree_slider_range").slider("values", 1);

        if(invertSlider == true) {
            dataDict["invert"] = "on";
        } else {
            dataDict["invert"] = "off";
        }

        if(permalink == true) {
            dataDict["seedKey"] = seedKey;
        }

        if(beamDoorsPatch == true) {
            dataDict["no_blue_door_palette"] = "on";
        } else {
            dataDict["no_blue_door_palette"] = "off";
        }

        dataDict["music"] = document.getElementById("music").value;
        if(dataDict["music"] == "Customize") {
            for(var i=0; i<musicIds.length; i++) {
                var id = musicIds[i];
                dataDict[id] = document.getElementById(id).innerHTML;
            }
            dataDict["varia"] = isVARIA;
            dataDict["area"] = isArea;
            dataDict["boss"] = isBoss;
        }

        if(dataDict["gamepadMapping"] == "on") {
            dataDict["preset"] = document.getElementById("preset").value;
        }

        console.log("before customizer web service call");

        // call customizer web service with parameters
        var request = $.ajax({
            url: "{{=URL(f='customWebService')}}",
            method: "POST",
            data: dataDict,
            dataType: "json"
        });

        request.done(AjaxCallCompleted);
        request.fail(ajaxFail);
    }

    return false;
}

function musicSelectChange() {
    var elem = document.getElementById("music");
    var musicCustom = document.getElementById("musicCustomizer");
    if(elem.value == "Customize") {
        musicCustom.style.display = "block";
    } else {
        musicCustom.style.display = "none";
        stopSong();
    }
}

var musicIds = {{response.write([songId for song, songId in musics["_list"]], escape=False)}};
var musicList = {{response.write([[songId, song] for song, songId in musics["_list"]], escape=False)}};
var musics = {
{{
    for song, data in musics.items():
      if song in ["_dropdown", "_list"]:
        continue
      if data.get("group") in ["Vanilla Soundtrack - Sound Effects", "Memory Violation"]:
        continue
      response.write('  "{}": {{\n'.format(song), escape=False)
      for key, value in data.items():
        if key in ["original_author", "port_author", "description"]:
          response.write('    "{}": "{}",\n'.format(key, value), escape=False)
          pass
        pass
      response.write("  },\n", escape=False)
      pass
}}
};

var playerState = "stopped";
var currentSong = "";
var audioContext = null;

function setPlayerButton(button) {
    var names = ["play", "download", "stop"];
    for(var i=0; i<names.length; i++) {
        if(names[i] == button){
            document.getElementById(names[i]).style.display = "block";
        } else {
            document.getElementById(names[i]).style.display = "none";
        }
    }
}

function loadNewSongFromId(elemId) {
    var song = document.getElementById(elemId).innerHTML;
    loadNewSong(song);
}

function loadNewSong(song) {
    if(playerState == "downloading") {
        return;
    }
    // first innerHTML modification will change scroll, so store it to restore at the end
    var scroll = $(window).scrollTop();
    stopSong();

    // if error with previous song, remote the popup
    $('#flash').hide();

    var previousSong = currentSong;
    currentSong = song;

    // display song metadatas
    document.getElementById("player_port_author").innerHTML = musics[currentSong]["port_author"];
    document.getElementById("player_original_author").innerHTML = musics[currentSong]["original_author"];
    document.getElementById("player_desc").innerHTML = musics[currentSong]["description"];
    document.getElementById("player_song").innerHTML = currentSong;

    // highligth song in list
    highligthSong(previousSong, currentSong);

    // autoplay
    action_play();
    $("html").scrollTop(scroll);
}

function highligthSong(previousSong, currentSong) {
    if(previousSong != "") {
        $( '.song_in_list:contains("'+previousSong+'")').css( "background-color", "#eee" );
    }
    var curElem = $( '.song_in_list:contains("'+currentSong+'")');
    curElem.css( "background-color", "#f0f57f" );

    // change table scroll to have song visible
    var player_table = $('.player_table');
    player_table.scrollTop(player_table.scrollTop() + (curElem.position().top - player_table.position().top) - (player_table.height()/2) + (curElem.height()/2)  );
}

function action_play() {
    if(currentSong == "" || playerState != "stopped") {
        return;
    }
    setPlayerButton("download");
    playerState = "downloading";
    var request = $.ajax({
      url: "{{=URL(f='getSpcFile')}}",
      method: "POST",
      data: {"songName": currentSong},
      dataType: "json"
    });

    request.done(spcFileDownloaded);
    request.fail(ajaxPlayerFail);
}

function spcFileDownloaded(data) {
    console.log("spcFileDownloaded");
    playerState = "stopped";

    var binary_string = atob(data["spc"]);
    var len = binary_string.length;
    var spc = new Uint8Array(len);
    for(var i = 0; i < len; i++) {
        spc[i] = binary_string.charCodeAt(i);
    }

    playSong(spc);
}

function ajaxPlayerFail(jqXHR, textStatus) {
    ajaxFail(jqXHR, textStatus);
    setPlayerButton("play");
    playerState = "stopped";
}

function stopSong() {
    if(audioContext == null) {
        return;
    }
    audioContext.close();
    audioContext = null;
    playerState = "stopped";
    setPlayerButton("play");
}

function playSong(spcData) {
    audioContext = new AudioContext();
    spc = allocate(spcData, 'i8', ALLOC_STACK);
    _my_init(spc, spcData.length);
    frame_size=16384;
    in_rate=32000;
    out_rate=audioContext.sampleRate;
    initial_offset=0;
    ratio=in_rate/out_rate;
    final_offset=frame_size*ratio;
    last_sample=1+Math.floor(final_offset);
    chan=0;
    sample=function(x){
        offset=initial_offset+ratio*x;
        buffer_offset=Math.floor(offset);
        if(buffer_offset+1>last_sample){throw "error";};
        high=offset-buffer_offset;
        low=1-high;
        low_val=HEAP16[chan+buf/2+(buffer_offset)*2]*low;
        high_val=HEAP16[chan+buf/2+(buffer_offset+1)*2]*high;
        return(low_val+high_val);
    }

    buf_size=4*(last_sample-1);
    buf=allocate(new Uint8Array(buf_size+4), 'i8', ALLOC_STACK);

    audioNode = audioContext.createScriptProcessor(frame_size, 0, 2);
    audioNode.onaudioprocess = function(audioProcessingEvent) {
        _my_decode(buf,last_sample*2);
        outputBuffer = audioProcessingEvent.outputBuffer;
        for (chan = 0; chan < outputBuffer.numberOfChannels; chan++) {
            out_data=outputBuffer.getChannelData(chan);
            for(var k=0;k<out_data.length;k++){
                out_data[k]=sample(k)/32000;
            }
        }
    }
    audioNode.connect(audioContext.destination);
    playerState = "playing";
    setPlayerButton("stop");
}

// songs drag & drop
function allowDrop(ev) {
    ev.preventDefault();
}

function drag(ev) {
    ev.dataTransfer.setData("text", ev.target.innerHTML);
}

function drop(ev) {
    ev.preventDefault();
    var data = ev.dataTransfer.getData("text");
    ev.target.innerHTML = data;
}

function resetPlaylist() {
    var scroll = $(window).scrollTop();
    for(var i=0; i<musicList.length; i++) {
        var id = musicList[i][0];
        var song = musicList[i][1];
        document.getElementById(id).innerHTML = song;
    }
    $("html").scrollTop(scroll);
}

function randomizePlaylist() {
    var scroll = $(window).scrollTop();
    var keys = Object.keys(musics);
    var alreadyUsed = [];
    for(var i=0; i<musicIds.length; i++) {
        var r = Math.floor(keys.length * Math.random());
        var randomSong = keys[r];
        while(alreadyUsed.includes(randomSong)) {
            // reroll
            r = Math.floor(keys.length * Math.random());
            randomSong = keys[r];
        }
        alreadyUsed.push(randomSong);
        var id = musicIds[i];
        document.getElementById(id).innerHTML = randomSong;
    }
    // set same song for intro and menu
    document.getElementById("Menutheme").innerHTML = document.getElementById("Titlesequenceintro").innerHTML
    // set same song for both WS
    document.getElementById("WreckedShipPoweron").innerHTML = document.getElementById("WreckedShipPoweroff").innerHTML
    $("html").scrollTop(scroll);
}

function savePlaylist() {
    // ask user for playlist name
    var filename = prompt("What is your playlist name?");
    if(filename == null) {
        return false;
    }

    var playlist = {};
    for(var i=0; i<musicIds.length; i++) {
        var id = musicIds[i];
        var song = document.getElementById(id).innerHTML;
        playlist[id] = song;
    }

    var blob = new Blob([JSON.stringify(playlist, null, 2)], {type: "text/plain"});
    saveAs(blob, filename+'.json');
}

function loadPlaylist() {
    var fileSelector = $('<input type="file" onchange="loadPlaylistCallbak(event)">');
    fileSelector.click();
}

function loadPlaylistCallbak(e) {
    var file = e.target.files[0];
    var reader = new FileReader();
    reader.readAsDataURL(file);

    reader.onload = function(readerEvent) {
        var content = readerEvent.target.result;
        (async function () {
            const response = await fetch(content);
            const data = await response.json();
            var keys = Object.keys(data);

            for(var i=0; i<keys.length; i++) {
                var id = keys[i];
                var song = data[id];
                var elem = document.getElementById(id);
                // don't crash if song in playlist is not in the GUI
                if(elem) {
                    elem.innerHTML = song;
                }
            }
        })();
    }
}

function disableElement(id, disable) {
    var elem = document.getElementById(id);
    // we have to enable it before updating it as we can't update a disabled element
    if(! disable) {
        elem.disabled = false;
    }
    // grey out the disabled text
    var text = document.getElementById(id+"Text");
    if(disable) {
        text.className = "disabledText";
    } else {
        text.className = "";
    }
    // set switch to off, else users could think that the switch is forced to on
    if(disable && elem.checked) {
        elem.click();
        elem.value = "off";
    }
    // tell switchery
    if(id in globalSwitchs) {
        var sw = globalSwitchs[id];
        if(disable) {
            sw.disable();
        } else {
            sw.enable();
        }
    }
    // we have to disable it after updating it as we can't update a disabled element
    if(disable) {
        elem.disabled = true;
    }
}

var buttonText = "Customize";
var permalink = false;
var seedKey = null;
var isVARIA = false;
var isArea = false;
var isBoss = false;
var logic = "vanilla";
{{
if seedInfo != None:
    response.write("permalink = true;", escape=False)
    response.write("seedKey = '{}';".format(seedInfo["key"]), escape=False)
    response.write("isVARIA = true;", escape=False)
    response.write("isArea = {};".format("true" if seedParams["areaRandomization"] in ["full", "light", "random"] else "false"), escape=False)
    response.write("isBoss = {};".format("true" if seedParams["bossRandomization"] in ["on", "random"] else "false"), escape=False)
    response.write("logic = '{}';".format(seedParams.get("logic", "vanilla")), escape=False)
    pass
}}

function greyOutPatches(isRace, isVARIA, isVanilla) {
    var buttons = ["itemsounds", "elevators_speed", "fast_doors", "spinjumprestart", "rando_speed", "Infinite_Space_Jump", "refill_before_save", "better_reserves", "widescreen", "lava_acid_physics", "hell", "hellrun_rate", "etanks", "hard_mode"];
    for(var i=0; i<buttons.length; i++) {
        disableElement(buttons[i], isRace);
    }

    var buttons = ["AimAnyButton", "max_ammo_display", "supermetroid_msu1", "base"];
    for(var i=0; i<buttons.length; i++) {
        disableElement(buttons[i], isVARIA);
    }

    // grey out random music when vanilla rom is detected as it'll crash
    if(isVanilla == true) {
        disableElement("random_music", true);
        disableElement("widescreen", true);
    }

    // set noSpinAttack to on when a race seed is detected
    var noSpinAttack = document.getElementById("noSpinAttack");
    if(isRace && noSpinAttack.disabled == false) {
        var noSpinAttack = document.getElementById("noSpinAttack");
        if(! noSpinAttack.checked) {
            noSpinAttack.click();
            noSpinAttack.value = "on";
        }
    }
}

// for random sprites/ships
var customSpriteMultiSelect = {{response.write(session.customizer["customSpriteMultiSelect"], escape=False)}};
var customShipMultiSelect = {{response.write(session.customizer["customShipMultiSelect"], escape=False)}};

function isElemRandom(elem) {
    return elem.className.search("active") != -1;
}

function isElemIdRandom(elemId) {
    return isElemRandom(document.getElementById(elemId+"Random"));
}

function randomizeTarget(evt, elemId) {
    var e = document.getElementById(elemId);

    var isActive;
    if(isElemRandom(evt.currentTarget)) {
        evt.currentTarget.className = evt.currentTarget.className.replace(" active", "");
        isActive = false;

        // store multiple selected values for next time the dice is pressed
        var selected_values = $('#'+elemId).data('picker').selected_values();
        if(elemId == "customSprite") {
            customSpriteMultiSelect = selected_values;
        } else {
            customShipMultiSelect = selected_values;
        }
        // go back to single selection
        $('#'+elemId).prop('multiple', false);
    } else {
        evt.currentTarget.className += " active";
        isActive = true;
        $('#'+elemId).prop('multiple', true);

        // set selected values, default to all selected
        if(elemId == "customSprite") {
            $('#'+elemId).val(customSpriteMultiSelect);
        } else {
            $('#'+elemId).val(customShipMultiSelect);
        }
    }

    // recreate select with updated multiple
    $('#'+elemId).data('picker').destroy();
    var params = {};
    if(elemId == "customSprite") {
        params = {show_label: true};
    }
    $('#'+elemId).imagepicker(params);
}

function setRandom() {
{{
    for id in ["customSprite", "customShip"]:
      if session.customizer.get(id, None)  == "random":
        response.write("  document.getElementById(\"{}Random\").click();\n".format(id), escape=False)
        pass
      pass
}}
}


var vanillaROMBytes = null;
var romSize = 0x300000;
{{
if seedInfo != None and seedInfo["raceMode"] == 'on':
    response.write("var isRace = true;", escape=False)
else:
    response.write("var isRace = false;", escape=False)
    pass
}}
window.onload = function(){
    //Check File API support
    if(window.File && window.FileList && window.FileReader) {
        if(permalink == true) {
            var inputName = "vanillaUploadFile";
        } else {
            var inputName = "uploadFile";
        }
        var filesInput = document.getElementById(inputName);
        filesInput.addEventListener("change", function(event){
            var files = event.target.files; //It returns a FileList object
            var file = files[0];

            var reader = new FileReader();
            reader.onload = function(e) {
                // check sfc or smc extention
                var re = /(?:\.([^.]+))?$/;
                var ext = re.exec(file.name)[1];
                console.log("ext: "+ext)
                if( ! (ext === "sfc" || ext === "smc" || ext === "SFC" || ext === "SMC") ) {
                    document.getElementById("uploadFile").value = "";
                    alert("wrong extension: "+ext);
                    return false;
                }

                romSize = file.size;
                if( romSize > 4*1024*1024 ) {
                    document.getElementById("uploadFile").value = "";
                    alert("wrong rom file size: "+romSize.toString());
                    return false;
                }

                var crc32 = new Crc32();
                crc32.update(e.target.result);
                var digest = crc32.digest();
                console.log("crc32: "+digest);
                var isVanilla = digest == "d63ed5f8";

                if(permalink == true) {
                    if(! isVanilla) {
                        alert("Non vanilla ROM detected");
                        document.getElementById(inputName).value = "";
                        return false;
                    }

                    // store file in localforage
                    localforage.setItem('vanillaROM', e.target.result, function(err, value) {
                        if(err != null) {
                            console.log("error detected with local storage: "+err);
                            clearLocalStorage();
                        } else {
                            console.log("vanilla ROM stored in local storage");
                            vanillaROMBytes = new Uint8Array(value);
                            displayROMInput(false);
                        }
                    });

                } else {
                    // detect race mode patch
                    isRace = false;
                    var bytes = new Uint8Array(e.target.result);
                    for(var addr=0x1C0200; addr<0x1C0210; addr++) {
                        if(bytes[addr] != 0xff) {
                            isRace = true;
                            console.log("race mode detected");
                            break;
                        }
                    }

                    // detect varia default patches
                    isVARIA = false;
                    if(bytes[0x175ca] == 0x60 && bytes[0x19E1] == 0xEA && bytes[0xF27] == 0x20) {
                        isVARIA = true;
                    }

                    // detect beam doors patch from seed to customize
                    beamDoorsPatch = bytes[0x226e5] == 0x0D;
                    // detect area layout patch
                    isArea = bytes[0x788A0] == 0x2b;
                    // detect Phantoon_Eye_Door patch
                    isBoss = bytes[0x7ccaf] == 0x91;

                    // detect logic
                    logic = "vanilla";
{{
    for logic, values in flavorPatches.items():
        response.write("                    if(bytes["+str(values['address'])+"] == "+str(values['value'])+") { logic = '"+logic+"'; }\n", escape=False)
        pass
}}
                    console.log("isArea: "+isArea+" isBoss: "+isBoss+" isVARIA: "+isVARIA+" isRace: "+isRace+" logic: "+logic);

                    greyOutPatches(isRace, isVARIA, isVanilla);
                }
            }

            reader.readAsArrayBuffer(file)

        }, false);
    } else {
        alert("This website requires the HTML5 File API, please upgrade your browser to a newer version.");
    }


    var inputs = document.getElementsByTagName("input");
    for(var i = 0; i < inputs.length; i++) {
        if(inputs[i].type == "checkbox") {
            // progression speed checkboxes don't need switchery, so they don't have a name property
            if(inputs[i].name != "") {
              var s = new Switchery(document.getElementById(inputs[i].name), { size: 'small', color: '#ddd' });
              globalSwitchs[inputs[i].name] = s;
            }
        }
    }

    // color checkboxes
    var colorRando = document.getElementById("colorsRandomization");
    colorRando.onchange = setColorRando;

    var customSpriteEnable = document.getElementById("customSpriteEnable");
    customSpriteEnable.onchange = enableCustomSpriteDropdown;

    var customShipEnable = document.getElementById("customShipEnable");
    customShipEnable.onchange = enableCustomShipDropdown;

    var remove_elevators_speed = document.getElementById("remove_elevators_speed");
    remove_elevators_speed.onchange = switchOpposite;
    var elevators_speed = document.getElementById("elevators_speed");
    elevators_speed.onchange = switchOpposite;
    var remove_fast_foors = document.getElementById("remove_fast_doors");
    remove_fast_doors.onchange = switchOpposite;
    var fast_doors = document.getElementById("fast_doors");
    fast_doors.onchange = switchOpposite;

    var remove_itemsounds = document.getElementById("remove_itemsounds");
    remove_itemsounds.onchange = switchOpposite;
    var itemsounds = document.getElementById("itemsounds");
    itemsounds.onchange = switchOpposite;

    var remove_Infinite_Space_Jump = document.getElementById("remove_Infinite_Space_Jump");
    remove_Infinite_Space_Jump.onchange = switchOpposite;
    var Infinite_Space_Jump = document.getElementById("Infinite_Space_Jump");
    Infinite_Space_Jump.onchange = switchOpposite;
    var remove_rando_speed = document.getElementById("remove_rando_speed");
    remove_rando_speed.onchange = switchOpposite;
    var rando_speed = document.getElementById("rando_speed");
    rando_speed.onchange = switchOpposite;
    var remove_spinjumprestart = document.getElementById("remove_spinjumprestart");
    remove_spinjumprestart.onchange = switchOpposite;
    var spinjumprestart = document.getElementById("spinjumprestart");
    spinjumprestart.onchange = switchOpposite;

    var hell = document.getElementById("hell");
    hell.onchange = function() {
        var hell = document.getElementById("hell");
        var hellrun_rate = document.getElementById("hellrun_rate");
        var etanks = document.getElementById("etanks");
        if(hell.checked) {
            hellrun_rate.value = 25;
            etanks.value = 3;
        } else {
            hellrun_rate.value = 100;
            etanks.value = 0;
        }
        switchCheckbox("hell")
    }

    initSlider();
    $("#preset").chosen({ width: '100%' });

    var gamepadMapping = document.getElementById("gamepadMapping");
    gamepadMapping.onchange = switchGamepadMapping;
    switchGamepadMapping();

{{
if session.customizer["invert"] == "on":
}}
    invertFunc();
{{
    pass
}}

    setColorRando();

    $("#customSprite").imagepicker({show_label: true});
    $("#customShip").imagepicker();

    enableCustomSpriteDropdown();
    enableCustomShipDropdown();
    setRandom();

    permalinkCustomization(permalink);

    displayMessage();
    musicSelectChange();

{{
if seedInfo != None:
    response.write("    greyOutPatches({}, true, false);".format("true" if seedInfo["raceMode"] == "on" else "false"), escape=False)
    pass
}}

    if(permalink == true) {
        // check if a vanilla ROM is already in local storage
        localforage.getItem('vanillaROM', function(err, value) {
            if(err != null) {
                clearLocalStorage();
            } else {
                if(value != null) {
                    displayROMInput(false);
                    vanillaROMBytes = new Uint8Array(value);
                } else {
                    clearLocalStorage();
                }
            }
        });
    }
}

function switchGamepadMapping() {
    switchCheckbox("gamepadMapping");
    var gamepadMapping = document.getElementById("gamepadMapping");
    var text = document.getElementById("gamepadMappingText");
    if(gamepadMapping.checked) {
        $('#preset').prop('disabled', false).trigger("chosen:updated");
        text.className = "";
    } else {
        $('#preset').prop('disabled', true).trigger("chosen:updated");
        text.className = "disabledText";
    }
}

function displayROMInput(show) {
    if(show == true) {
        document.getElementById("vanillaROMVisibility").style.display = "block";
        document.getElementById("vanillaROMOKVisibility").style.display = "none";
    } else {
        document.getElementById("vanillaROMVisibility").style.display = "none";
        document.getElementById("vanillaROMOKVisibility").style.display = "block";
    }
}

function clearLocalStorage() {
    displayROMInput(true);
    localforage.clear();
    vanillaROMBytes = null;
}

function permalinkCustomization(permalink) {
    if(permalink == true) {
        document.getElementById("uploadFileVisibility").style.display = "none";
        document.getElementById("seedInfoVisibility").style.display = "block";
        buttonText = "download & customize"
        document.getElementById("submitBtn").value = buttonText;
    } else {
        document.getElementById("uploadFileVisibility").style.display = "block";
        document.getElementById("seedInfoVisibility").style.display = "none";
        buttonText = "customize"
    }
}

function enableCustomSpriteDropdown() {
    var customSpriteEnable = document.getElementById("customSpriteEnable");
    var customItemsEnable = document.getElementById("customItemsEnable");
    var text = document.getElementById("customSpriteEnableText");
    var itemsText = document.getElementById("customItemsEnableText");
    var noSpinAttack = document.getElementById("noSpinAttack");
    var noSpinAttackText = document.getElementById("noSpinAttackText");
    var spriteRandom = document.getElementById("customSpriteRandom");
    if(customSpriteEnable.checked) {
      customSpriteEnable.value = "on";
      text.className = "";
      itemsText.className = "";
      noSpinAttackText.className = "";

      customItemsEnable.disabled = false;
      if(customItemsEnable.checked == false) {
        customItemsEnable.click();
      }
      noSpinAttack.disabled = false;
      if(isRace && noSpinAttack.value == "off") {
        noSpinAttack.click();
      }
      spriteRandom.disabled = false;
      $("#customSprite").siblings(".image_picker_selector").removeClass("toDisable");
    } else {
      customSpriteEnable.value = "off";
      text.className = "disabledText";
      itemsText.className = "disabledText";
      noSpinAttackText.className = "disabledText";

      if(customItemsEnable.checked == true) {
        customItemsEnable.click();
      }
      customItemsEnable.disabled = true;
      noSpinAttack.disabled = true;
      spriteRandom.disabled = true;
      $("#customSprite").siblings(".image_picker_selector").addClass("toDisable");
    }

    // tell switchery
    var swCustomItems = globalSwitchs["customItemsEnable"];
    var swSpinAttack = globalSwitchs["noSpinAttack"];
    if(customSpriteEnable.checked) {
        swCustomItems.enable();
        swSpinAttack.enable();
    } else {
        swCustomItems.disable();
        swSpinAttack.disable();
    }
}

function enableCustomShipDropdown() {
    var customShipEnable = document.getElementById("customShipEnable");
    var text = document.getElementById("customShipEnableText");
    var shipRandom = document.getElementById("customShipRandom");
    if(customShipEnable.checked) {
      customShipEnable.value = "on";
      text.className = "";
      shipRandom.disabled = false;
      $("#customShip").siblings(".image_picker_selector").removeClass("toDisable");
    } else {
      customShipEnable.value = "off";
      text.className = "disabledText";
      shipRandom.disabled = true;
      $("#customShip").siblings(".image_picker_selector").addClass("toDisable");
    }
}

function setColorRando() {
  var colorRando = document.getElementById("colorsRandomization");
  var elements = ["globalShift", "suitsPalettes", "beamsPalettes", "tilesPalettes", "enemiesPalettes", "bossesPalettes"];
  var slider = $("#degree_slider_range");

  if(colorRando.checked){
    for(var i=0; i<elements.length; i++) {
      var elemId = elements[i];
      var switchBox = document.getElementById(elemId);
      var text = document.getElementById(elemId+"Text");
      var s = globalSwitchs[elemId];
      switchBox.disabled = false;
      text.className = "";
      s.enable();
      document.getElementById("textRight").className = "";
      document.getElementById("textLeft").className = "floatleft";
      document.getElementById("invert").disabled = false;
    }
    slider.slider("enable");
    colorRando.value = "on";
  } else {
    for(var i=0; i<elements.length; i++) {
      var switchBox = document.getElementById(elements[i]);
      var text = document.getElementById(elements[i]+"Text");
      var s = globalSwitchs[elements[i]];
      switchBox.disabled = true;
      text.className = "disabledText";
      s.disable();
      document.getElementById("textRight").className = "disabledText";
      document.getElementById("textLeft").className = "floatleft disabledText";
      document.getElementById("invert").disabled = true;
    }
    slider.slider("disable");
    colorRando.value = "off";
  }
}

var invertSlider = false;

// Helper function
function update_handle_track_pos(slider, ui_handle_pos, index) {
  var width = $("#degree_slider_range").width();
  var handle_track_xoffset = -(((ui_handle_pos*0.2777777778+50)/100) * width);
  $(slider).find(".handle-track"+index).css("left", handle_track_xoffset);

  // reverse grey slider
  if(invertSlider == true) {
      if(index == 0) {
        var left_slider = ui_handle_pos;
        var right_slider = $("#degree_slider_range").slider("values", 1);
      } else {
        var left_slider = $("#degree_slider_range").slider("values", 0);
        var right_slider = ui_handle_pos;
      }

      var slider_range_inverse_left = (100 - (left_slider*-0.2777777778+50)) + "%";
      var slider_range_inverse_width = ((right_slider-left_slider)*0.2777777778) + "%";

      $(slider).find(".slider-range-inverse0").css("width", slider_range_inverse_width);
      $(slider).find(".slider-range-inverse0").css("left", slider_range_inverse_left);

      $(slider).find(".slider-range-inverse1").css("width", "0%");
  } else {
    $(slider).find(".slider-range-inverse0").css("left", "0%");

    if(index == 1) {
      var slider_range_inverse_width = (ui_handle_pos*-0.2777777778+50) + "%";
      $(slider).find(".slider-range-inverse1").css("width", slider_range_inverse_width);
    } else {
      var slider_range_inverse_width = (100 - (ui_handle_pos*-0.2777777778+50)) + "%";
      $(slider).find(".slider-range-inverse0").css("width", slider_range_inverse_width);
    }
  }
}

// Init slider
function initSlider() {
  $("#degree_slider_range").slider({
    range: true,
    min: -180,
    max: 180,
    values: [-180, 180],
    create: function(event, ui) {
      var slider = $(event.target);
      
      // Append the slider handle with a center dot and it's own track
      slider.find(".ui-slider-handle").append(function(n){ return "<span class=\"dot\"><span class=\"handle-track"+n+"\"></span></span>"; });

      // Append the slider with an inverse range      
      slider.prepend('<div class="slider-range-inverse0"></div>')
      slider.prepend('<div class="slider-range-inverse1"></div>')

      // Set initial dimensions
      slider.find(".handle-track0").css("width", event.target.clientWidth);
      slider.find(".handle-track1").css("width", event.target.clientWidth);
      
      // set current values
      $("#degree_slider_range").slider("values", 0, {{=session.customizer["minDegree"]}});
      $("#degree_slider_range").slider("values", 1, {{=session.customizer["maxDegree"]}});

      // Set initial position for tracks
      update_handle_track_pos(event.target, $(this).slider("values", 0), 0);
      update_handle_track_pos(event.target, $(this).slider("values", 1), 1);

    },
    slide: function(event, ui) {
      // Update position of tracks
      update_handle_track_pos(event.target, ui.value, ui.handleIndex);
    }
  });
}

function invertFunc() {
  invertSlider = ! invertSlider;
  var slider = $("#degree_slider_range");
  update_handle_track_pos(slider, slider.slider("values", 0), 0);
  update_handle_track_pos(slider, slider.slider("values", 1), 1);
}

function switchCheckbox(id, elems=[]) {
  var check = document.getElementById(id);
  if(check.checked){
    check.value = "on";
  } else {
    check.value = "off";
  }

  for(var i=0; i<elems.length; i++){
    elemId = elems[i];
    var e = document.getElementById(elemId);
    e.disabled = check.checked;
    // grey out the disabled text
    var text = document.getElementById(elems[i]+"Text");
    if(e.disabled) {
        text.className = "disabledText";
    } else {
        text.className = "";
    }
    // tell switchery
    if(elemId in globalSwitchs){
      var s = globalSwitchs[elemId];
      if(check.checked){
        s.disable();
      } else {
        s.enable();
      }
    }
  }
}

function switchOpposite() {
    var opposites = {
        "itemsounds": ["remove_itemsounds"],
        "remove_itemsounds": ["itemsounds"],
        "elevators_speed": ["remove_elevators_speed"],
        "remove_elevators_speed": ["elevators_speed"],
        "fast_doors": ["remove_fast_doors"],
        "remove_fast_doors": ["fast_doors"],
        "Infinite_Space_Jump": ["remove_Infinite_Space_Jump"],
        "remove_Infinite_Space_Jump": ["Infinite_Space_Jump"],
        "rando_speed": ["remove_rando_speed"],
        "remove_rando_speed": ["rando_speed"],
        "spinjumprestart": ["remove_spinjumprestart"],
        "remove_spinjumprestart": ["spinjumprestart"]
    };
    var oppositeIds = opposites[this.id];
    for(var i=0; i<oppositeIds.length; i++) {
        var oppositeId = oppositeIds[i];
        var opposite = document.getElementById(oppositeId);

        if(this.checked && opposite.checked) {
            opposite.click();
        }

        if(this.checked){
            this.value = "on";
        } else {
            this.value = "off";
        }
    }
}

function displayMessage() {
{{
    if len(msg) > 0:
        response.write("document.getElementById('flash').innerHTML = \"{}\";".format(msg), escape=False)
        response.write("$('#flash').show();", escape=False)
        pass
}}
}

function getBSO() {
    var bso = `  %            SUPER METROID            %  
  % ! with widescreen patch by ocesse ! %  
w :    1    % Widescreen : all %
W : 1609    % Aspect ratio : 16:9 %
s :    1    % Widescreen sprites/objects : unsafe %
b :    2    % Background layer 1 : autoHor&Ver %
B :    1    % Background layer 2 : on %
c : 2032    % Background layer 3 : widescreen below line 32 %
C :    2    % Background layer 4 : autoHor&Ver %
i :    0    % Ignore window : None %
m :    0    % Widescreen markers : off %
O :  200    % Overclock CPU : 200 percent %
S :    2    % Stretch windowing effects : on %
o :    0    % Show Overscan Area : off (affects RetroArch only) %
p :    0    % Pixel Aspect Ratio Correction : off (affects RetroArch only) %
l :    1    % PPU No sprite limit : on %
f :    1    % HD Mode 7 Scale : 1x (this is only an optimization) %
`
    return bso;
}

function startTheTour(step=-1) {
  // the tour tutorial
  var tour = new Tour({
    storage: false,
    steps: [
    {
      element: "#uploadFileStep",
      title: "VARIA Seed",
      content: "Select a seed generated on the VARIA website."
    },
    {
      element: "#vanillaUploadFileStep",
      title: "Vanilla ROM",
      content: "Select a vanilla ROM.",
      placement: "auto left"
    },
    {
      element: "#colorsRandomizationStep",
      title: "Color randomization",
      content: "<p>Randomize the colors of various graphical elements:<br/><img src=\"/solver/static/images/customizer/palettesRando.png\" alt=\"colors rando\" title=\"colors rando\" class=\"center_image half\"/></p><p>Use the slider to restrict the possible range of the colors shifting. The colors on the slider are the result colors for Samus, the yellow in the middle being Samus vanilla color:</p><img src=\"/solver/static/images/customizer/samus_degrees.png\" alt=\"samus degrees\" title=\"samus degrees\" class=\"center_image threequarter\"/><p>You can invert the range by clicking on the invert button.</p><p>By default, the same shift is applied to all elements for color consistency. If you disable the setting, a different shift will be used for each category.</p>"
    },
    {
      element: "#customSpriteStep",
      title: "Custom Sprites",
      content: "<p>The sprites have been created using <a href=\"https://github.com/Artheau/SpriteSomething\" target=\"_blank\">Sprite Something</a> by Artheau and Minnie Trethewey.</p>\
<table>\
  <th>Sprite</th><th>Author</th><th>Description</th>\
{{
for (key, value) in sorted(customSprites.items(), key=lambda x: x[1]['index']):
  response.write('  <tr><td><a href=\\\"/solver/static/images/sprite_sheets/{}.png\\\" target=\\\"_blank\\\">{}</a></td><td>{}</td><td>{}</td>\\\n'.format(key, value['name'], value['author'], value['desc']), escape=False)
  pass
response.write('</table>', escape=False)
}}\
<p><b>Hint:</b>Click on a sprite name in the above table to display its sprite sheet.</p>"
    },
    {
      element: "#customItemsStep",
      title: "Custom Items names",
      content: "<p>Replace the name of some items displayed in the message box when the item is picked up, for example 'Morphing Doll' for the Margatroid sprite instead of 'Morphing Ball'.</p>"
    },
    {
      element: "#noSpinAttackStep",
      title: "Vanilla Screw Attack animation",
      content: "<p>Keep the vanilla behaviour for Screw Attack animation where it's the same with or without Space Jump<br/><b>Note:</b> In the rando league you have to use the vanilla behaviour.<br/><b>Note:</b> Activated when a race protected seed is detected.</p>"
    },
    {
      element: "#customShipStep",
      title: "Custom Ships",
      content: "<table>\
  <th>Ship</th><th>Author</th><th>Description</th>\
{{
for (key, value) in sorted(customShips.items(), key=lambda x: x[1]['index']):
  response.write('  <tr><td>{}</td><td>{}</td><td>{}</td>\\\n'.format(value['name'], value['author'], value['desc']), escape=False)
  pass
response.write('</table>', escape=False)
}}\
<p><b>Note:</b> Even if colors randomization is on, custom ships are never colors randomized.</p>"
    },
    {
      element: "#customMusicStep",
      title: "Music",
      content: "Possible action: <ul>\
<li>Don't touch: do nothing</li>\
<li>Disable: remove music</li>\
<li>Randomize: randomize game music</li>\
<li>Customize: replace song with custom ones</li>\
<li>Restore: restore vanilla music</li>\
</ul>\
spc javascript engine by <a href=\"https://github.com/cosinusoidally/snes_spc_js\" target=\"_blank\">cosinusoidally</a>"
    },
    {
      element: "#patchesStep",
      title: "Patches",
      content: "Choose the patches that you want to include in your customized seed."
    },
    {
      element: "#gamepadMappingStep",
      title: "Gamepad Mapping",
      content: "Use the custom gamepad mapping defined in a community preset."
    },
    {
      element: "#itemsoundsStep",
      title: "Fanfare",
      content: "<p>Replaces the quite long fanfare played when picking up an item by a short sound effect related with the item picked, and does not restart game music on item pickup.</p>\
<p>Patch developed by Scyzer.</p>"
    },
    {
      element: "#ElevatorDoorsStep",
      title: "Transitions",
      content: "<p>Accelerate doors and/or elevators transitions</p>\
<p>Doors patch developed by Rakki and elevators patch by Lioran.</p>"
    },
    {
      element: "#spinjumprestartStep",
      title: "Spin jump restart",
      content: "<p>Allows Samus to start spinning in mid air after jumping or falling</p>\
<p>Patch developed by Kejardon.</p>"
    },
    {
      element: "#rando_speedStep",
      title: "Momentum conservation",
      content: "<p>Let Samus keeps her momentum when landing from a fall or from jumping</p>\
<p>This patch was developed by Oi27.</p>"
    },
    {
      element: "#Infinite_Space_JumpStep",
      title: "Infinite Space Jump",
      content: "<p>Space jumps can be done quicker and at any time in air, water or lava, even after falling long distances.</p>\
<p>This patch was developed by MetConst.</p>"
    },
    {
      element: "#refill_before_saveStep",
      title: "Refill before save",
      content: "<p>Refill energy and ammo when saving.</p>\
<p>This patch was developed by Adam.</p>"
    },
    {
      element: "#better_reservesStep",
      title: "Better Reserves",
      content: "<p>This patch does a few things:<ul>\
<li>Reserve tanks come filled up</li>\
<li>Different color for HUD reserve indicator when full</li>\
<li>Prevents heat damage and the loss of invincibility frames when auto reserves activate (no more getting hit twice!)</li>\
<li>Makes reserve tanks not empty if Samus is fully healed when they are used in auto or manual mode.</li>\
<li>Fix jank where deselecting and reselecting refill button during manual refill causes it to resume.</li>\
<li>Can also press A during manual refill at any time to stop refilling.</li>\
</ul></p>\
<p>Patch developed by NoDever2</p>"
    },
    {
      element: "#color_blindStep",
      title: "Color blind friendly colors for doors / Disable screen shake",
      content: "<p>Color blind friendly colors for Missile, Super and Power Bomb doors.</p>\
<p>This patch was developed by Colors and theonlydude.</p>\
<p>Disable screen shake during escape and lava/acid rising earthquake.</p>\
<p>This patch was developed by flo.</p>"
    },
    {
      element: "#noflashingStep",
      title: "Disable flashing",
      content: "<p>Disable bosses, escape and power bomb flashing, Landing Site lightning, ...</p>\
<p>This patch was developed by Kara.</p>"
    },
    {
      element: "#hellStep",
      title: "Challenges",
      content: "<p>Permanent lava physics: Samus physics behave as she's in lava/acid until Gravity Suit is found</p>\
<p>Permanent hell run: Samus life is drained constently in non heated rooms until heat protected suit is found. In heated rooms life is drained twice as fast.</p>\
<b>Warning:</b>Not taken into account by the logic, may render the seed unfinishable.\
<p>Patches developed by flo.</p>"
    },
    {
      element: "#hellOptionsStep",
      title: "Challenges options",
      content: "<p>Customize the amount of energy removed during hellruns, from 0% (no damage) to 400% (4 times vanila damage). Useful with permanent hellrun to reduce the amount of energy removed, but can be used independently for easier/harder hellruns.</p>\
<p>Set the number of Etanks available from start. Between 0 and 14. Useful with permanent hellrun but can be used independently for easier seeds.</p>"
    },
    {
      element: "#hard_modeStep",
      title: "Hard mode",
      content: "<p>Adds optional hard mode (enabled by default), with the following modifications:\
<ul>\
<li>Halves damage made by Samus</li>\
<li>Doubles damage made by enemies, spikes, acid/lava</li>\
<li>Halves missile/health drop values</li>\
</ul></p><p>Patch developed by Sirkura, Devaliah, Quote, Phosphodile</p>"
    },
    {
      element: "#widescreenStep",
      title: "Widescreen support",
      content: "<p>Add support for widescreen on <a href=\"https://github.com/DerKoun/bsnes-hd/releases\" target=\"_blank\">bsnes-hd emulator</a>. A bso file containing emulator configuration is downloaded after the ROM file, you have to leave it in the same folder as the ROM file for bsnes-hd to work properly.</p>\
<p><b>Note: widescreen patch is not compatible with race mode</b></p>\
<p><b>Note: widescreen patch contains its own version of the fast doors/elevators patch</b></p>\
<p>Patch developed by ocesse.</p>"
    },
    {
      element: "#AimAnyButtonStep",
      title: "Aim any button",
      content: "<p>Allows the aim buttons to be assigned to any button (already applied by default on VARIA seeds).</p>\
<p>Patch developed by Kejardon.</p>"
    },
    {
      element: "#max_ammo_displayStep",
      title: "Max ammo display",
      content: "<p>Max Ammo Display (already applied by default on VARIA seeds).</p>\
<p>Patch developed by Personitis.</p>"
    },
    {
      element: "#supermetroid_msu1Step",
      title: "MSU1",
      content: "<p>Play music with MSU1 chip on SD2SNES (already applied by default on VARIA seeds).</p>\
<p>Patch developed by DarkShock.</p>"
    },
    {
      element: "#baseStep",
      title: "VARIA RTA timer, stats and credits",
      content: "<p>Apply VARIA base patches to a vanilla ROM (already applied by default on VARIA seeds)</p>\
<p>Replace in-game time with real time, and display gameplay stats in the credits</p>"
    },
    {
      element: "#remove_itemsoundsStep",
      title: "Restore Vanilla 1/3",
      content: "<p>Restore vanilla fanfare played when picking up an item.</p><p>Restore vanilla Space Jump behaviour.</p>"
    },
    {
      element: "#remove_ElevatorDoorsStep",
      title: "Restore Vanilla 2/3",
      content: "<p>Restore vanilla doors and/or elevators transitions</p>"
    },
    {
      element: "#remove_rando_speedStep",
      title: "Restore Vanilla 3/3",
      content: "<p>Restore vanilla momentum loss on landing.</p><p>Restore vanilla spin jump.</p>"
    }
  ]});

  // Initialize the tour
  tour.init();

  if (typeof step === "object") {
    // step is an event, not a number. Get ID from parent element
    let parent = event.target.parentNode
    step = parent.id
    while (!step) {
        parent = parent.previousElementSibling
        step = parent.id
    }
  }
  if (typeof step === 'string') {
    step = tour._options.steps.findIndex((tour_step) => tour_step.element === `#${step}`)
  }
  // Start the tour
  if(step != -1) {
    tour.goTo(step);
  }
  tour.start();
}

function nope(evt) {
  evt.currentTarget.className += " active";
}
</script>
{{
def displayCheckbox(id, defaultTrue=False):
  if (id in session.customizer and session.customizer[id] == 'on') or (id not in session.customizer and defaultTrue == True):
}}
    {{=INPUT(_id=id, _name=id, _type="checkbox", _checked="checked", _value="on", _class="js-switch", _onchange="switchCheckbox('{}')".format(id))}}
{{
  else:
}}
    {{=INPUT(_id=id, _name=id, _type="checkbox", _value="off", _class="js-switch", _onchange="switchCheckbox('{}')".format(id))}}
    {{pass}}
  {{pass}}

{{
def displayNumber(id, min, max, default, step="1"):
  value = session.customizer.get(id, default)
  response.write("<input name=\"{}\" id=\"{}\" type=\"number\" value=\"{}\" min=\"{}\" max=\"{}\" step=\"{}\" class=\"full\" required>".format(id, id, value, min, max, step), escape=False)
  pass
}}
<body>
  <div class="fixed">
    <div class="menu">
    <table class="full menuTable">
      <tr>
        <td>{{=A("Home", _href=URL(f="home"), _class="menu")}}</td>
        <td>{{=A("Presets", _href=URL(f="presets"), _class="menu")}}</td>
        <td>{{=A("Randomizer", _href=URL(f="randomizer"), _class="menu")}}</td>
        <td>{{=A("Solver", _href=URL(f="solver"), _class="menu")}}</td>
        <td>{{=A("Trackers", _href=URL(f="tracker"), _class="menu")}}</td>
        <td>{{=A("Plandomizer", _href=URL(f="plando"), _class="menu")}}</td>
        <td>{{=A("Plandository", _href=URL(f="plandorepo"), _class="menu")}}</td>
        <td class="menu_selected">{{=A("Customizer", _href=URL(f="customizer"), _class="menu")}}</td>
        <td>{{=A("Statistics", _href=URL(f="extStats"), _class="menu")}}</td>
        <td>{{=A("Information & Contact", _href=URL(f="infos"), _class="menu")}}</td>
      </tr>
    </table>
    </div>
  </div>

  <div class="main">
    <div class="center">
      <div class="tab">
        <button class="tablinks" onclick="nope(event);">Seed Customizer</button>
      </div>
    </div>
    <form id="mainform" name="mainform" onsubmit="doSubmit(); return false;">
      <div class="tabcontent">
        <div class="row">
          <div class="column">
            <div id="uploadFileVisibility">
              <p>Add palette randomization, use custom Samus sprite, apply patches to an already randomized VARIA seed, or a vanilla Super Metroid ROM.</p>
              <table class="full">
                <colgroup><col class="half" /><col class="half" /></colgroup>
                <tr>
                  <td>ROM:</td>
                  <td>{{=INPUT(_type="file", _name="uploadFile", _id="uploadFile", _class="full")}}</td>
                  <td id="uploadFileStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
              </table>
            </div>
            <h4>Colors Randomization</h4>
            <p>
              Randomize the colors of Samus, beams, levels, enemies and bosses.
            </p>
            <table class="full">
              <tr>
                <td class="third">{{displayCheckbox("colorsRandomization")}}Colors Randomization</td>
                <td class="full"><span id="textLeft" class="floatleft">-180</span><div id="degree_slider_range" class="sixty floatleft"></div><span id="textRight">180</span></td>
                <td><button id="invert" type="button" onclick="invertFunc()">Invert</button></td>
                <td id="colorsRandomizationStep"><button type="button" onclick="startTheTour(event)">?</button></td>
              </tr>
              <tr>
                <td colspan="4">{{displayCheckbox("globalShift")}}<span id="globalShiftText">Use the same degree to randomize all the elements</span></td>
              </tr>
            </table>
            <p>
              Select the elements to colors randomize.
            </p>
              <table class="full">
                <tr>
                  <td class="third">{{displayCheckbox("suitsPalettes")}}<span id="suitsPalettesText">Samus</span></td>
                  <td class="third">{{displayCheckbox("beamsPalettes")}}<span id="beamsPalettesText">Beams</span></td>
                  <td class="third">{{displayCheckbox("tilesPalettes")}}<span id="tilesPalettesText">Levels</span></td>
                </tr>
                <tr>
                  <td class="third">{{displayCheckbox("enemiesPalettes")}}<span id="enemiesPalettesText">Enemies</span></td>
                  <td class="third">{{displayCheckbox("bossesPalettes")}}<span id="bossesPalettesText">Bosses</span></td>
                  <td class="third"></td>
                </tr>
              </table>
            <h4>Custom Sprites</h4>
            <p>
              <table class="full">
                <colgroup><col class="check" /><col class="full" /></colgroup>
                <tr>
                  <td>{{displayCheckbox("customSpriteEnable")}}</td>
                  <td><span id="customSpriteEnableText">Replace Samus sprite with a custom one.</span></td>
                  <td id="customSpriteStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr>
                  <td>{{displayCheckbox("customItemsEnable")}}</td>
                  <td><span id="customItemsEnableText">Replace some items names to match the custom sprite universe.</span></td>
                  <td id="customItemsStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr>
                  <td>{{displayCheckbox("noSpinAttack")}}</td>
                  <td><span id="noSpinAttackText">Use the same animation for Screw Attack with or without Space Jump.</span></td>
                  <td id="noSpinAttackStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr>
                  <td class="small"><div class="random"><button id="customSpriteRandom" type="button" onclick="randomizeTarget(event, 'customSprite')" class="small center"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                  <td>
                    <div class="border">
                      <select class="filldropdown" id="customSprite" name="customSprite">
                        <optgroup label="Samus">
{{
  group = "Samus"
  for (key, value) in sorted(customSprites.items(), key=lambda x: x[1]['index']):
    if value["group"] != group:
      group = value["group"]
      response.write("</optgroup>\n", escape=False)
      response.write("<optgroup label=\"{}\">\n".format(group), escape=False)
      pass
    response.write("  <option data-img-src=\"/solver/static/images/sprites/{}.png\" data-img-label=\"{}\" value=\"{}\" {}>{}</option>\n".format(key, customSprites[key]["name"], key, 'selected="selected"' if key == session.customizer['customSprite'] else "", key), escape=False)
    pass
}}
                        </optgroup>
                      </select>
                    </div>
                  <td>
                </tr>
                <tr>
                  <td>{{displayCheckbox("customShipEnable")}}</td>
                  <td><span id="customShipEnableText">Replace Samus Ship sprite with a custom one.</span></td>
                  <td id="customShipStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr>
                  <td class="small"><div class="random"><button id="customShipRandom" type="button" onclick="randomizeTarget(event, 'customShip')" class="small center"><span class="small dice_rotate">&#x2684;</span></button></div></td>
                  <td>
                    <div class="border">
                      <select class="filldropdown" id="customShip" name="customShip">
{{
  for (key, value) in sorted(customShips.items(), key=lambda x: x[1]['index']):
    response.write("  <option data-img-src=\"/solver/static/images/ships/{}.png\" data-img-label=\"{}\" value=\"{}\" {}>{}</option>\n".format(key, customShips[key]["name"], key, 'selected="selected"' if key == session.customizer['customShip'] else "", key), escape=False)
    pass
}}
                        </optgroup>
                      </select>
                    </div>
                  <td>
                </tr>
              </table>
            </p>
            <h4>Custom Music</h4>
              <table class="full">
                <colgroup><col class="half" /><col class="half" /></colgroup>
                <tr>
                  <td><span id="customMusicEnableText">Music</span></td>
                  <td>{{=SELECT(*["Don't touch", "Disable", "Randomize", "Customize", "Restore"], **dict(_id="music", _class="full", _onchange="musicSelectChange()", value=session.customizer["music"]))}}</td>
                  <td id="customMusicStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
              </table>
            <div id="musicCustomizer" class="margin_top">
              <p>
                Use the Music Player to listen to custom songs then drag & drop songs to replace the vanilla ones.
              </p>
              <table class="full margin_top">
                <colgroup><col class="quater"/><col class="quater"/><col class="quater"/><col class="quater"/></colgroup>
                <tr>
                  <td><img class="music_button" id="reset" src="/solver/static/images/ui/refresh.svg" title="Reset" alt="Reset" onclick="resetPlaylist()"> Reset playlist</td>
                  <td><img class="music_button" id="randomize" src="/solver/static/images/ui/games.svg" title="Randomize" alt="Randomize" onclick="randomizePlaylist()"> Randomize playlist</td>
                  <td><img class="music_button" id="reset" src="/solver/static/images/ui/save.svg" title="Save" alt="Save" onclick="savePlaylist()"> Save playlist</td>
                  <td><img class="music_button" id="reset" src="/solver/static/images/ui/cloud_upload.png" title="Load" alt="Load" onclick="loadPlaylist()"> Load playlist</td>
                </tr>
              </table>
              <table class="full margin_top">
                <colgroup><col class="half" /><col class="half" /></colgroup>
                <tr><th>Track to replace</th><th class="align_center">Music Player</th></tr>
                <tr><th class="align_right">Replace with</th><th></th></tr>
                <tr><td></td><td rowspan={{=1+len(musics["_list"])*2}}>
                    <div id="spc_player" class="spc_player lighter">
                      <table>
                        <tr>
                          <td>
                            <div id="controlPlayer">
                              <img id="play" src="/solver/static/images/ui/play.svg" title="Play Song" alt="Play Song" onclick="action_play()">
                              <img id="download" src="/solver/static/images/ui/cloud_download.svg" alt="Downloading Song" style="display: none">
                              <img id="stop" src="/solver/static/images/ui/shut_down.svg" title="Stop Song" alt="Stop Song" style="display: none" onclick="stopSong()">
                            </div>
                          </td>
                          <td>
                            <table class="full">
                              <tr><td>Song: </td><td><span id="player_song"></span></td></tr>
                              <tr><td>Description: </td><td><span id="player_desc"></span></td></tr>
                              <tr><td>Port author: </td><td><span id="player_port_author"></span></td></tr>
                              <tr><td>Original author: </td><td><span id="player_original_author"></span></td></tr>
                            </table>
                          </td>
                        </tr>
                      </table>
                      <div class="player_table">
                        <table class="full">
{{
for name, values in musics["_dropdown"].items():
  response.write('<tr><td class="align_center darker">{}</td></tr>\n'.format(name), escape=False)
  for value in values:
    response.write('<tr><td class="song_in_list" onclick="loadNewSong(\'{}\')" draggable="true" ondragstart="drag(event)">{}</td></tr>\n'.format(value.replace("'", r"\'"), value), escape=False)
    pass
  pass
}}
                        </table>
                      </div>
                    </div>
                </td></tr>
{{
  for (song, songId) in musics["_list"]:
    response.write('<tr><td title="Click to listen" onclick="loadNewSong(\'{}\')">{}</td></tr>\n'.format(song.replace("'", r"\'"), song), escape=False)
    response.write('<tr><td id="{}" ondrop="drop(event)" ondragover="allowDrop(event)" onclick="loadNewSongFromId(\'{}\')" class="align_right drop_target lighter" title="Drag & drop songs from player to customize">{}</td></tr>\n'.format(songId, songId, session.customizer.get(songId, song)), escape=False)
    pass
}}
              </table>
            </div>
            <h4>Patches<span class="right" id="patchesStep"><button type="button" onclick="startTheTour(event)">?</button></span></h4>
            <p>
              Patches to customize your ROM.
            </p>

              <table class="full">
                <colgroup><col class="quarter" /><col class="threequarter" /><col class="check" /></colgroup>
                <tr><td colspan="2"><h5 class="center"><b>Gamepad Mapping</b></h5></td><td></td></tr>
              </table>
              <table class="full">
                <colgroup><col class="half" /><col class="half" /></colgroup>
                <tr>
                  <td>
                    {{displayCheckbox("gamepadMapping")}}
                    <span id="gamepadMappingText">Use gamepad mapping from preset: </span>
                  </td>
                  <td>
                    {{=SELECT(OPTGROUP(*comPresets, **dict(_label="Community presets")), **dict(_name="preset", _id="preset", value=session.customizer["preset"], _class="chzn-select"))}}
                  </td>
                  <td id="gamepadMappingStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
              </table>

              <table class="full">
                <colgroup><col class="quarter" /><col class="threequarter" /><col class="check" /></colgroup>
                <tr><td colspan="2"><h5 class="center"><b>Game comfort</b></h5></td><td></td></tr>
              </table>
              <table class="full">
                <colgroup><col class="half" /><col class="half" /></colgroup>
                <tr>
                  <td colspan="2">
                    {{displayCheckbox("itemsounds")}}
                    <span id="itemsoundsText">Remove fanfare when picking up an item</span>
                  </td>
                  <td id="itemsoundsStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr>
                  <td>
                    {{displayCheckbox("elevators_speed")}}
                    <span id="elevators_speedText">Accelerate elevators transitions</span>
                  </td>
                  <td>
                    {{displayCheckbox("fast_doors")}}
                    <span id="fast_doorsText">Accelerate doors transitions</span>
                  </td>
                  <td id="ElevatorDoorsStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr>
                  <td colspan="2">
                    {{displayCheckbox("spinjumprestart")}}
                    <span id="spinjumprestartText">Spin jump restart (a.k.a. Respin)</span>
                  </td>
                  <td id="spinjumprestartStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr>
                  <td colspan="2">
                    {{displayCheckbox("rando_speed")}}
                     <span id="rando_speedText">Momentum conservation (a.k.a. Speedkeep)</span>
                  </td>
                  <td id="rando_speedStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr>
                  <td colspan="2">
                    {{displayCheckbox("Infinite_Space_Jump")}}
                     <span id="Infinite_Space_JumpText">Infinite Space Jump</span>
                  </td>
                  <td id="Infinite_Space_JumpStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr>
                  <td colspan="2">
                    {{displayCheckbox("refill_before_save")}}
                     <span id="refill_before_saveText">Refill energy and ammo when saving</span>
                  </td>
                  <td id="refill_before_saveStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr>
                  <td colspan="2">
                    {{displayCheckbox("better_reserves")}}
                     <span id="better_reservesText">Better Reserves <img src="/solver/static/images/tracker/inventory/Reserve.png" class="width: 32px"/></span>
                  </td>
                  <td id="better_reservesStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
              </table>

              <table class="full">
                <colgroup><col class="quarter" /><col class="threequarter" /><col class="check" /></colgroup>
                <tr><td colspan="2"><h5 class="center"><b>Accessibility</b></h5></td><td></td></tr>
              </table>
              <table class="full">
                <colgroup><col class="half" /><col class="half" /></colgroup>
                <tr>
                  <td>
                    {{displayCheckbox("color_blind")}}
                    <span id="color_blindText">Color blind friendly colors for doors</span>
                  </td>
                  <td>
                    {{displayCheckbox("disable_screen_shake")}}
                    <span id="disable_screen_shakeText">Disable screen shake during escape</span>
                  </td>
                  <td id="color_blindStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr>
                  <td colspan="2">
                    {{displayCheckbox("noflashing")}}
                    <span id="noflashingText">Remove flashing</span>
                  </td>
                  <td id="noflashingStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
              </table>

              <table class="full">
                <colgroup><col class="quarter" /><col class="threequarter" /><col class="check" /></colgroup>
                <tr><td colspan="2"><h5 class="center"><b>Challenges</b></h5></td><td></td></tr>
              </table>
              <table class="full">
                <colgroup><col class="quarter" /><col class="quarter" /><col class="quarter" /><col class="quarter" /></colgroup>
                <tr>
                  <td colspan="2">
                    {{displayCheckbox("lava_acid_physics")}}
                    <span id="lava_acid_physicsText">Permanent lava physics</span>
                  </td>
                  <td colspan="2">
                    {{displayCheckbox("hell")}}
                    <span id="hellText">Permanent hell run</span>
                  </td>
                  <td id="hellStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr>
                  <td>
                    <span id="hellrun_rateText">Hell run rate percentage</span>
                  </td>
                  <td>
                    {{displayNumber("hellrun_rate", "0", "400", "100", "1")}}
                  </td>
                  <td>
                    <span id="etanksText">Additional ETanks</span>
                  </td>
                  <td>
                    {{displayNumber("etanks", "0", "14", "0", "1")}}
                  </td>
                  <td id="hellOptionsStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr>
                  <td colspan="2">
                    {{displayCheckbox("hard_mode")}}
                    <span id="hard_modeText">Hard mode</span>
                  </td>
                  <td colspan="2"></td>
                  <td id="hard_modeStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
              </table>

              <table class="full">
                <colgroup><col class="quarter" /><col class="threequarter" /><col class="check" /></colgroup>
                <tr><td colspan="2"><h5 class="center"><b>Miscellaneous</b></h5></td><td></td></tr>
              </table>
              <table class="full">
                <colgroup><col class="half" /><col class="half" /></colgroup>
                <tr>
                  <td colspan="2">
                    {{displayCheckbox("widescreen")}}
                    <span id="widescreenText">Widescreen on  <a href="https://github.com/DerKoun/bsnes-hd/releases" target="_blank">bsnes-hd emulator</a></span>
                  </td>
                  <td id="widescreenStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr>
                  <td colspan="2">
                    {{displayCheckbox("AimAnyButton")}}
                    <span id="AimAnyButtonText">Allows the aim buttons to be assigned to any button</span>
                  </td>
                  <td id="AimAnyButtonStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr>
                  <td colspan="2">
                    {{displayCheckbox("max_ammo_display")}}
                    <span id="max_ammo_displayText">Max Ammo Display</span>
                  </td>
                  <td id="max_ammo_displayStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr>
                  <td colspan="2">
                    {{displayCheckbox("supermetroid_msu1")}}
                    <span id="supermetroid_msu1Text">Play music with MSU1 chip on SD2SNES</span>
                  </td>
                  <td id="supermetroid_msu1Step"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr>
                  <td colspan="2">
                    {{displayCheckbox("base")}}
                    <span id="baseText">VARIA RTA timer, stats and credits</span>
                  </td>
                  <td id="baseStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
              </table>

              <table class="full">
                <colgroup><col class="quarter" /><col class="threequarter" /><col class="check" /></colgroup>
                <tr><td colspan="2"><h5 class="center"><b>Restore vanilla behaviour</b></h5></td><td></td></tr>
              </table>
              <table class="full">
                <colgroup><col class="half" /><col class="half" /></colgroup>
                <tr>
                  <td>
                    {{displayCheckbox("remove_itemsounds")}}
                    <span id="remove_itemsoundsText">Restore vanilla fanfare when picking up an item</span>
                  </td>
                  <td>
                    {{displayCheckbox("remove_Infinite_Space_Jump")}}
                    <span id="remove_Infinite_Space_JumpText">Restore vanilla Space Jump</span>
                  </td>
                  <td id="remove_itemsoundsStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr>
                  <td>
                    {{displayCheckbox("remove_elevators_speed")}}
                    <span id="remove_elevators_speedText">Restore vanilla elevators transitions</span>
                  </td>
                  <td>
                    {{displayCheckbox("remove_fast_doors")}}
                    <span id="remove_fast_doorsText">Restore vanilla doors transitions</span>
                  </td>
                  <td id="remove_ElevatorDoorsStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
                <tr>
                  <td>
                    {{displayCheckbox("remove_rando_speed")}}
                    <span id="remove_rando_speedText">Restore vanilla momentum loss on landing</span>
                  </td>
                  <td>
                    {{displayCheckbox("remove_spinjumprestart")}}
                    <span id="remove_spinjumprestartText">Restore vanilla spin jump</span>
                  </td>
                  <td id="remove_rando_speedStep"><button type="button" onclick="startTheTour(event)">?</button></td>
                </tr>
              </table>
          </div>
          <div class="column" id="seedInfoVisibility">
{{
if seedInfo != None:
  def setBold(param):
    if param == "objective":
      if seedParams[param] != ','.join(defaultParams[param]):
        response.write("class='bold'", escape=False)
        pass
    else:
      if seedParams[param] != defaultParams[param]:
        response.write("class='bold'", escape=False)
        pass
      pass
    pass
}}
            <h4>Download seed {{=seedInfo["filename"]}}</h4>
            <table class="full">
              <tr><td><a href="javascript:DoPost()">Generate another seed with the same parameters</a></td></tr>
            </table>
            <table class="full">
              <colgroup><col class="half" /><col class="half" /></colgroup>
              <tr>
                <td>Vanilla ROM:</td>
                <td>
                  <div id="vanillaROMVisibility">
                   {{=INPUT(_type="file", _name="vanillaUploadFile", _id="vanillaUploadFile", _class="full")}}
                  </div>
                  <div id="vanillaROMOKVisibility">
                    Vanilla ROM already loaded
                  </div>
                </td>
                <td id="vanillaUploadFileStep"><button type="button" onclick="startTheTour(event)">?</button></td>
              </tr>
            </table>
            <h4>Game Details</h4>
            <table class="full">
              <colgroup><col class="half" /><col class="half" /></colgroup>
              <tr><td>Logic</td><td>{{=seedParams.get("logic", "vanilla")}}</td></tr>
{{    if seedParams["logic"] == "random":}}
              <tr><td>Logic pool</td><td>{{=seedParams["logicMultiSelect"]}}</td></tr>
{{        pass}}
              <tr><td>Skills preset</td><td>{{=seedInfo["preset"]}}</td></tr>
              <tr><td>Seed</td><td>{{=seedInfo["seed"]}}</td></tr>
              <tr><td>Created</td><td>{{=seedInfo["time"]}}</td></tr>
              <tr><td>Race mode</td><td>{{=seedInfo["raceMode"]}}</td></tr>
            </table>
            <h4>Randomizer Parameters</h4>
            <table class="full">
              <colgroup><col class="half" /><col class="half" /></colgroup>
              <tr {{=setBold("startLocation")}}><td>Start location</td><td>{{=seedParams["startLocation"]}}</td></tr>
{{    if seedParams["startLocation"] == "random":}}
              <tr><td>Start location pool</td><td>{{=seedParams["startLocationMultiSelect"]}}</td></tr>
{{        pass}}
              <tr {{=setBold("majorsSplit")}}><td>Majors Split</td><td>{{=seedParams["majorsSplit"]}}</td></tr>
{{    if seedParams["majorsSplit"] == "random":}}
              <tr><td>Majors Split pool</td><td>{{=seedParams["majorsSplitMultiSelect"]}}</td></tr>
{{        pass}}
{{    if seedParams["majorsSplit"] == "Scavenger":}}
              <tr {{=setBold("scavNumLocs")}}><td>Major locations in the mandatory route</td><td>{{=seedParams["scavNumLocs"]}}</td></tr>
              <tr {{=setBold("scavRandomized")}}><td>Non-vanilla items in mandatory major locs</td><td>{{=seedParams["scavRandomized"]}}</td></tr>
{{        pass}}
              <tr {{=setBold("maxDifficulty")}}><td>Maximum difficulty for picking an item </td><td>{{=seedParams["maxDifficulty"]}}</td></tr>
              <tr {{=setBold("progressionSpeed")}}><td>Progression speed</td><td>{{=seedParams["progressionSpeed"]}}</td></tr>
{{    if seedParams["progressionSpeed"] == "random":}}
              <tr><td>Progression speed pool</td><td>{{=seedParams["progressionSpeedMultiSelect"]}}</td></tr>
{{        pass}}
              <tr {{=setBold("progressionDifficulty")}}><td>Progression difficulty</td><td>{{=seedParams["progressionDifficulty"]}}</td></tr>
{{    if seedParams["progressionDifficulty"] == "random":}}
              <tr><td>Progression difficulty pool</td><td>{{=seedParams["progressionDifficultyMultiSelect"]}}</td></tr>
{{        pass}}
              <tr {{=setBold("morphPlacement")}}><td>Morph Placement</td><td>{{=seedParams["morphPlacement"]}}</td></tr>
{{    if seedParams["morphPlacement"] == "random":}}
              <tr><td>Morph Placement pool</td><td>{{=seedParams["morphPlacementMultiSelect"]}}</td></tr>
{{        pass}}
              <tr {{=setBold("suitsRestriction")}}><td>Suits restriction</td><td>{{=seedParams["suitsRestriction"]}}</td></tr>
              <tr {{=setBold("hideItems")}}><td>Hide some items</td><td>{{=seedParams["hideItems"]}}</td></tr>
            </table>

            <h4>Ammo and Energy</h4>
            <table class="full">
              <colgroup><col class="half" /><col class="half" /></colgroup>
              <tr {{=setBold("strictMinors")}}><td>Strict Minors distribution</td><td>{{=seedParams["strictMinors"]}}</td></tr>
              <tr {{=setBold("missileQty")}}><td>Proportion of Missiles</td><td>{{=seedParams["missileQty"]}}</td></tr>
              <tr {{=setBold("superQty")}}><td>Proportion of Super Missiles</td><td>{{=seedParams["superQty"]}}</td></tr>
              <tr {{=setBold("powerBombQty")}}><td>Proportion of Power Bombs</td><td>{{=seedParams["powerBombQty"]}}</td></tr>
              <tr {{=setBold("minorQty")}}><td>Percentage of minors available</td><td>{{=seedParams["minorQty"]}}</td></tr>
              <tr {{=setBold("energyQty")}}><td>Quantity of Energy/Reserve Tanks available</td><td>{{=seedParams["energyQty"]}}</td></tr>
{{    if seedParams["energyQty"] == "random":}}
              <tr><td>Quantity of Energy/Reserve pool</td><td>{{=seedParams["energyQtyMultiSelect"]}}</td></tr>
{{        pass}}
            </table>

            <h4>Objectives</h4>
            <table class="full">
              <colgroup><col class="half" /><col class="half" /></colgroup>
              <tr {{=setBold("objective")}}><td>Objectives to access Tourian</td>
{{    if seedParams["objectiveRandom"] == "true":}}
                <td>random</td></tr>
              <tr {{=setBold("nbObjective")}}><td>Number of Objectives</td><td>{{=seedParams["nbObjective"]}}</td></tr>
              <tr><td>Objectives pool</td><td>{{=seedParams["objectiveMultiSelect"]}}</td></tr>
{{    else:}}
                <td>{{=seedParams["objective"]}}</td></tr>
{{        pass}}
              <tr {{=setBold("nbObjectivesRequired")}}><td>Number of required objectives</td><td>{{=seedParams["nbObjectivesRequired"]}}</td></tr>
              <tr {{=setBold("hiddenObjectives")}}><td>Hidden objectives</td><td>{{=seedParams["hiddenObjectives"]}}</td></tr>
              <tr {{=setBold("tourian")}}><td>Tourian</td><td>{{=seedParams["tourian"]}}</td></tr>
{{    if seedParams["tourian"] == "random":}}
              <tr><td>Tourian pool</td><td>{{=seedParams["tourianMultiSelect"]}}</td></tr>
{{        pass}}
            </table>

            <h4>Areas/Doors/Bosses/Escape Randomization</h4>
            <table class="full">
              <colgroup><col class="half" /><col class="half" /></colgroup>
              <tr {{=setBold("areaRandomization")}}><td>Areas randomization</td><td>{{=seedParams["areaRandomization"]}}</td></tr>
{{    if seedParams["areaRandomization"] == "random":}}
              <!-- area wasn't a multiselect so there's still seeds in the db generated with area random but no multiselect -->
              <tr><td>Area Randomization pool</td><td>{{=seedParams.get("areaRandomizationMultiSelect", "off, full")}}</td></tr>
{{        pass}}

              <tr {{=setBold("areaLayout")}}><td>Additional layout patches for easier navigation</td><td>{{=seedParams["areaLayout"]}}</td></tr>
              <tr {{=setBold("doorsColorsRando")}}><td>Doors Colors randomization</td><td>{{=seedParams["doorsColorsRando"]}}</td></tr>
              <tr {{=setBold("allowGreyDoors")}}><td>Allow some doors to be grey</td><td>{{=seedParams["allowGreyDoors"]}}</td></tr>
              <tr {{=setBold("bossRandomization")}}><td>Bosses randomization</td><td>{{=seedParams["bossRandomization"]}}</td></tr>
              <tr {{=setBold("minimizer")}}><td>Bosses rush, aka Minimizer</td><td>{{=seedParams["minimizer"]}}</td></tr>
              <tr {{=setBold("minimizerQty")}}><td>Number of locations</td><td>{{=seedParams["minimizerQty"]}}</td></tr>
              <tr {{=setBold("escapeRando")}}><td>Randomize the escape sequence</td><td>{{=seedParams["escapeRando"]}}</td></tr>
              <tr {{=setBold("removeEscapeEnemies")}}><td>Remove enemies during randomized escape sequence</td><td>{{=seedParams["removeEscapeEnemies"]}}</td></tr>
            </table>

            <h4>Super Fun Times</h4>
            <table class="full">
              <colgroup><col class="half" /><col class="half" /></colgroup>
              <tr {{=setBold("funCombat")}}><td>Super Fun Combat</td><td>{{=seedParams["funCombat"]}}</td></tr>
              <tr {{=setBold("funMovement")}}><td>Super Fun Movement</td><td>{{=seedParams["funMovement"]}}</td></tr>
              <tr {{=setBold("funSuits")}}><td>Suitless</td><td>{{=seedParams["funSuits"]}}</td></tr>
            </table>

            <h4>Patches</h4>
            <table class="full">
              <colgroup><col class="half" /><col class="half" /></colgroup>
              <tr {{=setBold("layoutPatches")}}><td>Anti-softlock layout patches</td><td>{{=seedParams["layoutPatches"]}}</td></tr>
              <tr {{=setBold("variaTweaks")}}><td>VARIA tweaks</td><td>{{=seedParams["variaTweaks"]}}</td></tr>
              <tr {{=setBold("nerfedCharge")}}><td>Nerfed Charge Beam available from the start</td><td>{{=seedParams["nerfedCharge"]}}</td></tr>
              <tr {{=setBold("relaxed_round_robin_cf")}}><td>Relaxed Round Robin Crytal Flash</td><td>{{=seedParams["relaxed_round_robin_cf"]}}</td></tr>
              <tr {{=setBold("gravityBehaviour")}}><td>Suits properties</td><td>{{=seedParams["gravityBehaviour"]}}</td></tr>
{{    if seedParams["gravityBehaviour"] == "random":}}
              <tr><td>Suits properties pool</td><td>{{=seedParams["gravityBehaviourMultiSelect"]}}</td></tr>
{{        pass}}
              <tr {{=setBold("itemsounds")}}><td>Remove fanfare when picking up an item</td><td>{{=seedParams["itemsounds"]}}</td></tr>
              <tr {{=setBold("elevators_speed")}}><td>Accelerate elevators transitions</td><td>{{=seedParams["elevators_speed"]}}</td></tr>
              <tr {{=setBold("fast_doors")}}><td>Accelerate doors transitions</td><td>{{=seedParams["fast_doors"]}}</td></tr>
              <tr {{=setBold("spinjumprestart")}}><td>Spin jump restart (a.k.a. Respin)</td><td>{{=seedParams["spinjumprestart"]}}</td></tr>
              <tr {{=setBold("rando_speed")}}><td>Momentum conservation (a.k.a. Speedkeep)</td><td>{{=seedParams["rando_speed"]}}</td></tr>
              <tr {{=setBold("Infinite_Space_Jump")}}><td>Infinite Space Jump</td><td>{{=seedParams["Infinite_Space_Jump"]}}</td></tr>
              <tr {{=setBold("refill_before_save")}}><td>Refill before save</td><td>{{=seedParams["refill_before_save"]}}</td></tr>
              <tr {{=setBold("hud")}}><td>Display items count in the HUD</td><td>{{=seedParams["hud"]}}</td></tr>
              <tr {{=setBold("revealMap")}}><td>Reveal the whole map on start</td><td>{{=seedParams.get("revealMap", "off")}}</td></tr>
              <tr {{=setBold("animals")}}><td>Save the animals surprise</td><td>{{=seedParams["animals"]}}</td></tr>
              <tr {{=setBold("No_Music")}}><td>Disable background music</td><td>{{=seedParams["No_Music"]}}</td></tr>
              <tr {{=setBold("random_music")}}><td>Randomize background music</td><td>{{=seedParams["random_music"]}}</td></tr>
            </table>
{{
    pass
}}
          </div>
        </div>
        {{=INPUT(_type="submit", _value="customize", _id="submitBtn", _class="btn btn-default buttonRandom")}}
    </form>
  </div>
</body>
